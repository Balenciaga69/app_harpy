# Effect 模組

## 簡介

- 負責管理角色的效果系統，涵蓋靜態屬性效果、類別效果和堆疊效果。
- 支援效果的動態應用、移除和生命週期鉤子。
- 提供靈活的效果管理機制，適用於多種場景。
- 最後更新時間 ：2025-12-13。

## 輸入與輸出

### 主要輸入

- IEffectTemplateInfo ：效果模板資訊，用於建構效果實例。
- IEffect ：效果實例，包含應用和移除邏輯。

### 主要輸出

- IEffect[] ：建構後的效果實例列表。
- 效果管理操作 ：添加、移除、查詢和觸發效果。

## 元件盤點

- EffectManager ：效果管理器，處理效果的添加、移除和狀態觸發。
- EffectBuilder ：效果建構器，根據模板建構靜態或類別效果。
- ClassEffectRegistry ：類別效果註冊表，管理類別效果的建構函數。
- StaticEffectGenerator ：靜態效果生成器，根據模板生成屬性修飾效果。
- StackableEffect ：堆疊效果基類，支持效果層數管理。
- StaticAttributeEffect ：靜態屬性效果類，應用固定屬性修飾。
- 介面層 ：定義IEffect、IEffectServices等契約，確保元件間一致性。
- 錯誤處理 ：EffectBuilderError等，自訂錯誤類別。

## 模組依賴誰?或被誰依賴?

- Effect 模組依賴 attribute 模組的屬性修飾器和類型定義，以及 combat 模組的效果服務介面。
- Effect 模組被 combat 模組依賴，用於戰鬥效果應用，以及 item 模組依賴，用於裝備和遺物效果生成。

---

#### 這個模組在做什麼？

- 管理角色身上的所有效果（Effect），不論是單純的屬性加成，還是複雜的特殊狀態。
- 支援靜態效果（如 +50 攻擊力）、類別效果（如中毒、灼燒等有特殊邏輯的效果）、堆疊效果（可累積層數的 buff/debuff）。
- 提供效果的動態應用、移除、查詢與觸發（例如角色死亡、復活時自動清除或觸發某些效果）。
- 讓開發者可以很方便地擴充新的效果類型，並且統一管理所有效果的生命週期。

---

#### 運作流程

1. 效果建構
   - 你會拿到一組「效果模板資訊」（通常來自裝備、遺物、技能等），用 EffectBuilder 來產生對應的效果實例。
   - 靜態效果（如攻擊力加成）會自動轉成對應的屬性修飾器。
   - 類別效果（如中毒）則會從註冊表取得對應的建構函數，產生有特殊邏輯的效果實例。

2. 效果應用與移除
   - 用 EffectManager 把效果加到角色身上，會自動執行 onApply（例如加屬性、觸發動畫）。
   - 移除時會執行 onRemove（例如移除屬性、清除狀態）。

3. 效果查詢與觸發
   - 可以查詢角色目前有哪些效果、是否有某個效果。
   - 支援特殊事件觸發（如角色 HP 歸零時，所有效果都可以收到通知，做出反應）。

4. 堆疊與特殊邏輯
   - 支援堆疊效果（如中毒可疊加多層），每層效果可有不同強度。
   - 支援效果在特定時機自動清除（如復活時自動清除某些 debuff）。

---

#### 什麼時候會用到這個模組？

- 角色裝備新武器或遺物時：自動產生對應的屬性加成或特殊效果，加到角色身上。
- 角色受到技能影響時：如被敵人施加中毒、灼燒等狀態，這些效果會自動管理其生命週期與堆疊。
- 角色死亡或復活時：自動清除或觸發某些效果（如死亡時觸發爆炸、復活時清除 debuff）。
- 戰鬥每回合結束時：所有有 onTick 的效果（如持續傷害）會自動觸發。
- 查詢角色狀態時：可以查詢角色目前有哪些 buff/debuff，或是某個效果的詳細資訊。

---

#### 實際情境舉例

- 玩家撿到一把「+50 攻擊力」的劍，裝備後自動加上攻擊力效果，卸下時自動移除。
- 玩家中了「中毒」效果，每回合自動扣血，且可以堆疊多層，直到效果被解毒或回合結束。
- 玩家死亡時，所有「死亡時觸發」的效果會自動執行（如爆炸、掉落物品），然後清除所有不該保留的效果。
- 玩家復活時，自動清除所有「復活時應該消失」的 debuff，並觸發復活相關的效果。

---

#### 開發者常見操作

- 新增一種特殊效果時，只要實作對應的效果類別，並註冊到 ClassEffectRegistry。
- 需要查詢角色目前有哪些效果時，直接用 EffectManager 查詢。
- 需要在特定事件（如回合結束、HP 歸零）時觸發效果，呼叫 EffectManager 的對應方法即可。
