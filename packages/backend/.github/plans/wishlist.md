# 關卡生成與敵人生成需求清單 (Wishlist)

## 簡介

本文件從需求出發，列出關卡生成 (Encounter) 與敵人生成 (EnemyGenerator) 模組的功能需求。這些模組為獨立設計，Encounter 屬於後端遊戲模組，負責遊戲流程邏輯；EnemyGenerator 屬於後端純運算模組，專注於敵人實例生成。需求基於遊戲核心概念：RogueLite 風格，強調賭博與刺激，每個關卡為獨立遭遇戰。

## 關卡生成 (Encounter) 模組需求

### 核心功能需求

- **地圖結構生成**: 根據章節號生成 10 個遭遇節點的地圖，每 10 關為一章節。
- **Boss 節點配置**: 第 5 關為中型 Boss，第 10 關為大型 Boss。
- **路線分支系統**: 每戰勝利後提供 2 條可預覽的分支路線，每條分支包含 1~3 個事件節點。
- **事件節點多樣性**: 分支獎勵高度分化，包括金幣、物品、Buff、Debuff 等。
- **無盡模式支援**: 超過 30 關後進入無盡模式，難度持續提升。
- **節點資訊隱藏**: 敵人資訊完全未知，僅顯示威脅等級 (Threat Level)。

### 進階需求

- **隨機種子支援**: 確保地圖生成的可重現性，使用隨機種子控制生成。
- **章節進度追蹤**: 記錄當前章節、關卡層數和已完成節點。
- **路線選擇邏輯**: 支援玩家選擇分支路線，並更新遊戲狀態。
- **事件觸發機制**: 處理事件節點的獎勵發放和狀態變化。
- **檢查點支援**: 允許保存和載入關卡進度。

### 介面需求

- **地圖資料結構**: 定義 EncounterMap，包含節點列表、分支資訊。
- **節點定義**: EncounterNode，包含類型 (Combat/Boss/Event)、威脅等級、獎勵預覽。
- **事件處理**: 支援事件類型定義和處理器註冊。

## 敵人生成 (EnemyGenerator) 模組需求

### 核心功能需求

- **敵人實例生成**: 根據難度係數生成敵人角色實例，包含基礎屬性、裝備和遺物。
- **裝備遺物整合**: 敵人穿戴由難度係數影響的裝備和遺物，與玩家裝備系統一致。
- **多敵人支援**: 支援生成單個或多個敵人實例，形成敵人隊伍。
- **職業標籤支援**: 敵人可根據職業標籤生成，影響裝備池和屬性偏向。

### 進階需求

- **隨機種子支援**: 使用隨機種子確保敵人生成的確定性和可重現性。
- **難度調整**: 根據難度係數動態調整敵人屬性強度、裝備稀有度和遺物數量。
- **敵人模板系統**: 支援預定義敵人模板，包含基礎屬性和生成規則。
- **屬性平衡**: 確保生成的敵人屬性符合遊戲平衡，考慮玩家等級和進度。
- **多樣性控制**: 避免重複生成，提供多樣化的敵人組合。

### 介面需求

- **敵人定義**: EnemyDefinition，包含職業、屬性範圍、裝備池。
- **生成配置**: EnemyGenerationConfig，包含難度係數、隨機種子、敵人數量。
- **輸出結構**: EnemyInstance，包含生成的角色實例和裝備遺物。

## 共同依賴與整合需求

### 依賴關係

- **DifficultyScaler**: 兩個模組都依賴難度係數計算，用於調整生成參數。
- **ItemGenerator**: EnemyGenerator 依賴物品生成器來生成裝備和遺物。
- **Character**: EnemyGenerator 依賴角色系統來實例化敵人角色。
- **Run 模組**: Encounter 整合到 Run 模組中，作為遊戲流程的一部分。

### 整合需求

- **事件驅動**: 支援 EventBus 整合，發射生成相關事件。
- **錯誤處理**: 提供結構化錯誤處理，處理生成失敗情況。
- **效能考量**: 生成邏輯應高效，避免阻塞遊戲流程。
- **測試友好**: 支援模擬和測試環境下的生成邏輯。

## 優先級與開發順序

### 高優先級 (核心功能)

1. Encounter: 基本地圖生成和節點結構。
2. EnemyGenerator: 基礎敵人實例生成，包含屬性和裝備。
3. 整合測試: 確保兩個模組能協同工作。

### 中優先級 (進階功能)

1. Encounter: 分支路線和事件系統。
2. EnemyGenerator: 難度調整和多樣性控制。
3. 隨機種子支援和可重現性。

### 低優先級 (優化與擴充)

1. 無盡模式支援。
2. 進階事件類型和獎勵系統。
3. 效能優化和快取機制。

## 開發者碎碎念

- 這些模組是遊戲核心，需確保生成邏輯的平衡性和可玩性。
- 隨機種子對於重播和測試至關重要，需從設計階段就考慮。
- 與前端整合時，需注意資料傳輸效率，避免過大 payload。
- 建議先實現最小可行版本，然後根據測試反饋迭代。

## 商店 (Shop) 模組需求 - 此指的是賭博

### 核心功能需求

- **拉霸機賭博系統**: 提供賭博功能，包含最低注額、倍率計算和結果結算。

### 進階需求

- **賭博風險控制**: 賭博結果基於隨機種子，支援不同賭博類型（如固定倍率、隨機倍率）。
- **經濟平衡**: 確保賭博期望值控制。

### 介面需求

- **賭博配置**: GamblingConfig，包含注額範圍、倍率表、隨機種子。

## 戰鬥前準備 (PreCombat) 模組需求

### 核心功能需求

- **賽前變數注入**: 進入戰鬥前注入 1~n 個隨機變數，影響雙方屬性（如開局異常狀態、屬性加成）。
- **賽前博弈系統**: 玩家下注勝利時剩餘血量區間，支援多個區間（1-10%、11-30%、31-60%、61-100%）和對應倍率（8x、4x、2x、1.2x）。
- **下注邏輯**: 賭金為玩家總資產百分比，猜中獲得倍率獎勵，猜錯僅得基礎獎勵並沒收賭金。
- **變數 reroll**: 玩家可花費金幣重新滾動賽前變數（費用較高）。

### 進階需求

- **變數多樣性**: 支援多種類型變數，如異常狀態應用、屬性修飾、復活率調整、大招充能效率等。
- **博弈平衡**: 確保下注系統公平，倍率基於概率計算，鼓勵玩家參與但不強制。
- **隨機種子支援**: 變數和博弈結果使用隨機種子，確保可重現性。
- **狀態預覽**: 允許玩家預覽變數效果和下注區間，支援取消或確認。
- **整合檢查**: 確保變數和博弈不與其他系統衝突，支援戰鬥重播。

### 介面需求

- **賽前變數**: PreCombatVariable，包含效果描述、應用邏輯、持續時間。
- **博弈配置**: CombatBettingConfig，包含區間定義、倍率表、賭金計算。
- **準備狀態**: PreCombatState，包含注入變數列表、下注資訊、確認狀態。

## 庫存系統 (Inventory) 模組需求

### 核心功能需求

- **倉庫管理**: 支援無數量限制的倉庫，儲存裝備和遺物實例。
- **裝備槽位管理**: 處理角色裝備槽位（武器、頭盔、裝甲等），支援穿戴和卸下操作。
- **遺物堆疊**: 支援遺物無限堆疊，穿戴時應用效果，卸下時移除。
- **數據變更處理**: 處理購買、出售、穿戴/卸下等操作，更新角色和倉庫狀態。
- **事件發射**: 操作後發射事件，通知其他模組（如 UI 更新屬性面板）。

### 進階需求

- **裝備驗證**: 確保裝備槽位唯一性，避免重複穿戴。
- **遺物排序**: 支援遺物按類型或效果排序，便於管理。
- **數據持久化**: 整合 PersistentStorage，支援倉庫和裝備狀態的保存/載入。
- **效能優化**: 對於大量遺物，提供查詢和過濾機制。
- **錯誤處理**: 處理無效操作（如槽位衝突），提供結構化錯誤。

### 介面需求

- **倉庫介面**: Inventory，包含裝備列表、遺物列表、操作方法。
- **裝備槽位**: EquipmentSlots，定義槽位類型和當前裝備。
- **操作結果**: InventoryOperationResult，包含成功/失敗狀態和更新資料。

## 角色管理 (CharacterManager) 模組需求

### 核心功能需求

- **角色實例儲存**: 管理玩家的角色實例，包含基礎屬性和當前狀態。
- **角色選擇**: 支援從定義列表選擇角色，初始化實例並應用職業修飾器。
- **面板展示**: 整合 Character-Sheet，計算並提供完整屬性面板（包含裝備和遺物效果）。
- **實例更新**: 處理角色狀態變更，如屬性調整、裝備更換。

### 進階需求

- **多角色支援**: 允許儲存多個角色實例，支援切換（雖遊戲單角色，但擴充性）。
- **屬性驗證**: 確保角色屬性符合定義範圍，避免無效狀態。
- **事件整合**: 發射角色選擇或更新事件，通知 Run 或 UI。
- **數據持久化**: 整合 PersistentStorage，支援角色實例的保存/載入。
- **錯誤處理**: 處理選擇失敗或實例損壞，提供結構化錯誤。

### 介面需求

- **角色管理器**: CharacterManager，包含實例列表、選擇方法、面板計算。
- **角色實例**: CharacterInstance，包含定義ID、當前屬性、裝備狀態。
- **面板資料**: CharacterPanel，包含計算後屬性、裝備列表、遺物列表。

## 共同依賴與整合需求

### 依賴關係

- **DifficultyScaler**: 所有生成模組都依賴難度係數計算，用於調整生成參數。
- **ItemGenerator**: EnemyGenerator 和 Shop 依賴物品生成器來生成裝備、遺物和商品。
- **Character**: EnemyGenerator 依賴角色系統來實例化敵人角色。
- **Inventory**: Shop 依賴倉庫系統來處理購買和出售邏輯。
- **Combat**: PreCombat 依賴戰鬥系統來應用變數和處理博弈結果。
- **Character-Sheet**: CharacterManager 和 Inventory 依賴角色表來計算屬性面板。
- **Run 模組**: Encounter、Shop 和 PreCombat 整合到 Run 模組中，作為遊戲流程的一部分。

### 整合需求

- **事件驅動**: 支援 EventBus 整合，發射生成相關事件。
- **錯誤處理**: 提供結構化錯誤處理，處理生成失敗情況。
- **效能考量**: 生成邏輯應高效，避免阻塞遊戲流程。
- **測試友好**: 支援模擬和測試環境下的生成邏輯。

## 優先級與開發順序

### 高優先級 (核心功能)

1. Encounter: 基本地圖生成和節點結構。
2. EnemyGenerator: 基礎敵人實例生成，包含屬性和裝備。
3. Shop: 基本商店刷新、購買和出售邏輯。
4. PreCombat: 賽前變數注入和博弈系統。
5. Inventory: 倉庫管理和裝備槽位操作。
6. CharacterManager: 角色實例儲存和選擇邏輯。
7. 整合測試: 確保所有模組能協同工作。

### 中優先級 (進階功能)

1. Encounter: 分支路線和事件系統。
2. EnemyGenerator: 難度調整和多樣性控制。
3. Shop: 拉霸機賭博和動態定價。
4. PreCombat: 變數 reroll 和狀態預覽。
5. Inventory: 遺物堆疊和數據持久化。
6. CharacterManager: 多角色支援和屬性驗證。
7. 隨機種子支援和可重現性。

### 低優先級 (優化與擴充)

1. 無盡模式支援。
2. 進階事件類型和獎勵系統。
3. Shop: 通膨機制和經濟平衡優化。
4. PreCombat: 進階變數類型和博弈多樣性。
5. Inventory: 效能優化和查詢機制。
6. CharacterManager: 事件整合和擴充面板。
7. 效能優化和快取機制。

## 開發者碎碎念

- 這些模組是遊戲核心，需確保生成邏輯的平衡性和可玩性。
- Shop 和 PreCombat 強調賭博元素，需仔細設計經濟和風險系統，避免玩家挫敗。
- 隨機種子對於重播和測試至關重要，需從設計階段就考慮。
- 與前端整合時，需注意資料傳輸效率，避免過大 payload。
- PreCombat 的變數和博弈應支援重播，確保戰鬥結果的可預測性。
- Inventory 和 CharacterManager 補全了角色和物品管理，需與 Character 和 Character-Sheet 整合，避免重複邏輯。
- 建議先實現最小可行版本，然後根據測試反饋迭代。
