---
applyTo: '/*.ts, /*.md'
---

# 技術架構與實現細節 - 2025/12/14

## 簡單來說

- 這是一個不斷修改 Context 狀態的邏輯處理器 - 輸入舊 Context, 應用業務規則, 輸出新 Context (Context 驅動的設計)
- 代碼是無狀態的, 代表著不同 Server Instance 間可以無痛切換, 不會有使用者必須綁定在某一台 Server Instance 上的問題
- 代碼是可水平擴展的, 代表著可以輕易增加更多 Server Instance 來應付高流量
- 這專案功能繁多, 但不該有狀態保留在服務端的情況, 同時代表服務不該存東西在本地端記憶體或檔案系統
- 要注意玩家可能會多裝置或多瀏覽器登入同一帳號 (我們只允許一個紀錄事實), 因此所有狀態都必須存放在後端資料庫中, 保證唯一真相

## 系統架構分層

### 前端分層

- UI 層: 負責純顯示與用戶互動界面, 例如按鈕、畫面渲染、動畫效果 - 不涉及業務邏輯
- 邏輯層: 處理前端業務規則與狀態管理, 例如玩家操作驗證、遊戲狀態計算、事件處理 - 與UI層分離, 便於重用
- Fetch API 層: 統一處理數據請求與回應, 無論開發階段 (本地模擬) 或上線階段 (真API調用) - 封裝網路邏輯, 邏輯層透過此層獲取數據

### 後端分層

- API 層: 處理外部請求驗證、路由與中介邏輯, 例如用戶登入、請求解析、錯誤處理 - 作為入口, 呼叫遊戲核心層
- 遊戲核心層: 專注處理遊戲邏輯與計算, 不關心數據來源 (API或直接調用) 或儲存方式 (Memory或DB) - 接收 Context, 執行 RUN、戰鬥、商店等操作, 返回結果

## 核心系統盤點

### 後端遊戲機制核心:

#### 辭典, 最基礎的概念群

- 職業
- 屬性
- 異常狀態
- 絕招
- 詞綴
- 物品
  - 裝備
  - 遺物
- 關卡
  - 戰鬥關卡
  - 事件關卡
- 實體
  - 模板敵人
  - 角色
  - 召喚物
  - 戰鬥單位
- 難度

### 內容生成與數據管理系統

- 生成系統
  - 物品生成
  - 詞綴生成
  - 敵人生成
  - 關卡生成
- 關卡節點生成
- 敵人配置生成
- 事件配置生成
- 原型轉實例系統
  - 物品原型轉物品實例
  - 詞綴原型轉詞綴實例
  - 敵人原型轉敵人實例
- 池系統
  - 物品池
  - 敵人池
  - 事件池
- 屬性聚合系統
- 金幣系統
- 戰鬥運算系統

### 高階功能模組

- 戰鬥系統
  - 回合與階段系統
  - 牌型計算系統
  - 傷害計算系統
  - 戰局全域系統
  - ECS.js
- RUN 系統
- 商店系統
- 戰鬥前後事務系統
  - 下注遊戲
  - 賽前變數系統
  - 賽後獎勵與生成系統
- 賭博系統
- 倉庫系統
- 角色管理系統
- 商店交易系統

### 前端遊戲核心:

- 角色與裝備面板
- 戰鬥重播系統
- 商店與賭博介面
- 倉庫介面
- RUN 進程介面
- 戰鬥前下注與賽前變數介面
- 戰鬥後獎勵選擇介面

### 後端業務核心:

- 儲存系統(RUN 狀態, 使用者資料)
- 使用者系統(註冊, 登入, 權限)
- 玩家系統(連結玩家帳戶)
  - 成就系統
  - 統計系統
  - 解鎖可用物系統

## 儲存系統設計

- 將整個 Run 的 Context 拆分成多個子 JSON 欄位 (如角色屬性 JSON, 倉庫 JSON, 商店 JSON, 路線分支 JSON 等), 然後將這些欄位存入 NoSQL 資料庫 (遊戲核心 NoSQL) 每個 Run 對應一筆記錄, 多欄位允許精準更新與查詢
  - 優點: 小操作 (如商店購買)只需讀取/更新相關欄位 (如倉庫 JSON), 減少 IO 負擔, 提升效能
  - 優點: 支援索引查詢 (如金幣欄位), 易於找出當前金幣超過三十萬的 RUN, 適合統計與分析
  - 缺點: 欄位間一致性需額外處理 (如交易確保多欄位同步), 設計複雜度增加
- RDB 用於儲存需要高度一致性, 交易性, 以及明確關聯性的資料, 例如帳號資訊, 金錢餘額, 成就進度等 (後端業務核心)
- 所有遊戲狀態, 包括角色的配置與實例, 只會在特定的生命週期內(例如一個請求)存在於伺服器的記憶體中
- 儲存系統(不管 Redis, Pg, Mongo)扮演了遊戲世界的唯一真相

版本號與並發控制詳見 context.md 的版本號與樂觀鎖章節

### 上下文分類

絕不存實體, 只存 Template 與狀態, 讓實際代碼去還原成物件

- 角色資訊 (Character Context)
- 倉庫 (Stash Context)
- 商店狀態 (Shop Context)
- 戰鬥前事務 (Pre-battle Context)
- 戰鬥後事務 (Post-battle Context)
- 關卡進程 (Stage Progress Context)
- 敵人資訊 (Enemy Context)

### 本專案需知

#### 開發範圍

- 我們目前開發討論的所有範圍都是在遊戲邏輯層

#### 外部層次內容

- 關於 APIs (RESTful or GraphQL), 驗證, NoSQL or RDB, Redis 都是更外部層次的內容

#### 假定與目標

- 需要假定這個專案目前不在乎自己是被 RESTful or GraphQL 甚至是被當成函式庫被前端直接調用的方法
- 目標就是作為一個無狀態的函數群體提供服務最重要

#### 運作前提

- 該專案內容都是在已經確保使用者正確, Run 已驗證的前提下運作的；驗證阻攔等等職責不再該專案負責
- 本專案 (遊戲邏輯層) 甚至不會意識到自己是個需要帳戶的線上遊戲

#### 討論焦點

- 我們討論的內容 95% 以上都是一場單機 Run 之內發生的事情
