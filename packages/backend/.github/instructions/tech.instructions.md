# 技術架構與實現細節 - 2025/12/14

## 系統架構分層

### 前端分層

- **UI 層**：負責純顯示與用戶互動界面，例如按鈕、畫面渲染、動畫效果。不涉及業務邏輯。
- **邏輯層**：處理前端業務規則與狀態管理，例如玩家操作驗證、遊戲狀態計算、事件處理。與UI層分離，便於重用。
- **Fetch API 層**：統一處理數據請求與回應，無論開發階段（本地模擬）或上線階段（真API調用）。封裝網路邏輯，邏輯層透過此層獲取數據。

### 後端分層

- **API 層**：處理外部請求驗證、路由與中介邏輯，例如用戶登入、請求解析、錯誤處理。作為入口，呼叫遊戲核心層。
- **遊戲核心層**：專注處理遊戲邏輯與計算，不關心數據來源（API或直接調用）或儲存方式（Memory或DB）。接收上下文，執行RUN、戰鬥、商店等操作，返回結果。

## 核心系統盤點

### 後端遊戲核心(你現在再處理的東西):

- RUN
- 關卡生成
- 敵人生成(也是角色的一種)
  - 實體模板
  - 動態變化
- 角色
- 職業
- 屬性
- 物品
  - 詞綴
  - 裝備
  - 裝備生成
  - 遺物與生成
- 戰鬥
  - 戰鬥的效果
  - 狀態
  - 聖火、中毒、充能、冰緩等異常狀態
- 大絕招或技能
- 戰鬥前事務
  - 下注
  - 賽前變數生成
- 戰鬥後事務
  - 獎勵事件派發與生成
  - 獎勵選擇與執行
- 難度係數系統
- 商店
- 賭博
- 倉庫

### 前端遊戲核心:

- 角色與裝備面板
- 戰鬥重播系統
- 商店與賭博介面
- 倉庫介面
- RUN 進程介面
- 戰鬥前下注與賽前變數介面
- 戰鬥後獎勵選擇介面

### 後端業務核心:

- 使用者系統(註冊、登入、權限)
- 儲存系統(RUN 狀態、使用者資料)
- 成就系統
- 統計系統

## 儲存系統設計

- 將整個 Run 的所有上下文（角色、所有裝備遺物、倉庫、當前商店、路線分支）序列化成一個完整的 JSON/文件，然後將這個文件作為一個欄位存入資料庫(遊戲核心 NoSQL)
  - 缺點: 如果玩家只是在商店購買了一個小東西（例如，只改變了倉庫中的一項物品），您仍然需要讀取整個大 JSON 文件
  - 缺點: 找出當前金幣超過三十萬的 RUN，難以直接查詢。
- RDB 用於儲存需要高度一致性、交易性、以及明確關聯性的資料，例如帳號資訊、金錢餘額、成就進度等。(後端業務核心)
- 所有遊戲狀態，包括角色的配置與實例，只會在特定的生命週期內(例如一個請求)存在於伺服器的記憶體中。
- 儲存系統(不管 Redis,Pg,Mongo)扮演了遊戲世界的唯一真相
