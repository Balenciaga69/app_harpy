# Combat 模組

## 簡介

- Combat 模組負責完整的戰鬥系統，包括：
  - 角色初始化
  - tick 驅動的戰鬥循環
  - 傷害計算
  - 效果處理
  - 結果統計
- 支援事件驅動架構和可擴展的鉤子系統，提供可重現的隨機戰鬥。
- 核心重點包括：
  - 事件驅動架構：使用 EventBus 作為中央事件匯流排，所有戰鬥事件通過事件發射和監聽。
  - tick 驅動的戰鬥循環：以固定 tick 為單位推進，每個 tick 分為效果 tick、能量恢復、攻擊執行等階段。
  - 角色系統：整合屬性、效果和終極技能。
  - 傷害計算系統：鏈式計算包括命中、暴擊、防禦。
  - 效果和技能系統：處理效果生命週期和終極技能。
  - 資源和上下文管理：提供事件匯流排、隨機生成器和資源註冊表。
  - 統計和結果：快照收集和統計建構。
  - 錯誤處理和失敗管理：結構化錯誤處理。
- 最後更新時間：2025-12-13。

## 輸入與輸出

### 主要輸入

- CombatConfig：包含玩家隊伍、敵人隊伍、隨機種子、最大tick數等配置。支援可選的預匹配效果和快照間隔設定。

### 主要輸出

- CombatResult：包含戰鬥結果（勝負、超時等）、倖存者、總tick數、日誌（事件記錄）、快照（定期狀態捕獲）和統計資料（角色統計、效果應用次數等）。

## 元件盤點

- CombatEngine：戰鬥引擎，協調所有子系統執行戰鬥。初始化系統、設定停止條件、執行戰鬥並建構結果。
- Character：角色實體，整合屬性（AttributeManager）、效果（EffectManager）和終極技能（UltimateManager）。支援屬性修飾器、效果應用移除和復活機制。
- DamageChain：傷害鏈，處理傷害計算的各個步驟（命中檢查、暴擊計算、傷害修改、防禦計算、應用）。每個步驟可擴展和自訂。
- EffectManager：效果管理器，處理角色的效果應用、移除和tick處理。支援靜態屬性效果和類別效果。
- TickActionSystem：tick動作系統，管理每個tick的階段執行。支援動態添加、替換和移除階段。
- CombatContext：戰鬥上下文，提供事件匯流排、隨機生成器和資源註冊表。作為戰鬥的中央上下文。
- EventBus：事件匯流排，處理戰鬥相關事件的發射和監聽。支援鉤子系統，允許效果介入關鍵時刻。
- DamageStep：傷害步驟類別，實現傷害計算的各個階段（如HitCheckStep、CriticalStep）。每個步驟都是獨立的IDamageStep。
- UltimateManager：終極技能管理器，處理角色的終極技能設定和執行。支援延遲初始化。
- TargetSelector：目標選擇器，定義攻擊目標的選擇邏輯（如FirstAliveSelector、LowestHealthSelector）。
- TickerDriver：ticker驅動器，控制戰鬥的tick循環。支援停止條件和超時檢查。
- SnapshotCollector：快照收集器，定期捕獲戰鬥狀態。根據間隔設定自動收集。
- StatisticsBuilder：統計建構器，計算戰鬥統計資料。包括傷害輸出、暴擊次數等。
- 介面層：定義ICombatContext、ICharacter、ICombatHook等契約，確保元件間一致性。支援擴展性和測試友好。
- 錯誤處理：CombatError、CombatFailure等，自訂錯誤類別。提供結構化錯誤處理和Result類型安全。

## 內部戰鬥系統由以下構成

- 事件驅動系統：負責戰鬥事件的發射、監聽和鉤子介入。
- tick 驅動循環系統：控制戰鬥節奏和階段執行。
- 角色管理系統：處理角色屬性、效果和技能。
- 傷害計算系統：鏈式處理傷害邏輯。
- 效果系統：管理效果的生命週期。
- 資源註冊系統：管理角色和資源。
- 統計和日誌系統：記錄和分析戰鬥資料。
- 錯誤處理系統：提供結構化的錯誤管理。

## 模組依賴誰?或被誰依賴?

- 依賴的模組：
  - `attribute` 模組：提供屬性計算和修飾器。
  - `effect` 模組：處理效果應用和鉤子。
  - `item` 模組：管理角色裝備的物品實例。
  - `shared` 模組：提供通用介面（事件和實體）。

- 被依賴的模組：
  - `replay` 模組：生成戰鬥結果以進行重播。
  - `UI` 模組：顯示戰鬥過程和統計。
