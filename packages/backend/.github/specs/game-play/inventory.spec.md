# Inventory 模組規格說明

## 作者的話

- 已完成基礎實作，包含所有核心功能
- 尚未整合 PersistentStorage 模組（待該模組完成後整合）

## 簡介

- 管理玩家倉庫、裝備槽位與遺物，負責裝備穿戴、卸下、新增、移除等操作
- 支援無限倉庫容量、遺物堆疊機制、裝備唯一槽位約束
- 透過 EventBus 與其他模組通訊，發射庫存變更事件
- 最後更新時間：2025-12-14

## 輸入與輸出

### 主要輸入

- 裝備/遺物實例 （新增、 穿戴、 卸下、 出售等操作的目標）
- 操作指令 （如穿戴、 卸下、 排序、 查詢等）
- 持久化資料 （載入/儲存倉庫與裝備狀態）

### 主要輸出

- 當前倉庫內容 （裝備、 遺物清單）
- 當前裝備槽位狀態
- 操作結果 （InventoryOperationResult，包含成功/失敗與更新後資料）
- 事件通知 （如屬性面板需更新）

## 元件盤點

### Interfaces 層

- IInventory：倉庫管理介面，定義所有庫存操作方法
- IEquipmentSlots：裝備槽位管理介面，定義槽位操作方法
- IInventoryOperationResult：操作結果結構，包含成功狀態、錯誤訊息與回傳資料
- IInventoryEvents：事件定義，包含所有庫存相關事件類型

### Domain 層

- InventoryError：庫存模組基礎錯誤類別
- EquipmentSlotError：裝備槽位相關錯誤
- ItemNotFoundError：物品未找到錯誤
- InvalidOperationError：無效操作錯誤
- InventoryConstants：常數定義，包含訊息模板與容量限制

### App 層

- InventoryManager：倉庫管理器實作，負責裝備與遺物的存取、查詢與事件發射
- EquipmentSlots：裝備槽位管理器實作，確保每類裝備唯一且正確穿戴卸下

## 模組依賴誰或被誰依賴

### 依賴模組

- features/item：使用 IEquipmentInstance、IRelicInstance、EquipmentSlot 等類型定義
- shared/event-bus：使用 IEventBus 進行事件通訊
- PersistentStorage：尚未整合，未來用於數據持久化

### 被依賴模組

- Shop：購買出售時操作倉庫
- CharacterManager：角色裝備管理與屬性計算
- Run：遊戲進程中的物品獲取與管理
- UI：顯示倉庫與裝備狀態

## 已實作功能

### 倉庫管理

- 新增裝備與遺物到倉庫
- 從倉庫移除裝備與遺物
- 根據 ID 查詢裝備與遺物
- 取得所有倉庫內容
- 無容量限制

### 裝備槽位管理

- 穿戴裝備到對應槽位
- 卸下裝備回倉庫
- 穿戴新裝備時自動卸下舊裝備並放回倉庫
- 檢查槽位狀態
- 清空所有槽位

### 遺物堆疊機制

- 支援遺物堆疊數量管理
- 部分移除時減少堆疊數量
- 完全移除時清除遺物

### 事件系統

- 裝備遺物新增移除事件
- 裝備穿戴卸下事件
- 槽位狀態變更事件
- 與其他模組解耦通訊

## 待實作功能

- PersistentStorage 整合
- 進階查詢與過濾機制
- 排序功能
- 批量操作優化

## 開發者的碎碎念

- 倉庫與裝備操作需高效且安全，避免資料競爭與狀態錯亂。
- 事件通知要即時，確保屬性面板與 UI 能正確反映最新狀態。
- 初期可先實作最小可行版本，後續再優化查詢與排序效能。
- 持久化與錯誤處理要完善，避免玩家資料遺失或異常。
