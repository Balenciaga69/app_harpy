# Run 模組

(目前暫時作為單機游戲的控制器 之後這會變成無狀態的產物)

## 簡介

- 模組職責: 負責遊戲運行的整體管理，包括狀態轉換、協調器整合和運行生命週期。
- 功能支援: 提供新運行創建、檢查點保存和狀態機驅動的遊戲流程。
- 最後更新時間: 2025-12-13。

## 輸入與輸出

### 主要輸入

- 運行操作 ：新運行開始、檢查點載入、角色選擇、狀態轉換等。
- 遊戲事件 ：金幣操作、節點推進等。

### 主要輸出

- 運行狀態 ：當前狀態、進度、上下文資訊。
- 操作結果 ：成功/失敗狀態和相關資料。

## 元件盤點

- RunOrchestrator ：運行協調器，整合所有子系統並提供統一API。
- RunStateMachine ：運行狀態機，管理狀態轉換和處理器調用。
- CharacterCoordinator ：角色協調器，處理角色選擇和統計。
- EncounterCoordinator ：遭遇協調器，生成地圖和處理節點。
- CombatCoordinator ：戰鬥協調器，執行戰鬥邏輯。
- ShopCoordinator ：商店協調器，處理商店操作。
- StorageCoordinator ：存儲協調器，管理檢查點保存和載入。
- RunInitializer ：運行初始化器，創建新運行或從檢查點恢復。
- RunFinalizer ：運行終結器，處理運行結束邏輯。
- State handlers ：各狀態處理器（如CharacterSelectionState、CombatState等），實現狀態特定邏輯。
- 介面層 ：定義RunContext、RunProgress等契約，確保元件間一致性。
- 錯誤處理 ：RunError等，自訂錯誤類別。

## 系統組成

Run 模組由多個獨立系統組成一套完整的遊戲運行系統 ：

- 狀態機系統 ：負責遊戲狀態轉換和狀態處理器的調用，確保遊戲流程的邏輯順序。
- 協調器系統 ：包括角色、遭遇、戰鬥、商店和存儲協調器，分別處理特定領域的邏輯整合。
- 生命週期系統 ：負責運行的初始化、恢復和終結，管理運行上下文的創建和銷毀。
- 上下文管理系統 ：維護運行狀態、進度和資源，提供統一的運行資料存取。
- 事件處理系統 ：處理狀態進入/退出事件和轉換驗證。
- 存儲系統 ：處理檢查點的保存和載入，支援遊戲進度的持久化。
- 錯誤處理系統 ：提供結構化的運行錯誤管理和異常處理。

## 模組依賴誰?或被誰依賴?

- 依賴的模組:
  - combat 模組: 提供戰鬥執行邏輯。
  - shop 模組: 處理商店操作。
  - character 模組: 管理角色相關邏輯。
  - shared 模組: 提供通用介面和契約。

- 被依賴的模組:
  - UI 模組: 用於遊戲運行控制。
  - gameplay 模組: 整合整體遊戲邏輯。
