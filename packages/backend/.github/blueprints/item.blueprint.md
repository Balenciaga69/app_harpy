## Item

### 物品與詞綴系統概述

- 物品系統體系龐大，分類繁多
  - 可能有八套以上主題拆分系統（暫時粗略劃分）
- 物品相關內容
  - 掉落池
  - 原型（Template）
  - 實例（Instance）
  - 生成流程
- 詞綴相關內容
  - 掉落池
  - 定義
  - 實例
  - 生成流程

---

### 物品原型（Item Template）

- 定義物品在被創造之前的靜態數據和行為規則
  - 名稱
  - 類型
  - 稀有度
  - 裝備槽位
  - 是否可以被堆疊
  - 可能的詞綴
  - 獨特傳奇效果的具體邏輯
- 最大工作量會出現在設定檔
  - 一個 JSON 物件定義了該物品的所有靜態屬性和詞綴列表

---

### 物品實例（Item Instance）

- 真正被放在倉庫、裝備身上的物品
- ItemInstance 會被序列化存入存檔系統
  - 下次使用再返序列化回來

---

### 物品生成系統

#### 實例化系統

- 負責解析和執行數據定義的規則
- 僅處理靜態數據與動態邏輯的分離

#### 詞綴生成（詞綴 Instance 系統）

- 包含骰出詞綴的流程
- 基礎範本定義、詞綴池定義

#### 生成流程步驟

1. 藍圖載入與實例創建
2. 數值滾動
3. 處理特殊行為模組
   - 詞綴不會直接影響單純的屬性數值
   - 詞綴會影響戰鬥事件的處理邏輯

---

### 戰鬥時或被裝備時的行為

#### 系統運作

- 兩套系統同時運作
  - 事件監聽不同時機點
  - 屬性聚合

#### 特殊觸發行為

- 戰鬥系統中預先設置監聽器
  - 當特定事件發生時，監聽器通知物品實例執行特殊效果邏輯

#### 屬性聚合系統

- 玩家裝備物品後
  - 屬性聚合系統提取裝備上的詞綴
  - 轉化為可被帶入戰鬥或面板顯示的數值

---

### 物品的兩種身分

- 在倉庫或商店內
  - 作為數據容器（被動的數據表現）
- 在戰鬥中
  - 作為詞綴的擁有者
  - 提取每個詞綴的功用，真正運用在戰鬥上

---

### 物品的 meta data

- 除了數值效果以外，所有其他影響物品行為、視覺和規則的靜態信息
  - 基礎型：名稱、外觀
  - 規則型：是否可堆疊、是否可賣掉
  - 用於生成型：詞綴池、詞綴數量

---

### 數據快取與同步

- 假設有使用 Redis
  - 為避免每次操作都查詢緩慢的資料庫
    - 系統將玩家完整角色數據包存放在快取中
    - 當玩家裝備發生變化時
      - 先更新記憶體中的實例
      - 再更新快取
      - 最後擇機將更新寫入資料庫

---

## 詞綴（Affix/Modifier）

### 詞綴是什麼？

- Modifier
  - 戰鬥中或需要運算時的修飾符
- Affix
  - 藍圖上設定好的詞綴
  - 一個 Affix 可能衍生多個 Modifiers（如同時補 HP 又加暴擊）

---

### 詞綴結構

- 每個詞綴都是獨立的數據結構
  - 不論存在於物品範本或物品實例中
- 結構內容包含：
  - 影響的屬性
  - 運算方式（Added, Multi, More）
  - Rolled 後的 Value
  - 生效條件（如低於 50% 魔力）
  - TAGs
  - 生成限制（如等級、關卡門檻等）

---

### 詞綴表（Affix Table）

- 定義單一詞綴的所有靜態屬性
  - ID
  - Tags
  - MinMaxRange
  - CalcType（加乘）
  - TargetStat（如生命、攻擊速度等）
  - 其他屬性

---

### 詞綴池表（Affix Pool Table）

- 定義哪些詞綴出現的概率
  - 詞綴 ID
  - 抽中 weight
  - 哪個物品可以抽到該 affix（ItemTemplate）

---

### 詞綴生成流程

1. 從詞綴池中撈出符合條件的 Affixes
2. 檢查排他（Exclusion Group）
   - 防止已經有攻擊速度又再加上攻擊速度
3. 根據 Weight 抽出並 Roll
4. 將詞綴塞到 Item Instance 上
