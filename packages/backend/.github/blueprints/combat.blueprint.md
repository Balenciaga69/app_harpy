# Combat 戰鬥系統

---

## 系統總覽

- 設計基礎
  - 採用 Tick 輪作設計
  - 所有戰鬥邏輯於伺服器單一主執行緒同步執行
- 事件處理順序
  - 嚴格定義每個 Tick 下事件的處理順序
  - 每個行為於同 Tick 轉換為 Event 物件，進入 Queue 排隊
  - 程式碼總是從上到下，依照預定階段順序執行

---

## Tick 處理流程

### 1. 行為轉換階段

- 將所有行動（如攻擊、放技能等）轉換成 Event 物件
- 將 Event 物件塞入事件 Queue

### 2. 事件處理階段

- 按順序同步處理 Queue 內所有事件
  - 傷害計算
  - 命中判定
  - 即時 HP/MP 扣除
  - 其他瞬發戰鬥事件
- Tick-based 自動戰鬥
  - 玩家僅戰前配置
  - 後端瞬間運算完畢
  - 前端呈現為可控重播（可繼續、暫停、1x~3x 變速，由 UI 負責）
- 玩家與敵人依冷卻時間自動行動
  - 附加隨機延遲
- 戰鬥結果於載入時即決定，過程不可干預
- 傷害流程
  - BeforeDamage
  - HitCheck
  - Critical
  - DamageModify
  - Defense
  - BeforeApply
  - Apply
  - AfterApply
- 支援目標選擇策略
  - 攻擊第一位
  - 血最少
  - 血最多
  - 其他策略
- 重點行動皆進入日誌隊列供重播

### 3. 狀態系統處理階段

- 處理所有 Buff、Debuff、回血、回魔等狀態
- 狀態變化會影響後續屬性聚合

### 4. 屬性聚合階段

- 重新聚合最終屬性
  - 如 HP、魔力、攻擊速度提升等
- 為所有戰鬥行為（如命中判定、傷害輸出）提供最權威的數值

### 5. 生物狀態判斷階段

- 判斷誰死亡、誰存活
- 血量歸零進入死亡檢查
- 依屬性提供起死回生概率（3%~50%）
  - 復活後恢復 10%~100% 血量
  - 復活後異常狀態全部清除

### 6. 日誌與前端回傳階段

- 寫入日誌（放置遊戲類）
- 返回前端（即時戰鬥類）

---

## 戰鬥系統組成子系統

### 1. Tick 系統

- 控制戰鬥流程的時間節奏

### 2. 角色與屬性聚合系統

- 聚合角色所有屬性
- 在 Tick 結束前提供最終屬性數值

### 3. 狀態處理系統

- 處理 Buff、Debuff、Aura、指示器等持續性 Stat 變化
- 異常狀態機制仍在構思，可能大改
- 各類異常狀態
  - 聖火、充能、冰緩、毒等有各自疊加與觸發規則
  - 無屬性異常如致盲、破甲、出血、褻瀆等
- 裝備、遺物影響
  - 部分裝備、遺物可改變異常狀態計算方式或效果

### 4. 攻擊與技能系統

- 處理自動攻擊與技能施放
- 適用於無法人為操控的自動戰鬥（如 TFT）
- 攻擊與技能分類
  - 僅分「普通攻擊」與「大招」兩種
  - 無元素或物理魔法傷害規則之分
- 普通攻擊
  - 有 cooldown（單位 tick）
- 大招
  - 需能量條充滿後釋放
  - 無 cooldown
  - 能量條由屬性決定獲取速度，並有自然回復
- 傷害類型
  - 一般傷害
  - 真實傷害 True Damage（無視任何減免）
- 異常狀態
  - 獨立於元素
  - 可被裝備、遺物影響
- 閃避與減免機制
  - 自訂，簡化公式

### 5. 戰鬥傷害與防禦應對系統

- 處理傷害計算、防禦、應對機制

---

## 戰鬥事件處理細節

### 瞬發戰鬥事件

- 例如 Damage Event
- 由傷害解析管道系統處理成最終值
- 分為多個階段
  - 每階段有對應監聽效果進行處理

---

## 補充說明

- 同 Tick 下，若同時發生致死攻擊與滿血恢復事件
  - 必須確保處理結果一致，不可隨機
- 所有瞬發戰鬥事件需以事件隊列、連鎖、管道等方式確保發生順序
- 所有子系統合併運作，才構成完整戰鬥系統
