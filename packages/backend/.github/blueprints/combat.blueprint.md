# Combat 戰鬥系統設計文件

## 系統總覽

### 戰鬥驗證架構（前後端雙重模擬）

戰鬥採用前後端雙重模擬與結果驗證模式，確保遊戲公平性：

- 前端職責：
  - 基於相同種子碼（Seed）運行完整戰鬥邏輯
  - 計算勝敗與最終狀態，產生演出日誌供玩家觀看
  - 將結果提交至後端進行驗證
- 後端職責：
  - 接收前端結果，如勝敗與玩家剩餘生命等數據
  - 基於相同種子碼獨立模擬一次戰鬥
  - 對比兩端最終狀態，確保結果完全一致
- 驗證邏輯：
  - 若前後端結果不符則拒絕結算
  - 玩家畫面顯示數據驗證失敗提示
  - 戰鬥回到戰前狀態，該次對戰無效
- 性能考量：
  - 前端運算在短時間內完成並與伺服器比對
  - 後端僅驗證最終狀態，不傳送大量快照封包

## 戰鬥核心流程

戰鬥機制為半回合制自動戰鬥，移除傳統 RPG 攻速與閃避邏輯，改以撲克牌型決定強度。

### 回合與階段處理

- 單一 Round 包含多個發牌與攻擊階段
- 牌庫機制：
  - 戰局內含 52 張標準撲克牌(默認情況下)
  - 雙方都有各自獨立牌庫
  - 系統作為上帝發牌員同時發牌給雙方
- 發牌階段 (Deal Phase)：
  - 逐一發牌給玩家與敵人
  - 一張一張發牌
  - 觸發掛勾：獲取牌時效果（如卡牌附加的狀態）
- 滿手牌判定：
  - 默認一手牌為 5 張
  - 湊滿手牌後進入牌型判定
- 牌型判定階段 (Hand Score Phase)：
  - 根據 Balatro 規則判定牌型等級（如對子、順子、同花等）
  - 判定牌型倍率與最終攻擊數值
  - 觸發掛勾：牌型效果、花色效果
- 攻擊階段 (Combat Phase)：
  - 優先級判定：牌型較優者優先發動攻擊
  - 傷害計算：攻擊力取決於牌型分值與屬性聚合
  - 觸發掛勾：攻擊前與攻擊後效果

## 狀態與屬性系統

### 狀態系統處理階段

- 處理所有 Buff、Debuff、回復等狀態
- 特殊卡牌狀態：例如特定花色或數字附加的負面效果
- 狀態變化將影響後續的屬性聚合

### 屬性聚合系統

- 為戰鬥行為提供最終權威數值
- 包含能量獲取速率、基礎攻擊倍率、生命值上限等

### 生物狀態判斷階段

- 判定存活與死亡
- 血量歸零觸發死亡檢查
- 依屬性提供 3% 至 50% 的起死回生概率
- 復活後清除所有異常狀態並按比例恢復生命

## 戰鬥子系統詳細機制

### 卡牌影響與異常狀態

- 異常狀態不與元素掛鉤，而是與卡牌或角色行為連動
- 案例一：中毒系敵人可對所有紅心牌附加中毒，抽中者立即按比例扣血且中毒計數增加
- 案例二：控制型敵人可縮減對手手牌上限，使其難以組成高階牌型
- 案例三：干預型敵人可搶奪特定數字卡牌（如數字 3），被搶奪者需補抽，搶牌者可突破手牌上限

### 能量與大招系統

- 僅區分普通攻擊與大招
- 普通攻擊：由湊滿手牌後的牌型觸發
- 大招：能量條滿時在該次攻擊階段觸發
- 釋放優先級：大招會取代普通攻擊

---

### 未導入的零碎構思:

- 牌抽光或不足以湊滿手牌時的處理機制
  - 重新洗牌後重抽
  - 如果仍不足就只能以當前手牌進行牌型判定(例如牌庫4張,手牌上限5張,只能以4張牌進行判定)
  - 如果抽光依然只剩 0 張就直接戰敗
- 牌型越好,能拿到的能量越多

### 我對 戰鬥 UI 構思:

- 手機直立方式 (9:16)
- 包含角色立繪(無動畫與特效)
- 雙方各自的撲克牌區域
- 大絕招能量條與 HP 條
- 牌上有狀態(例如綠色黏液中毒,銀色鋼鐵牌等等)
- 打出三條、順子、同花順會有特效顯示
- 造成傷害是會有特效的 例如傷害 95,000
- 角色是不會動的
- 整體UI與配色走簡約風(開發者沒錢)
- 但角色立繪很華麗 是那種 splash art 風格(立繪是沒去背得)
- 因為圖片是 AI 採取日本 二次元遊戲立繪風格生成的
- 但沒有統一性, 一邊可能是毒綠色女巫(背景是黑暗森林) 一邊是重裝機甲女戰士(賽博龐克都市) 有些割裂感
- 但有柔和邊去試圖融合
- 拆成上下兩半部，上半部敵人下半部玩家狀態
- 有UI 按鈕可以看詳細數值 但默認不開啟
- 各自的撲克牌 都是五張 然後每組牌緊密貼再一起上下層次感而非平鋪直敘
