# Combat（戰鬥系統）

## 系統總覽

### 戰鬥驗證架構（前後端雙重模擬）

戰鬥採用「前後端雙重模擬 + 結果驗證」模式，確保遊戲公平性與反作弊：

- **前端職責**：
  - 基於相同種子碼（Seed）運行完整戰鬥邏輯
  - 計算勝敗與最終狀態，產生「演出日誌」供玩家觀看
  - 將結果提交至後端進行驗證
- **後端職責**：
  - 接收前端結果（勝敗、玩家剩餘生命等關鍵數據）
  - 基於相同種子碼獨立模擬一次戰鬥
  - 對比兩端結果，確保完全一致
- **驗證邏輯**：
  - 若前端結果 ≠ 後端模擬結果 → **拒絕該次結算**
  - 玩家畫面出現「伺服器連接異常」或「數據驗證失敗」提示
  - 戰鬥回到「戰前狀態」，該次對戰無效
- **性能考量**：
  - 前端運算通常在 <1 秒完成，與後端比對結果
  - 後端不再發送 snapshot list（封包過多），僅驗證最終狀態
  - 杜絕「修改前端代碼作弊」的可能性

## Tick 處理流程

- 採用 Tick 輪作設計
  - 行為轉換階段：
    - 事件處理順序
  - 事件處理階段：
    - 每個行為於同 Tick 轉換為 Event 物件，進入 Queue 排隊
  - 狀態系統處理階段
  - 屬性聚合階段
  - 生物狀態判斷階段
  - 日誌與前端回傳階段：
    - 將 Event 物件塞入事件 Queue

## 戰鬥系統組成子系統

- 事件處理階段
- Tick 系統：
  - 按順序同步處理 Queue 內所有事件
- 角色與屬性聚合系統：
  - 命中判定
- 狀態處理系統：
  - 其他瞬發戰鬥事件
- 攻擊與技能系統：
  - 玩家僅戰前配置
- 戰鬥傷害與防禦應對系統：
  - 前端呈現為可控重播（可繼續、暫停、1x~3x 變速，由 UI 負責）

## 戰鬥事件處理細節

- 附加隨機延遲
  - 瞬發戰鬥事件：
    - 模擬完畢後將日誌傳回前端

## 補充說明

- 事件階段：
  - BeforeDamage
  - HitCheck
  - Critical
  - DamageModify
  - Defense
  - BeforeApply
  - Apply
  - AfterApply
- 支援目標選擇策略：
  - 攻擊第一位
  - 血最少
  - 血最多
  - 其他策略
- 重點行動皆進入日誌隊列供重播

### 狀態系統處理階段

- 處理所有 Buff、Debuff、回血、回魔等狀態
- 狀態變化會影響後續屬性聚合

### 屬性聚合階段

- 重新聚合最終屬性
  - 如 HP、魔力、攻擊速度提升等
- 為所有戰鬥行為（如命中判定、傷害輸出）提供最權威的數值

### 生物狀態判斷階段

- 判斷誰死亡、誰存活
- 血量歸零進入死亡檢查
- 依屬性提供起死回生概率（3%~50%）
  - 復活後恢復 10%~100% 血量
  - 復活後異常狀態全部清除

### 日誌與前端回傳階段

- 寫入日誌（放置遊戲類）
- 返回前端（即時戰鬥類）

## 戰鬥系統組成子系統（詳細）

### Tick 系統

- 控制戰鬥流程的時間節奏

### 角色與屬性聚合系統

- 聚合角色所有屬性
- 在 Tick 結束前提供最終屬性數值

### 狀態處理系統

- 處理 Buff、Debuff、Aura 等持續性 Stat 變化
- 異常狀態管理見 `ailment.blueprint.md`
- 詳細機制包含：
  - 中毒、冰緩、充能、致盲、嗜血等異常狀態
  - 層數堆疊、衰減規則、時序偏移機制
  - 與裝備間的事件監聽連動
- 裝備、遺物影響：
  - 部分裝備可觸發異常狀態效果
  - 遺物通常提供機制增強而非數值倍增

### 攻擊與技能系統

- 處理自動攻擊與技能施放
- 適用於無法人為操控的自動戰鬥（如 TFT）
- 攻擊與技能分類：
  - 僅分「普通攻擊」與「大招」兩種
  - 無元素或物理魔法傷害規則之分
  - 大招釋放後，本 Tick 不能普攻
  - 同 Tick 下優先級：大招 > 普攻
- 普通攻擊：
  - 有 cooldown（單位 tick）
- 大招：
  - 需能量條充滿後釋放
  - 無 cooldown
  - 能量條由屬性決定獲取速度，並有自然回復
- 傷害類型：
  - 一般傷害
  - 真實傷害 True Damage（無視任何減免）
- 異常狀態：
  - 獨立於元素
  - 可被裝備、遺物影響
- 閃避與減免機制：
  - 自訂，簡化公式

### 戰鬥傷害與防禦應對系統

- 處理傷害計算、防禦、應對機制

## 戰鬥事件處理細節（詳細）

- 瞬發戰鬥事件：
  - 例如 Damage Event
  - 由傷害解析管道系統處理成最終值
  - 分為多個階段
    - 每階段有對應監聽效果進行處理

## 補充說明（詳細）

- 同 Tick 下，若同時發生致死攻擊與滿血恢復事件：
  - 必須確保處理結果一致，不可隨機
- 所有瞬發戰鬥事件需以事件隊列、連鎖、管道等方式確保發生順序
- 所有子系統合併運作，才構成完整戰鬥系統
