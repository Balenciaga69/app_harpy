# Run

## 什麼是 Run

- 遊戲的核心循環單位, 代表一次完整的遊戲運行
- 類似 Slay the Spire 或 Hades 的單次冒險
- 每次 Run 包含隨機生成的關卡, 敵人, 物品和事件
- 玩家從選擇角色開始, 通過戰鬥和決策推進, 直到勝利或失敗
- Run 狀態是臨時的, 成功或失敗後結束
- 玩家帳戶層級的進度 (成就, 解鎖內容) 會保留
- 由多個 Context 組成:角色資訊, 倉庫, 商店狀態, 關卡進程
- Context 在 Run 期間動態更新

## 創建角色與開啟新 Run

### 創角色

- 取得玩家可選的 Profession 和 Start Relic 等模板給前端
- 玩家可調整名稱 (可選)
- 驗證模板是否存在, 是否已解鎖 (基於帳戶進度)
- 創建角色實例, 連同 Run Context 存儲到帳戶

### 開啟新遊戲

- 若有局外之物需注入本 Run (如永久升級), 做成管道函數
- API 端口層驗證是否可創建:檢查無其他啟動中的 Run, 用戶合法性, 資源充足
- 生成所有 Context:角色資訊, 倉庫, 商店狀態, 關卡進程
- 序列化後存儲到外部持久化系統
- 存儲策略:拆分成多個子 JSON 欄位, 添加版本與樂觀鎖機制
- 若玩家有未結束 Run:提供恢復選項或強制結束舊 Run

## 找回 Run 的內容

- 大多數功能都需與各種 Context 交互
- 從持久化存儲調取反序列資訊是必須的
- 所有行為視為請求, 非本地狀態管理
- 初始化函數:在 serverless 環境中預載入 RUN Context
  - 從外部持久化系統獲取子欄位
  - 加速請求並確保數據一致性
- 創角色請求不需初始化 (僅帳戶數據)
- Run 相關請求 (如繼續遊戲) 需觸發初始化
