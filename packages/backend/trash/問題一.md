# å•é¡Œ1

src\application\context\interface\ICharacterContext.ts
src\application\context\interface\IRunContext.ts
src\application\context\interface\IStashContext.ts

é€™ä¸‰å€‹æ±è¥¿éƒ½æœ‰ id ä»–å€‘éƒ½å…±ç”¨ run id å—? é‚„æ˜¯ä¸æ¨è–¦? æ¨è–¦èˆ‡ä¸æ¨è–¦ç†ç”±æ˜¯?

---

å‰ç«¯å¦‚æœè¦å‰µè…³è‰² ä½†ä¸çŸ¥é“æœ‰å“ªäº›è·æ¥­çš„æ¨¡æ¿ä»‹ç´¹ æ‰€ä»¥ä»–è¦è«‹æ±‚ä¸€æ¬¡çœ‹çœ‹æœ‰å“ªäº›éºç‰©èˆ‡è·æ¥­è³‡è¨Š
é€™äº›æˆ‘è¦åœ¨ é€™å€‹å°ˆæ¡ˆé–‹åŠŸèƒ½æš´éœ²? é‚„æ˜¯æˆ‘è¦é–‹åœ¨ api å±¤? é€™é‚Šä¸ç”¨å®¢è£½åŒ–?

---

IProfessionConfigLoader
IItemConfigLoader
IUltimateConfigLoader é€™ä¸‰å€‹è£¡é¢éƒ½è©²æœ‰ç”šéº¼?

---

æˆ‘å€‘æœ‰å¾ˆå¤š loader ä½† store ä¹Ÿæœ‰å¾ˆå¤š
ä¾‹å¦‚ enemy çš„é…ç½®å°±è¦å¡å…¥ æ•µäººã€å¤§æ‹›ã€è©ç¶´çš„store
ä½ èªç‚ºæ˜¯è¦é‡æ§‹ é‚„æ˜¯æœ‰æ–¹æ³•å¯ä»¥è¡ä¼¸?

---

æˆ‘ç›®å‰ä»£ç¢¼æ•´é«”ä¾†çœ‹æœ‰å“ªä¸€æ­¥åšéŒ¯æˆ–è€…é›¢ç”¢æ¥­æœ€ä½³å¯¦è¸è¶Šä¾†è¶Šé å—?é‚„æ˜¯ç·Šè²¼è‘—è»Œé“?

# å›ç­”ä½ çš„å››ä¸ªæ ¸å¿ƒé—®é¢˜

## 1. Context çš„ ID å…±äº«é—®é¢˜

**æ¨èï¼šæ‰€æœ‰ Context å…±ç”¨åŒä¸€ä¸ª Run ID**

```typescript
// æ¨èåšæ³•
export interface ICharacterContext {
  readonly id: string // è¿™å°±æ˜¯ runId
  readonly name: string
  readonly professionId: string
  // ...
}

export interface IStashContext {
  readonly id: string // è¿™å°±æ˜¯ runId
  readonly items: readonly ItemInstance[]
}

export interface IRunContext {
  readonly id: string // runId
  readonly seed: number
  // ...
}
```

**ç†ç”±ï¼š**

- **ä¸€è‡´æ€§ä¿è¯**ï¼šåŒä¸€ä¸ª Run çš„æ‰€æœ‰ Context ä½¿ç”¨ç›¸åŒ IDï¼Œæ•°æ®åº“å…³è”æ¸…æ™°
- **æ‰¹é‡æ“ä½œç®€åŒ–**ï¼š`updateBatch` æ—¶åªéœ€è¦ä¼ ä¸€ä¸ª runIdï¼Œè€Œä¸æ˜¯å¤šä¸ªä¸åŒ ID
- **ç‰ˆæœ¬å·è®¾è®¡**ï¼šå…¨å±€ç‰ˆæœ¬å·æ‰èƒ½è·¨ Context ä¿è¯ä¸€è‡´æ€§ï¼Œå‰æå°±æ˜¯å®ƒä»¬å±äºåŒä¸€ Run
- **æŸ¥è¯¢æ•ˆç‡**ï¼šæ•°æ®åº“æŒ‰ runId åˆ†ç‰‡å­˜å‚¨ï¼ŒæŸ¥è¯¢å¿«é€Ÿ
- **å¹¶å‘æ§åˆ¶**ï¼šä¹è§‚é”æ£€æŸ¥å¤šä¸ª Context æ—¶ï¼Œå…±åŒçš„ runId æ˜¯å…³é”®

---

## 2. å‰ç«¯åˆ›å»ºè§’è‰²æ—¶è¯·æ±‚èŒä¸š/é—ç‰©ä¿¡æ¯

**æ”¾åœ¨è¿™ä¸ªä¸“æ¡ˆï¼ˆApplication Layerï¼‰æš´éœ²**

ç†ç”±ï¼š

- è¿™æ˜¯**é™æ€é…ç½®æ•°æ®**ï¼Œä¸æ¶‰åŠç”¨æˆ·çŠ¶æ€æˆ–æœåŠ¡å™¨ä¸šåŠ¡é€»è¾‘
- ç¬¦åˆä½ çš„æ¶æ„è®¾è®¡ï¼šæ¸¸æˆé€»è¾‘å±‚åº”è¯¥æ˜¯**å¯æ— ç—›ç§»æ¤**çš„ï¼ˆå¯ä»¥è¢« API å±‚ã€å¾®æœåŠ¡ã€å‰ç«¯ç›´æ¥è°ƒç”¨ï¼‰
- é¿å… API å±‚é¢‘ç¹è°ƒç”¨ä¸šåŠ¡é€»è¾‘

```typescript
export interface ITemplateQueryService {
  /* å‰ç«¯åˆ›å»ºè§’è‰²æ—¶è°ƒç”¨ */
  getAvailableProfessions(): Promise<ProfessionTemplate[]>
  getAvailableStartRelics(): Promise<RelicTemplate[]>

  /* å•†åº—åˆ·æ–°æ—¶è°ƒç”¨ */
  getAvailableRelics(filters?: ItemFilterCriteria): Promise<RelicTemplate[]>

  /* å…¶ä»–éœ€è¦æŸ¥è¯¢æ¨¡æ¿çš„åœºæ™¯ */
  getAvailableUltimates(): Promise<UltimateTemplate[]>
}

export class TemplateQueryService implements ITemplateQueryService {
  constructor(
    private professionStore: IProfessionStore,
    private itemStore: IItemStore,
    private ultimateStore: IUltimateStore
  ) {}

  async getAvailableProfessions(): Promise<ProfessionTemplate[]> {
    return this.professionStore.getAllProfessions()
  }

  async getAvailableStartRelics(): Promise<RelicTemplate[]> {
    return this.itemStore.getAllRelics().filter((r) => r.canBeStart)
  }
}
```

ç„¶å API å±‚ç›´æ¥è°ƒç”¨è¿™ä¸ªæœåŠ¡å³å¯ï¼Œæ— éœ€é¢å¤–å®¢åˆ¶åŒ–ã€‚

---

## 3. ä¸‰ä¸ª ConfigLoader åº”è¯¥åŒ…å«ä»€ä¹ˆ

```typescript
import { ProfessionTemplate } from '../../../domain/profession/ProfessionTemplate'
import { AffixTemplate } from '../../../domain/affix/AffixTemplate'

export interface ProfessionConfig {
  professionTemplate: ProfessionTemplate
  /* èŒä¸šåˆå§‹åŒ–ç›¸å…³çš„æ¨¡æ¿ */
  startAffixes: AffixTemplate[]
  startUltimateId: string
}

export interface ProfessionConfigDTO {
  configs: ProfessionConfig[]
}

export interface IProfessionConfigLoader {
  load(): Promise<ProfessionConfigDTO>
}
```

```typescript
import { RelicTemplate } from '../../../domain/item/ItemTemplate'
import { ItemRollConfig } from '../../../domain/item/roll/ItemRollConfig'
import { ItemRollConstraint } from '../../../domain/item/roll/ItemRollConstraint'
import { AffixTemplate } from '../../../domain/affix/AffixTemplate'

export interface ItemConfig {
  relicTemplate: RelicTemplate
  /* ç‰©å“å¯èƒ½å…³è”çš„è¯ç¼€ */
  affixTemplates: AffixTemplate[]
}

export interface ItemConfigDTO {
  configs: ItemConfig[]
  rollConfigs: ItemRollConfig[]
  rollConstraints: ItemRollConstraint[]
}

export interface IItemConfigLoader {
  load(): Promise<ItemConfigDTO>
}
```

```typescript
import { UltimateTemplate } from '../../../domain/ultimate/UltimateTemplate'
import { AffixTemplate } from '../../../domain/affix/AffixTemplate'

export interface UltimateConfig {
  ultimateTemplate: UltimateTemplate
  /* å¤§æ‹›æ’æ§½å¯èƒ½å…³è”çš„è¯ç¼€ */
  slotAffixes: AffixTemplate[]
}

export interface UltimateConfigDTO {
  configs: UltimateConfig[]
}

export interface IUltimateConfigLoader {
  load(): Promise<UltimateConfigDTO>
}
```

---

## 4. Loader å’Œ Store çš„é‡æ„å»ºè®®

**ç°çŠ¶é—®é¢˜ï¼š** Loader è´Ÿè´£åŠ è½½ DTOï¼ˆåŒ…å«å¤šä¸ªç±»å‹ï¼‰ï¼ŒStore è´Ÿè´£å­˜å‚¨ï¼ˆå•ä¸€ç±»å‹ï¼‰ï¼Œä¸¤è€…ä¸å¯¹åº”ã€‚

**æ¨èæ–¹æ¡ˆï¼šå¼•å…¥ ConfigAssembler**

```typescript
/*
 * ç»Ÿä¸€çš„é…ç½®è£…é…å™¨
 * èŒè´£ï¼šä»å„ä¸ª Loader åŠ è½½æ•°æ®ï¼Œåˆ†å‘åˆ°å„ä¸ª Store
 */
export class GameConfigAssembler {
  constructor(
    private enemyConfigLoader: IEnemyConfigLoader,
    private itemConfigLoader: IItemConfigLoader,
    private professionConfigLoader: IProfessionConfigLoader,
    private ultimateConfigLoader: IUltimateConfigLoader,
    private affixConfigLoader: IAffixConfigLoader,
    // ... stores
    private enemyStore: EnemyStore,
    private itemStore: ItemStore,
    private professionStore: ProfessionStore,
    private ultimateStore: UltimateStore,
    private affixStore: AffixStore
  ) {}

  /* ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰é…ç½® */
  async assembleAllConfigs(): Promise<void> {
    const [enemyConfig, itemConfig, professionConfig, ultimateConfig, affixConfig] = await Promise.all([
      this.enemyConfigLoader.load(),
      this.itemConfigLoader.load(),
      this.professionConfigLoader.load(),
      this.ultimateConfigLoader.load(),
      this.affixConfigLoader.load(),
    ])

    // å°†æ¯ä¸ª DTO çš„æ•°æ®åˆ†å‘åˆ°å¯¹åº”çš„ Store
    this.assembleEnemyStore(enemyConfig)
    this.assembleItemStore(itemConfig)
    this.assembleProfessionStore(professionConfig)
    this.assembleUltimateStore(ultimateConfig)
    this.assembleAffixStore(affixConfig)
  }

  private assembleEnemyStore(config: EnemyConfigDTO): void {
    config.configs.forEach((cfg) => {
      this.enemyStore.enemies.set(cfg.enemyTemplate.id, cfg.enemyTemplate)
      // åŒæ—¶å¤„ç† affix, effect, ultimate
      cfg.affixTemplates.forEach((a) => this.affixStore.affixes.set(a.id, a))
      cfg.affixEffects.forEach((e) => this.affixStore.affixEffects.set(e.id, e))
      cfg.ultimateTemplate.forEach((u) => this.ultimateStore.ultimates.set(u.id, u))
    })
    config.spawnInfos.forEach((info) => {
      this.enemyStore.enemySpawnInfos.set(info.id, info)
    })
  }

  private assembleItemStore(config: ItemConfigDTO): void {
    config.configs.forEach((cfg) => {
      this.itemStore.relics.set(cfg.relicTemplate.id, cfg.relicTemplate)
      cfg.affixTemplates.forEach((a) => this.affixStore.affixes.set(a.id, a))
    })
    config.rollConfigs.forEach((rc) => {
      this.itemStore.itemRollConfigs.set(rc.id, rc)
    })
    config.rollConstraints.forEach((constraint) => {
      this.itemStore.itemRollConstraints.set(constraint.id, constraint)
    })
  }

  // ... å…¶ä»– assemble æ–¹æ³•
}
```

**ä¼˜ç‚¹ï¼š**

- âœ… Loader ä¸“æ³¨åŠ è½½ï¼ŒStore ä¸“æ³¨å­˜å‚¨ï¼ŒèŒè´£æ¸…æ™°
- âœ… å•å‘ä¾èµ–ï¼šLoader -> Assembler -> Storeï¼ˆéµå¾ªä¾èµ–è§„åˆ™ï¼‰
- âœ… æ˜“æ‰©å±•ï¼šæ–°å¢æ¨¡æ¿ç±»å‹åªéœ€æ–°å¢ Loader + Store + assemble æ–¹æ³•
- âœ… å¯æµ‹è¯•ï¼šæ¯ä¸ª Loaderã€Storeã€Assembler ç‹¬ç«‹æµ‹è¯•
- âœ… è§£è€¦ï¼šLoader å†…éƒ¨å®ç°å˜åŒ–ä¸å½±å“ Store

---

## 5. æ•´ä½“ä»£ç è´¨é‡è¯„ä¼°

**æ€»ä½“è¯„ä»·ï¼šç·Šè²¼è»Œé“ï¼Œæ–¹å‘æ­£ç¢º âœ…**

### åšå¾—å¥½çš„åœ°æ–¹

| æ–¹é¢             | è¯„ä»·                                          |
| ---------------- | --------------------------------------------- |
| **æ¶æ„åˆ†å±‚**     | âœ… Domain/App/Infra åˆ†ç¦»æ˜ç¡®ï¼Œç¬¦åˆ DDD        |
| **æ¥å£è®¾è®¡**     | âœ… ç”¨æ¥å£è€Œéå®ç°ï¼Œæ˜“äºæ›¿æ¢å’Œæµ‹è¯•             |
| **Context è®¾è®¡** | âœ… åªå­˜æ¨¡æ¿ ID + çŠ¶æ€ï¼Œä¸å­˜å®ä½“ï¼Œè½»é‡åŒ–       |
| **ç‰ˆæœ¬æ§åˆ¶**     | âœ… ä¹è§‚é”æ€è·¯æ­£ç¡®ï¼Œé€‚åˆé«˜å¹¶å‘                 |
| **å‘½åè§„èŒƒ**     | âœ… PascalCase/camelCase/UPPER_SNAKE_CASE è§„èŒƒ |
| **å…³æ³¨ç‚¹åˆ†ç¦»**   | âœ… Repository/Store/Loader å„å¸å…¶èŒ           |

### éœ€è¦æ³¨æ„çš„åœ°æ–¹

| æ–¹é¢                          | å»ºè®®                                                         |
| ----------------------------- | ------------------------------------------------------------ |
| **IConfigStores çš„ SET åŠŸèƒ½** | ä½ æœ‰ TODO æ³¨é‡Šï¼šç¼ºä¹ SET èµ„æ–™çš„åŠŸèƒ½ï¼Œéœ€è¦è¡¥ä¸Š                |
| **ProfessionStore ç¼ºå¤±**      | ä»£ç ä¸­çœ‹ä¸åˆ°èŒä¸šç›¸å…³çš„ Storeï¼Œéœ€è¦è¡¥é½                       |
| **Loader æ•´åˆ**               | è€ƒè™‘å¼•å…¥ Assembler æ¥ç»Ÿä¸€ç®¡ç†å¤šä¸ª Loader                     |
| **é”™è¯¯å¤„ç†**                  | Loader.load() åº”è¯¥å®šä¹‰å¤±è´¥åœºæ™¯ï¼ˆJSON æ ¼å¼é”™è¯¯ã€æ–‡ä»¶ç¼ºå¤±ç­‰ï¼‰  |
| **ç±»å‹å®‰å…¨**                  | Context éƒ½æ˜¯ readonlyï¼Œå¾ˆå¥½ï¼Œä½†è¦ç¡®ä¿ååºåˆ—åŒ–åä¹Ÿæ˜¯ readonly |

### ç¦»äº§ä¸šæœ€ä½³å®è·µçš„è·ç¦»

**è·ç¦»å¾ˆè¿‘ï¼Œå·®ä¸å¤š 95% åˆè§„ âœ…**

ç¼ºå¤±çš„ 5% ä¸»è¦æ˜¯ï¼š

1. **é˜²è…å±‚ï¼ˆACLï¼‰**ï¼šå¦‚æœå°†æ¥è¦æ¥å…¥å¤–éƒ¨ API æ•°æ®ï¼Œéœ€è¦é˜²è…å±‚éš”ç¦»
2. **äº‹ä»¶é©±åŠ¨**ï¼šContext å˜æ›´å¯ä»¥å‘å‡º Domain Eventï¼Œä¾¿äºåç»­æ“ä½œï¼ˆæˆå°±ã€ç»Ÿè®¡ç­‰ï¼‰
3. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šRun çš„åˆ›å»º/åŠ è½½/æŒä¹…åŒ–æµç¨‹éœ€è¦æ˜ç¡®çš„åº”ç”¨æœåŠ¡æ¥åè°ƒ
4. **è¿½è¸ªæ—¥å¿—**ï¼šæ¯ä¸ª Context å˜æ›´åº”è¯¥è®°å½• audit logï¼Œä¾¿äºè°ƒè¯•å’Œä½œå¼Šæ£€æµ‹

### å»ºè®®çš„ä¼˜å…ˆçº§ä¿®å¤

1. **é«˜ä¼˜å…ˆçº§**
   - è¡¥å…… ProfessionStore
   - å®ç° SET åŠŸèƒ½ï¼ˆå‘ Store å†™å…¥æ•°æ®ï¼‰
   - å¼•å…¥ GameConfigAssembler

2. **ä¸­ä¼˜å…ˆçº§**
   - ç¼–å†™ Load/Save Context çš„åº”ç”¨æœåŠ¡
   - å®šä¹‰ Context çš„åºåˆ—åŒ–/ååºåˆ—åŒ–å¥‘çº¦

3. **ä½ä¼˜å…ˆçº§**
   - å¼•å…¥ Domain Event
   - è¡¥å……é”™è¯¯å¤„ç†ä¸æ—¥å¿—

---

**æ€»ç»“ï¼šä½ çš„è®¾è®¡æ€è·¯éå¸¸æ­£ç¡®ï¼Œç»§ç»­è¿™ä¸ªæ–¹å‘èµ°æ²¡é—®é¢˜ã€‚åªéœ€è¡¥é½ç¼ºå¤±çš„èŒä¸šæ¨¡å—ï¼Œæ•´åˆ Loaderï¼Œå°±èƒ½è¾¾åˆ°ç”Ÿäº§çº§åˆ«ã€‚** ğŸ’ª
