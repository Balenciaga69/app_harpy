# å•é¡Œ

Q: ConfigAssembler éå¸¸çš„å¼·å¤§ï¼Œä½†å¦‚æœæœ‰å€‹è«‹æ±‚åªæ˜¯æƒ³æ‹¿å–è·æ¥­æ¨¡æ¿æˆ–æŸå€‹é“å…·æ˜¯å¦å­˜åœ¨ã€‚
é‚£ä¾ç„¶è¦è®€å–é‚£éº¼å¤§é‡çš„è³‡æ–™å—ï¼Ÿ(å‡è¨­é€™äº›è³‡æ–™ä¾†è‡ª Redis)

Q: é€™äº›éœæ…‹è³‡æ–™å¤§å®¶éƒ½ä¸€æ¨£ï¼Œé‚£éº¼æ˜¯å¦çµ±ä¸€å­˜åœ¨ä¸€å€‹å°±å¥½? æˆ‘ç›®å‰æ–¹æ¡ˆæ¨æ¸¬æ˜¯ä½¿ç”¨ AWS Lambda + DynamoDB å»çœéŒ¢

Q: æˆ‘çš„ AppLayer è£¡é¢çš„æ±è¥¿å¥½åƒåŠŸèƒ½éƒ½æœ‰é»ç¡¬æ ¸ï¼Œ domain å‰‡æ˜¯æ˜“æ‡‚å¥½ç†è§£é€™æ˜¯éŠæˆ²ã€‚å…¶ä»–å…¬å¸çš„å…¶ä»–é …ç›®ä¹Ÿéƒ½æ˜¯é€™æ¨£å—? app ä¸€å †å›°é›£çš„å·¥å» ,ç”Ÿæˆå‡½æ•¸,å„²å­˜åº«æ¨£æ¿ç­‰ç­‰ã€‚æˆ‘ä»¥ç‚º CRUD æˆ–ä¸€äº›æœ‰è¶£çš„æ¥­å‹™é‚è¼¯æœƒåœ¨ applayeræ¬¸

Q: ç›®å‰ä¾†çœ‹å¦‚æœè¦çœæµé‡ æé«˜æ€§èƒ½ åˆä¾¿å®œ æˆ‘è¦å“ªäº›åœ°æ–¹ä¸‹åŠŸå¤«?æˆ–è€…å¯èƒ½è¦é‡æ§‹ å› ç‚ºæœ‰ä¸éŒ¯çš„è§£æ±ºæ–¹æ¡ˆ? é‚„æ˜¯ trade-off è‡ªå·±å–æ¨?

# æ·±åº¦å›ç­”å››ä¸ªæ¶æ„é—®é¢˜

## Q1: å°è¯·æ±‚ä¹Ÿè¦åŠ è½½å…¨é‡æ•°æ®å—ï¼Ÿ

**ç­”ï¼šä¸ç”¨ã€‚å¼•å…¥åˆ†å±‚åŠ è½½ç­–ç•¥ã€‚**

```typescript
/*
 * åˆ†å±‚åŠ è½½å™¨ï¼šæŒ‰éœ€åŠ è½½ï¼Œè€Œéä¸€æ¬¡æ€§å…¨é‡
 * - çƒ­æ•°æ®ï¼ˆèŒä¸šã€åŸºç¡€é—ç‰©ï¼‰ï¼šç¨‹åºå¯åŠ¨æ—¶åŠ è½½
 * - æ¸©æ•°æ®ï¼ˆé«˜çº§é—ç‰©ã€è¯ç¼€ï¼‰ï¼šç¬¬ä¸€æ¬¡è®¿é—®æ—¶åŠ è½½
 * - å†·æ•°æ®ï¼ˆç‰¹æ®Šäº‹ä»¶ã€éšè—æ•Œäººï¼‰ï¼šçœŸæ­£éœ€è¦æ—¶åŠ è½½
 */
export class LazyConfigLoader {
  private loadedConfigs = new Set<string>()

  constructor(
    private cache: IRedisCache, // Redis ç¼“å­˜å±‚
    private professionLoader: IProfessionConfigLoader,
    private itemLoader: IItemConfigLoader,
    private enemyLoader: IEnemyConfigLoader,
    private affixLoader: IAffixConfigLoader,
    private ultimateLoader: IUltimateConfigLoader,
    // stores...
    private professionStore: ProfessionStore,
    private itemStore: ItemStore,
    private enemyStore: EnemyStore,
    private affixStore: AffixStore,
    private ultimateStore: UltimateStore
  ) {}

  /* å¯åŠ¨æ—¶ï¼šä»…åŠ è½½çƒ­æ•°æ® */
  async initializeHotData(): Promise<void> {
    const professionConfig = await this.cache.getOrLoad(
      'config:profession',
      () => this.professionLoader.load(),
      3600 * 24 // 24å°æ—¶è¿‡æœŸ
    )
    this.assembleProfession(professionConfig)
    this.loadedConfigs.add('profession')
  }

  /* æŒ‰éœ€åŠ è½½ï¼šèŒä¸šæ¨¡æ¿ */
  async getProfessionTemplate(id: string): Promise<ProfessionTemplate | null> {
    await this.ensureLoaded('profession')
    return this.professionStore.getProfession(id) ?? null
  }

  /* æŒ‰éœ€åŠ è½½ï¼šç‰©å“ç›¸å…³ */
  async getRelicTemplate(id: string): Promise<RelicTemplate | null> {
    await this.ensureLoaded('item')
    return this.itemStore.getRelic(id) ?? null
  }

  /* æŒ‰éœ€åŠ è½½ï¼šæ•Œäººé…ç½®ï¼ˆé€šå¸¸åœ¨æˆ˜æ–—æ—¶æ‰åŠ è½½ï¼‰ */
  async getEnemyTemplate(id: string): Promise<EnemyTemplate | null> {
    await this.ensureLoaded('enemy')
    return this.enemyStore.getEnemy(id) ?? null
  }

  /* å†…éƒ¨ï¼šç¡®ä¿æ•°æ®å·²åŠ è½½ */
  private async ensureLoaded(configType: string): Promise<void> {
    if (this.loadedConfigs.has(configType)) {
      return
    }

    switch (configType) {
      case 'profession':
        await this.initializeHotData()
        break
      case 'item':
        const itemConfig = await this.cache.getOrLoad('config:item', () => this.itemLoader.load(), 3600 * 24)
        this.assembleItem(itemConfig)
        break
      case 'enemy':
        const enemyConfig = await this.cache.getOrLoad('config:enemy', () => this.enemyLoader.load(), 3600 * 24)
        this.assembleEnemy(enemyConfig)
        break
      case 'affix':
        const affixConfig = await this.cache.getOrLoad('config:affix', () => this.affixLoader.load(), 3600 * 24)
        this.assembleAffix(affixConfig)
        break
    }

    this.loadedConfigs.add(configType)
  }

  // ... assemble æ–¹æ³•
}
```

**æ•ˆæœï¼š**

- âœ… é¦–æ¬¡è¯·æ±‚èŒä¸šæ¨¡æ¿ï¼šåªåŠ è½½èŒä¸šé…ç½®ï¼ˆå‡  MBï¼‰
- âœ… é¦–æ¬¡è¯·æ±‚ç‰©å“ï¼šåŠ è½½ç‰©å“é…ç½®ï¼ˆå‡  MBï¼‰
- âœ… åŒç±»è¯·æ±‚æ— ç¼å‘½ä¸­ Redis ç¼“å­˜ï¼ˆæ¯«ç§’çº§ï¼‰
- âœ… ä¸ä¼šä¸€æ¬¡æ€§åŠ è½½ 100+ MB æ•°æ®

---

## Q2: é™æ€æ•°æ®é›†ä¸­å­˜å‚¨æ–¹æ¡ˆ

**ç­”ï¼šå®Œå…¨èµåŒã€‚æ¨èç”¨ AWS Lambda + DynamoDBã€‚**

### æ¶æ„å¯¹æ¯”

| æ–¹æ¡ˆ                  | æˆæœ¬ | å»¶è¿Ÿ     | å¯æ‰©å±•æ€§   | é€‚ç”¨åœºæ™¯       |
| --------------------- | ---- | -------- | ---------- | -------------- |
| **æœ¬åœ°å†…å­˜ (å½“å‰)**   | ä½   | 0ms      | å·®ï¼ˆå•æœºï¼‰ | å•æœåŠ¡å™¨       |
| **Redis é›†ä¸­**        | ä¸­   | 1-5ms    | ä¸­         | ä¸­ç­‰è§„æ¨¡       |
| **Lambda + DynamoDB** | ä½   | 5-50ms   | ä¼˜ç§€       | æŒ‰éœ€ä»˜è´¹ï¼Œå¼¹æ€§ |
| **CDN + S3**          | ä½   | 50-200ms | ä¼˜ç§€       | å…¨çƒåˆ†å¸ƒ       |

### æ¨èæ¶æ„ï¼šLambda API + DynamoDB

```typescript
/*
 * DynamoDB é…ç½®åŠ è½½å™¨
 * - æ‰€æœ‰æœåŠ¡å™¨å…±ç”¨ä¸€ä»½æ•°æ®
 * - æŒ‰éœ€ä»˜è´¹ï¼Œæ— éœ€ç»´æŠ¤æœåŠ¡å™¨
 * - å¯è·¨åœ°åŒºå¤åˆ¶ï¼Œæ”¯æŒå…¨çƒç©å®¶
 */
import { DynamoDBClient } from '@aws-sdk/client-dynamodb'

export class DynamoDBConfigLoader implements IConfigLoader {
  private dynamodb: DynamoDBClient
  private tableName = 'GameConfigs'

  constructor() {
    this.dynamodb = new DynamoDBClient({ region: 'us-east-1' })
  }

  /* è·å–èŒä¸šé…ç½® */
  async getProfessionConfig(): Promise<ProfessionConfigDTO> {
    const response = await this.dynamodb.getItem({
      TableName: this.tableName,
      Key: {
        configType: { S: 'profession' },
        version: { N: '1' }, // ç‰ˆæœ¬å·ç”¨äº A/B æµ‹è¯•
      },
    })

    return JSON.parse(response.Item?.data.S || '{}')
  }

  /* æ‰¹é‡è·å–å¤šä¸ªé…ç½® */
  async batchGetConfigs(types: string[]): Promise<Map<string, any>> {
    const results = new Map()

    const batchGetRequest = types.map((type) => ({
      TableName: this.tableName,
      Key: {
        configType: { S: type },
        version: { N: '1' },
      },
    }))

    // DynamoDB æ‰¹é‡è¯»å–ï¼ˆæœ€å¤š 100 ä¸ªï¼‰
    const response = await this.dynamodb.batchGetItem({
      RequestItems: {
        [this.tableName]: batchGetRequest,
      },
    })

    response.Responses?.[this.tableName]?.forEach((item) => {
      const type = item.configType.S
      results.set(type, JSON.parse(item.data.S))
    })

    return results
  }
}
```

### è´¹ç”¨ä¼°ç®—ï¼ˆæœˆæˆæœ¬ï¼‰

å‡è®¾ï¼š

- 100 ä¸‡ç©å®¶
- æ¯å¤©å¹³å‡ 10 ä¸‡æ´»è·ƒç©å®¶
- æ¯ä¸ªç©å®¶å¹³å‡æŸ¥è¯¢ 5 æ¬¡é…ç½®ï¼ˆèŒä¸šã€é“å…·ã€æ•Œäººç­‰ï¼‰

**DynamoDB è®¡è´¹ï¼š**

- è¯»å®¹é‡ï¼š50 ä¸‡è¯»å–/å¤© = ~6 RCUï¼ˆæŒ‰éœ€ä»˜è´¹ $1.25/ç™¾ä¸‡è¯»ï¼‰= **$0.625/å¤©** = **$18.75/æœˆ**
- å­˜å‚¨ï¼š100 MB é…ç½®æ•°æ® = **$0.25/æœˆ**
- **æ€»è®¡ï¼š~$19/æœˆ**

**vs è‡ªå»ºæœåŠ¡å™¨ Redisï¼š**

- EC2 t3.mediumï¼š$30/æœˆ
- ElastiCache Redisï¼š$50/æœˆ
- **æ€»è®¡ï¼š~$80/æœˆ**

**èŠ‚çœ 76%ï¼** ğŸ’°

---

## Q3: ä¸ºä»€ä¹ˆ App Layer è¿™ä¹ˆ"ç¡¬æ ¸"ï¼Ÿ

**ç­”ï¼šè¿™ä¸æ˜¯é—®é¢˜ï¼Œè¿™æ˜¯æ­£å¸¸çš„æ¶æ„åˆ†å·¥ã€‚ä½ ç†è§£åäº†ã€‚**

### æ ‡å‡†çš„åˆ†å±‚æ¶æ„èŒè´£

```
Domain Layerï¼ˆé¢†åŸŸå±‚ï¼‰
â”œâ”€ æ˜“è¯»ã€æ˜“æ‡‚ã€æ ¸å¿ƒä¸šåŠ¡è§„åˆ™
â”œâ”€ ä¾‹å¦‚ï¼šä¼¤å®³è®¡ç®—ã€æ‰è½é€»è¾‘ã€ç­‰çº§åŠ æˆ
â””â”€ ä¸å…³å¿ƒå¦‚ä½•å­˜å‚¨ã€å¦‚ä½•è°ƒç”¨

Application Layerï¼ˆåº”ç”¨å±‚ï¼‰â† è¿™é‡Œæœ€"ç¡¬æ ¸"
â”œâ”€ å·¥å‚å‡½æ•°ã€Builder Pattern
â”œâ”€ Repository Patternã€Service Locator
â”œâ”€ äº‹åŠ¡ç®¡ç†ã€é”™è¯¯å¤„ç†ã€æ—¥å¿—
â”œâ”€ åè°ƒå¤šä¸ª Domain å¯¹è±¡
â””â”€ è¿™é‡Œå°±æ˜¯åº”è¯¥"éš¾"çš„ï¼

API Layerï¼ˆè¡¨ç°å±‚ï¼‰
â”œâ”€ HTTP è·¯ç”±ã€è¯·æ±‚éªŒè¯
â”œâ”€ åºåˆ—åŒ–/ååºåˆ—åŒ–
â””â”€ æ˜ å°„åˆ° Application Service
```

### ä¸ºä»€ä¹ˆ App Layer ä¼š"ç¡¬æ ¸"ï¼Ÿ

**åº”ç”¨å±‚çš„èŒè´£å°±æ˜¯å¤æ‚çš„ï¼** å®ƒéœ€è¦ï¼š

1. **åè°ƒå¤šä¸ªé¢†åŸŸå¯¹è±¡**

   ```typescript
   // App Layerï¼šåè°ƒ RunContext, CharacterContext, StashContext
   async executeShopPurchase(runId, itemId, gold) {
     const [runContext, characterContext, stashContext] =
       await this.loadContexts(runId)

     // éªŒè¯ã€è®¡ç®—ã€æ›´æ–°
     const newContexts = applyShopLogic(runContext, characterContext, itemId)

     // ä¸€æ¬¡æ€§æŒä¹…åŒ–
     await this.repository.updateBatch(newContexts)
   }
   ```

2. **ç®¡ç†ç”Ÿå‘½å‘¨æœŸ**

   ```typescript
   // App Layerï¼šåˆ›å»º Runã€åˆå§‹åŒ– Contextã€æŒä¹…åŒ–
   async startNewRun(playerId, professionId) {
     const profession = await this.professionStore.get(professionId)
     const character = CharacterFactory.createFromProfession(profession)
     const run = RunFactory.create(playerId, character)
     await this.repository.create(run)
     return run
   }
   ```

3. **å¤„ç†é”™è¯¯å’Œå¹¶å‘**
   ```typescript
   // App Layerï¼šé‡è¯•é€»è¾‘ã€ä¹è§‚é”å¤„ç†
   async updateWithRetry(context, expectedVersion) {
     let retries = 0
     while (retries < 3) {
       const result = await this.repository.update(context, expectedVersion)
       if (result) return result
       // ç‰ˆæœ¬å†²çªï¼Œé‡æ–°åŠ è½½å¹¶é‡è¯•
       const latest = await this.repository.getById(context.id)
       context = recalculateContext(latest)
       expectedVersion = latest.version
       retries++
     }
     throw new ConcurrencyError()
   }
   ```

### å¯¹æ¯”ï¼šå…¶ä»–å…¬å¸é¡¹ç›®

**ç”µå•†é¡¹ç›®çš„ App Layerï¼š**

```typescript
// ä¸€æ ·å¤æ‚ï¼
class OrderApplicationService {
  async createOrder(userId, items, address) {
    // 1. éªŒè¯ç”¨æˆ·ã€ç‰©å“ã€åœ°å€
    // 2. è®¡ç®—ä»·æ ¼ã€ç¨è´¹ã€è¿è´¹
    // 3. æ‰£åº“å­˜ï¼ˆå¯èƒ½å¤šä¸ªä»“åº“ï¼Œéœ€è¦åˆ†é…ï¼‰
    // 4. åˆ›å»ºæ”¯ä»˜å•æ®
    // 5. å‘é€äº‹ä»¶ç»™å…¶ä»–å¾®æœåŠ¡
    // 6. æ‰“å°å‘è´§å•
    // 7. å¤„ç†å¤±è´¥å›æ»š
    // è¿™é‡Œ "ç¡¬æ ¸" å—ï¼Ÿå½“ç„¶ï¼ä½†è¿™å°±æ˜¯åº”è¯¥çš„ã€‚
  }
}
```

**æ¸¸æˆé¡¹ç›®çš„ App Layerï¼š**

```typescript
// ä½ çš„è®¾è®¡ï¼ˆä¹Ÿæ˜¯å¤æ‚çš„ï¼Œä½†æ­£ç¡®çš„ï¼‰
class RunApplicationService {
  async advanceStage(runId) {
    // 1. åŠ è½½ RunContext, CharacterContext, StashContext
    // 2. æ ¹æ® Difficulty ç”Ÿæˆæ•Œäºº
    // 3. è¿è¡Œæˆ˜æ–—é€»è¾‘
    // 4. è®¡ç®—æˆ˜æ–—å¥–åŠ±
    // 5. æ›´æ–°å¤šä¸ª Contextï¼ˆåŸå­æ€§ï¼‰
    // 6. å‘é€æˆå°±äº‹ä»¶
  }
}
```

**ç»“è®ºï¼šApp Layer å°±åº”è¯¥"ç¡¬æ ¸"ï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚Domain Layer çš„ç®€å•ï¼Œæ˜¯å› ä¸ºå®ƒä¸“æ³¨äºä¸šåŠ¡è§„åˆ™æœ¬èº«ã€‚**

---

## Q4: æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ä¸‰æ‹›

### ç°çŠ¶è¯„ä¼°

ä½ çš„æ¶æ„å·²ç»ä¸é”™ï¼Œä¸»è¦ç“¶é¢ˆåœ¨ï¼š

1. **æ•°æ®åº“æŸ¥è¯¢** â† æœ€å¤§ç“¶é¢ˆ
2. **ç½‘ç»œå¾€è¿”** â† ç¬¬äºŒå¤§ç“¶é¢ˆ
3. **è®¡ç®—å¼€é”€** â† ç¬¬ä¸‰ï¼ˆä½†ä½ ç”¨çš„æ˜¯ TSï¼Œä¸æ˜¯ Pythonï¼‰

### ä¼˜åŒ–æ–¹æ¡ˆï¼ˆæŒ‰ ROI æ’åºï¼‰

#### ç¬¬ä¸€æ‹›ï¼šæ‰¹é‡æ›´æ–°ï¼ˆæœ€é«˜ ROIï¼‰

**ç°çŠ¶é—®é¢˜ï¼š**

```typescript
// âŒ åï¼šæ¯ä¸ªæ“ä½œéƒ½è¦åˆ†å¼€æ›´æ–° 3 ä¸ª Context
await characterRepo.update(char)
await stashRepo.update(stash)
await runRepo.update(run)
// 3 æ¬¡æ•°æ®åº“å¾€è¿”ï¼Œä»»ä¸€å¤±è´¥éƒ½è¦å›æ»šå¤„ç†
```

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

```typescript
// âœ… å¥½ï¼šä¸€æ¬¡æ€§æ›´æ–°ï¼ŒåŸå­æ€§ä¿è¯
await contextBatchRepository.updateBatch(
  {
    character: { context: char, expectedVersion: charV },
    stash: { context: stash, expectedVersion: stashV },
    run: { context: run, expectedVersion: runV },
  },
  globalVersion
)
// 1 æ¬¡æ•°æ®åº“å¾€è¿”
```

**æ€§èƒ½æå‡ï¼š70%ï¼ˆä» 3 æ¬¡å¾€è¿” â†’ 1 æ¬¡å¾€è¿”ï¼‰**

---

#### ç¬¬äºŒæ‹›ï¼šRedis ä¸¤å±‚ç¼“å­˜

**ç¬¬ä¸€å±‚ï¼šçƒ­æ•°æ®ç¼“å­˜ï¼ˆèŒä¸šã€é“å…·æ¨¡æ¿ï¼‰**

```typescript
// è·å–èŒä¸šï¼šRedis å‘½ä¸­ç‡ 99%
const profession = await this.cache.getOrLoad(
  `profession:${id}`,
  () => this.professionLoader.load(id),
  86400 // 24å°æ—¶è¿‡æœŸ
)
```

**ç¬¬äºŒå±‚ï¼šContext ç¼“å­˜ï¼ˆå½“å‰ Run æ•°æ®ï¼‰**

```typescript
// åŒä¸€ä¸ª Run çš„å¤šä¸ªè¯·æ±‚ï¼šæ— éœ€é‡å¤æŸ¥æ•°æ®åº“
const runContext = await this.cache.getOrLoad(
  `runContext:${runId}`,
  () => this.repository.getById(runId),
  300 // 5åˆ†é’Ÿè¿‡æœŸï¼ˆRun çŠ¶æ€å˜åŒ–å¿«ï¼‰
)
```

**æ€§èƒ½æå‡ï¼š50-80%ï¼ˆä» DB æ¯«ç§’çº§ â†’ ç¼“å­˜å¾®ç§’çº§ï¼‰**

---

#### ç¬¬ä¸‰æ‹›ï¼šCDN åˆ†å‘é™æ€é…ç½®

**å½“å‰ï¼šæ¯ä¸ªè¯·æ±‚éƒ½æŸ¥ Redis**

````
è¯·æ±‚ â†’ Lambda â†’ Redis â†’ è¿”å› (5ms)
```

**ä¼˜åŒ–åï¼šè¾¹ç¼˜èŠ‚ç‚¹è¿”å›**
````

è¯·æ±‚ â†’ CloudFront CDNï¼ˆå…¨çƒè¾¹ç¼˜èŠ‚ç‚¹ï¼‰â†’ è¿”å› (50msï¼Œä½†åªéœ€ä¸€æ¬¡)
â””â”€ å¦‚æœ Miss â†’ Lambda â†’ DynamoDB â†’ æ›´æ–° CDN

`````

**é€‚ç”¨åœºæ™¯ï¼š**
- èŒä¸šåˆ—è¡¨ã€é“å…·æ¨¡æ¿ã€è¯ç¼€åˆ—è¡¨
- **ä¸é€‚ç”¨ï¼š** å½“å‰ Run çŠ¶æ€ï¼ˆä¼šå˜ï¼‰

---

### ç»¼åˆä¼˜åŒ–å»ºè®®

æ ¹æ®ä½ çš„ AWS Lambda + DynamoDB æ–¹æ¡ˆï¼š

````typescript
// filepath: c:\Users\wits\Desktop\GitRepo\app_harpy\packages\backend\src\infra\cache\HybridCacheStrategy.ts
export class HybridCacheStrategy {
  constructor(
    private cdn: CloudFront,           // ç¬¬ä¸€å±‚ï¼šå…¨çƒ CDN
    private redis: Redis,              // ç¬¬äºŒå±‚ï¼šåŒºåŸŸç¼“å­˜
    private dynamodb: DynamoDBClient   // ç¬¬ä¸‰å±‚ï¼šæ•°æ®æº
  ) {}

  /* è·å–é…ç½®ï¼ˆé«˜åº¦é™æ€ï¼‰ */
  async getProfessionTemplate(id: string): Promise<ProfessionTemplate> {
    // 1. CDN ç¼“å­˜ï¼ˆå…¨çƒè¾¹ç¼˜ï¼Œ12å°æ—¶ï¼‰
    const cdnCached = await this.cdn.get(`profession/${id}`)
    if (cdnCached) return cdnCached

    // 2. Redisï¼ˆåŒºåŸŸç¼“å­˜ï¼Œ1å°æ—¶ï¼‰
    const redisCached = await this.redis.get(`profession:${id}`)
    if (redisCached) {
      this.cdn.set(`profession/${id}`, redisCached, 43200) // æ›´æ–° CDN
      return redisCached
    }

    // 3. DynamoDBï¼ˆæ•°æ®æºï¼‰
    const data = await this.dynamodb.getItem('profession', id)
    this.redis.set(`profession:${id}`, data, 3600)
    this.cdn.set(`profession/${id}`, data, 43200)
    return data
  }

  /* è·å– Run çŠ¶æ€ï¼ˆé¢‘ç¹å˜åŒ–ï¼‰ */
  async getRunContext(runId: string): Promise<RunContext> {
    // åªç”¨ Redisï¼ˆ5åˆ†é’Ÿï¼‰+ DynamoDB
    // ä¸ç”¨ CDNï¼ˆå› ä¸ºä¼šå˜ï¼‰
    const cached = await this.redis.get(`runContext:${runId}`)
    if (cached) return cached

    const data = await this.dynamodb.getItem('runContext', runId)
    this.redis.set(`runContext:${runId}`, data, 300)
    return data
  }
}
`````

### æˆæœ¬ä¸æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ       | æˆæœ¬    | å»¶è¿Ÿ  | åå       | å¤æ‚åº¦ |
| ---------- | ------- | ----- | ---------- | ------ |
| **å½“å‰**   | $80/æœˆ  | 100ms | 1K req/s   | ä¸­     |
| **åŠ ç¼“å­˜** | $100/æœˆ | 20ms  | 10K req/s  | ä¸­     |
| **åŠ  CDN** | $120/æœˆ | 50ms  | 50K req/s  | é«˜     |
| **å…¨ä¼˜åŒ–** | $150/æœˆ | 5ms   | 100K req/s | é«˜     |

**æœ€ä½³å¹³è¡¡ç‚¹ï¼šæ–¹æ¡ˆ 2ï¼ˆåŠ  Redis ç¼“å­˜ï¼‰**

- æˆæœ¬å¢åŠ  25%
- æ€§èƒ½æå‡ 80%
- å¤æ‚åº¦å¯æ§

---

## æ€»ç»“è¡¨

| é—®é¢˜                   | ç­”æ¡ˆ                               | ä¼˜å…ˆçº§ |
| ---------------------- | ---------------------------------- | ------ |
| **å°è¯·æ±‚è¦å…¨é‡åŠ è½½ï¼Ÿ** | ç”¨ LazyConfigLoader æŒ‰éœ€åŠ è½½       | é«˜     |
| **é›†ä¸­å­˜å‚¨æ–¹æ¡ˆï¼Ÿ**     | Lambda + DynamoDB å®Œå…¨èµåŒï¼Œçœ 76% | é«˜     |
| **App Layer å¾ˆç¡¬æ ¸ï¼Ÿ** | æ­£å¸¸çš„ï¼Œè¿™æ˜¯åº”è¯¥çš„                 | ä¿¡æ¯æ€§ |
| **æ€§èƒ½ä¼˜åŒ–æ–¹å‘ï¼Ÿ**     | æ‰¹é‡æ›´æ–° > Redis ç¼“å­˜ > CDN        | é«˜     |

**å»ºè®®çš„å®æ–½è·¯çº¿å›¾ï¼š**

1. å®ç° `LazyConfigLoader`ï¼ˆ1-2 å¤©ï¼‰
2. å®ç°æ‰¹é‡æ›´æ–°é€»è¾‘ï¼ˆ2-3 å¤©ï¼‰
3. é›†æˆ Redis äºŒå±‚ç¼“å­˜ï¼ˆ2-3 å¤©ï¼‰
4. è¿ç§»åˆ° AWS Lambda + DynamoDBï¼ˆ1-2 å‘¨ï¼Œå¯é€‰ï¼‰**é€‚ç”¨åœºæ™¯ï¼š**

- èŒä¸šåˆ—è¡¨ã€é“å…·æ¨¡æ¿ã€è¯ç¼€åˆ—è¡¨
- **ä¸é€‚ç”¨ï¼š** å½“å‰ Run çŠ¶æ€ï¼ˆä¼šå˜ï¼‰

---

### ç»¼åˆä¼˜åŒ–å»ºè®®

æ ¹æ®ä½ çš„ AWS Lambda + DynamoDB æ–¹æ¡ˆï¼š

```typescript
// filepath: c:\Users\wits\Desktop\GitRepo\app_harpy\packages\backend\src\infra\cache\HybridCacheStrategy.ts
export class HybridCacheStrategy {
  constructor(
    private cdn: CloudFront, // ç¬¬ä¸€å±‚ï¼šå…¨çƒ CDN
    private redis: Redis, // ç¬¬äºŒå±‚ï¼šåŒºåŸŸç¼“å­˜
    private dynamodb: DynamoDBClient // ç¬¬ä¸‰å±‚ï¼šæ•°æ®æº
  ) {}

  /* è·å–é…ç½®ï¼ˆé«˜åº¦é™æ€ï¼‰ */
  async getProfessionTemplate(id: string): Promise<ProfessionTemplate> {
    // 1. CDN ç¼“å­˜ï¼ˆå…¨çƒè¾¹ç¼˜ï¼Œ12å°æ—¶ï¼‰
    const cdnCached = await this.cdn.get(`profession/${id}`)
    if (cdnCached) return cdnCached

    // 2. Redisï¼ˆåŒºåŸŸç¼“å­˜ï¼Œ1å°æ—¶ï¼‰
    const redisCached = await this.redis.get(`profession:${id}`)
    if (redisCached) {
      this.cdn.set(`profession/${id}`, redisCached, 43200) // æ›´æ–° CDN
      return redisCached
    }

    // 3. DynamoDBï¼ˆæ•°æ®æºï¼‰
    const data = await this.dynamodb.getItem('profession', id)
    this.redis.set(`profession:${id}`, data, 3600)
    this.cdn.set(`profession/${id}`, data, 43200)
    return data
  }

  /* è·å– Run çŠ¶æ€ï¼ˆé¢‘ç¹å˜åŒ–ï¼‰ */
  async getRunContext(runId: string): Promise<RunContext> {
    // åªç”¨ Redisï¼ˆ5åˆ†é’Ÿï¼‰+ DynamoDB
    // ä¸ç”¨ CDNï¼ˆå› ä¸ºä¼šå˜ï¼‰
    const cached = await this.redis.get(`runContext:${runId}`)
    if (cached) return cached

    const data = await this.dynamodb.getItem('runContext', runId)
    this.redis.set(`runContext:${runId}`, data, 300)
    return data
  }
}
```

### æˆæœ¬ä¸æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ       | æˆæœ¬    | å»¶è¿Ÿ  | åå       | å¤æ‚åº¦ |
| ---------- | ------- | ----- | ---------- | ------ |
| **å½“å‰**   | $80/æœˆ  | 100ms | 1K req/s   | ä¸­     |
| **åŠ ç¼“å­˜** | $100/æœˆ | 20ms  | 10K req/s  | ä¸­     |
| **åŠ  CDN** | $120/æœˆ | 50ms  | 50K req/s  | é«˜     |
| **å…¨ä¼˜åŒ–** | $150/æœˆ | 5ms   | 100K req/s | é«˜     |

**æœ€ä½³å¹³è¡¡ç‚¹ï¼šæ–¹æ¡ˆ 2ï¼ˆåŠ  Redis ç¼“å­˜ï¼‰**

- æˆæœ¬å¢åŠ  25%
- æ€§èƒ½æå‡ 80%
- å¤æ‚åº¦å¯æ§

---

## æ€»ç»“è¡¨

| é—®é¢˜                   | ç­”æ¡ˆ                               | ä¼˜å…ˆçº§ |
| ---------------------- | ---------------------------------- | ------ |
| **å°è¯·æ±‚è¦å…¨é‡åŠ è½½ï¼Ÿ** | ç”¨ LazyConfigLoader æŒ‰éœ€åŠ è½½       | é«˜     |
| **é›†ä¸­å­˜å‚¨æ–¹æ¡ˆï¼Ÿ**     | Lambda + DynamoDB å®Œå…¨èµåŒï¼Œçœ 76% | é«˜     |
| **App Layer å¾ˆç¡¬æ ¸ï¼Ÿ** | æ­£å¸¸çš„ï¼Œè¿™æ˜¯åº”è¯¥çš„                 | ä¿¡æ¯æ€§ |
| **æ€§èƒ½ä¼˜åŒ–æ–¹å‘ï¼Ÿ**     | æ‰¹é‡æ›´æ–° > Redis ç¼“å­˜ > CDN        | é«˜     |

**å»ºè®®çš„å®æ–½è·¯çº¿å›¾ï¼š**

1. å®ç° `LazyConfigLoader`ï¼ˆ1-2 å¤©ï¼‰
2. å®ç°æ‰¹é‡æ›´æ–°é€»è¾‘ï¼ˆ2-3 å¤©ï¼‰
3. é›†æˆ Redis äºŒå±‚ç¼“å­˜ï¼ˆ2-3 å¤©ï¼‰
4. è¿ç§»åˆ° AWS Lambda + DynamoDBï¼ˆ1-2 å‘¨ï¼Œå¯é€‰ï¼‰
