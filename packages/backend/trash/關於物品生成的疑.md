## 關於物品生成

- [TODO:] 生成來源眾多, 目前尚未完全實裝

- 戰鬥勝利獎勵或商店刷新時會根據 預設配置 + 難度係數去運算本次獎勵的物品如何分布

- 但我在煩惱，有太多因素了到底該怎麼設計
  我的初步想法

1. 商店、獎勵會決定這次可以拿到多少東西 例如商店刷新固定 6 格,獎勵固定 1 格
2. 按照固定機率決定每格會產出生甚麼類型物品(裝備35%、寶石5%、遺物60%)
3. 接著提取外部的難度係數與[某個值]去做加總算出本輪刷新可以撈出的稀有值總額
4. 然後去每格都獨立去骰出物品並扣除稀有度總額
5. 最後一格必須把稀有度總額消化完(可以默許 +-10%)偏差否則強制硬扣除

---

最難的東西來了

- 某個值是啥?我自己不知道?我也只是想像中有個值而已
- 如何硬抽出來?會不會變成無窮迴圈?
- 理論上同樣稀有度的裝備基本上權重一樣,但我們會有一些刻意調權重的額外變數
  他會把火標籤的物品中獎率提高,冰屬性降低等等
- 還有些是傳奇中的傳奇 稀有中的稀有 這種的卻又要有權重獨立調整

---

我希望找個大一統方法能改良這一套機制
或者取材其他遊戲他們都怎麼做到的

---

我們遊戲的詞綴是綁定裝備(就像是英雄聯盟)不是POE那種無限生成

針對物品生成系統，作為架構師，我建議捨棄「扣除稀有度總額」這種由上而下的分配法，因為它在處理異質物品（裝備 vs 遺物）與動態權重時，容易導致邏輯過於脆弱且難以維護 。

我們可以結合 **POE 的權重系統 (Weight-based Rolling)** 與 **Hades 的標籤引導 (Tag-driven system)**，構建一套「多維度權重疊加模型」。

---

### 1. 解答你的疑惑：「某個值」是什麼？

在 Roguelite 遊戲中，這個值通常稱為 **「氣運值」(Luck/Fortune)**。

- **來源**：它由「初始天賦」、「特定遺物效果」與「難度係數」動態聚合而成 。

- **用途**：它不直接扣除，而是作為**權重修飾符 (Weight Modifier)**，提升高稀有度物品在池子裡的「佔比」 。

---

### 2. 改良後的「大一統生成流程」：分層機率篩選

不要在第一步就決定稀有度總額，而是採用「先定位置，再定內容，最後修飾數值」的流水線。

#### 第一階段：位置槽位定義 (Slot Allocation)

- 商店刷新時，根據配置確定 6 個 Slot 。

- 每個 Slot 根據預設機率骰出 `ItemType` (裝備 35%、寶石 5%、遺物 60%)。

#### 第二階段：動態權重計算 (Dynamic Weight Rolling)

這是最核心的步驟，解決你提到的「火標籤提高、冰降低」以及「傳奇中的傳奇」：

- **基礎權重 (Base Weight)**：每個物品模板 (Template) 自帶權重 。

- 普通：1000, 稀有：100, 傳奇：10, 史詩級傳奇：1。

- **全局修飾 (Global Modifiers)**：
- `FinalWeight = BaseWeight * (1 + Luck/100)`。

- **標籤修飾 (Tag Modifiers)**：
- 檢查 `RunContext` 中的 `WeightModifiers` 陣列 。

- 若玩家擁有「火焰附魔」遺物，則 `TAG_FIRE` 的所有物品權重再乘以 2 。

#### 第三階段：加權隨機抽樣 (Weighted Random Sampling)

- **避免無窮迴圈**：使用 **「權重區間演算法」**。

1. 將符合條件（符合 Slot 類型與等級限制）的物品權重加總，得到 。
2. 產生一個 到 之間的隨機數。
3. 遍歷列表，看隨機數落在哪個物品的權重區間內。
4. 這是一次性運算，複雜度為 ，絕不會死循環 。

---

### 3. 如何處理「稀有度平衡」 (解決你的第 5 點)

與其強行消化總額，不如使用 **「保底與品質提升」機制**：

- **品質保證 (Pity System)**：如果商店前五格都是「普通」，第六格強制套用一個 `Force_High_Rarity` 標籤，過濾掉所有低階物品再進行 Roll 。

- **遺物連鎖**：某些遺物可以規定「商店必定出現至少一個傳奇裝備」，這是在 Roll 之前就插入的強制過濾條件 。

---

### 4. 借鑑其他遊戲的實踐

- **Hades (神力引導)**：當你拿了一個波賽頓的技能，系統會提高後續所有波賽頓相關獎勵的出現機率 。我們透過 `RunContext` 中的標籤權重實現。

- **TFT (等級機率表)**：根據玩家當前的等級（或關卡進度），動態切換不同稀有度的出現機率矩陣 。

---

### 5. 架構師的實作建議

我建議建立一個 `ItemGenerator` 服務，它只負責一件事情：**「輸入 Context 與篩選條件，輸出物品實例」** 。

```typescript
// 簡化邏輯概念
class ItemGenerator {
  generate(context: RunContext, criteria: IGenerationCriteria): ItemInstance {
    // 3. 計算每個候選物品的最終 Weight
    // 4. 執行加權隨機 Roll
    ;[cite_start][cite_start][cite_start] // 1. 從 Pool 撈出候選名單 [cite: 10] // 2. 獲取當前所有的權重修正規則 (來自難度、遺物、賽前變數) [cite: 6, 9] // 5. 實例化物品並 Roll 詞綴數值 [cite: 7]
  }
}
```

這樣設計的好處是：**高內聚、低耦合** 。未來你想調整「火系出現率」，只需要在 `RunContext` 裡塞入一個規則，不需要動到核心生成的程式碼。

**接下來，您想先定義「物品權重表」的 JSON 結構，還是我們先處理「屬性聚合系統」如何讀取這些生成的裝備詞綴？**
