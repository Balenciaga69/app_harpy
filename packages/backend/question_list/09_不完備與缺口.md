# 不完備與缺口

## 1. 異常狀態系統的細節缺口 ⚠️

### 問題

ailment.blueprint.md 狀態處理流程**僅粗略描述**

每 Tick 觸發與清除，但未定義：

- 疊層計算規則
- 清除條件細節
- 多來源衝突時的優先級

### 缺口案例

```
問題 1：多個冰緩怎麼疊？
- 第一個 Chill 叠層？
- 還是刷新持續時間？
- 還是取最強的？
- 結果完全不同

問題 2：狀態清除規則
- 是自動清除？
- 還是觸發清除事件？
- 清除時是否觸發 ON_STATUS_REMOVED？
- 多個狀態同時清除的順序？

問題 3：狀態衝突
- 冰緩 vs 灼燒（互斥嗎？）
- 多個 Debuff 堆疊上限？
- 優先級怎麼定？
```

### 風險

**導致開發時需要自行補充規則**

- 開發者猜測，容易產生 bug
- 平衡調整時需要反覆確認
- 不同開發者實現可能不一致

### 建議

補充 ailment.blueprint.md：

```typescript
// 明確定義
interface StatusStackingRule {
  // 可疊層？
  stackable: boolean

  // 若可疊層，最多幾層？
  maxStacks?: number

  // 新狀態入場時
  onNewStack: 'refresh' | 'add' | 'max' | 'accumulate'

  // 若 onNewStack = 'refresh'，刷新時間？
  refreshDuration?: number

  // 互斥的狀態
  excludedStatuses: StatusId[]

  // 優先級（高優先級保留）
  priority: number
}

// 清除規則
interface StatusRemovalRule {
  // 自動清除條件
  autoRemoveWhen?: {
    duration: number // 持續時間
    onEvent?: EventType // 或事件觸發
  }

  // 是否觸發事件
  triggerOnRemove: boolean

  // 清除時的順序規則
  removalOrder: 'fifo' | 'priority' | 'duration'
}

// 衝突解決
interface StatusConflictRule {
  // 衝突時保留誰
  winner: 'highest' | 'lowest' | 'newest' | 'oldest' | 'priority'

  // 被替換的狀態是否觸發移除事件
  triggerRemovalForLoser: boolean
}
```

---

## 2. 異常狀態機制仍在構思（過時）⚠️

### 問題

combat.blueprint.md 提及**異常狀態機制仍在構思，可能大改**

### 缺陷

- 缺完整定義
- **阻礙戰鬥系統實現**
- 開發者無所適從

### 標記

- **(過時)** - 需要明確最終決定

---

## 3. Minion 系統的缺口 ⚠️

### 問題

creature.blueprint.md 區分 **Unit 與 Minion**

但未說明 Minion 的具體：

- 屬性聚合規則
- 事件處理方式

### 缺口案例

```
? Minion 如何聚合屬性？
  - 繼承召喚者的修飾？
  - 有獨立 Affix 嗎？
  - 獨立 Affix 與召喚者 Affix 衝突時？

? Minion 事件
  - ON_MINION_DAMAGED
  - 觸發召喚者的 Affix 嗎？
  - 還是只觸發 Minion 自己的 Affix？

? Minion 生命週期
  - 召喚者死亡，Minion 死亡嗎？
  - 召喚者逃脫，Minion 怎麼辦？
```

### 風險

**缺口影響召喚物邏輯**

難以實現彙總效果（Minion 的傷害計入召喚者？）

### 建議

補充 creature.blueprint.md，定義 Minion 的完整行為模型

---

## 4. 權重修飾的結構缺口 ⚠️

### 問題

generator-weight.blueprint.md 描述**權重修飾來自系統初始化或事件**

但未定義：

- 具體 JSON 結構
- 應用規則
- 衝突時的優先級

### 缺口案例

```json
// 誰知道結構是什麼？
{
  "affixWeights": {
    "version": 1,
    "modifiers": [
      {
        "affixId": "chill",
        "type": "multiply",
        "value": 1.5,
        "condition": "endless && floor > 50"
      }
    ]
  }
}

// 問題：
// - version 字段什麼用途？
// - condition 誰解析？
// - 多個修飾時怎麼組合？
// - JSON 層級結構？
```

### 風險

**開發時需要補充**

前後端可能對結構理解不同，導致序列化失敗

### 建議

補充 generator-weight.blueprint.md：

```typescript
// 明確結構
interface AffixWeightModifier {
  version: '1.0'
  modifiers: Array<{
    id: string // 唯一識別
    affixId: string
    application: 'multiply' | 'add' | 'replace' | 'filter'

    // 修飾值
    value?: number
    weights?: Record<string, number>
    tags?: {
      include?: string[]
      exclude?: string[]
    }

    // 應用條件
    condition: {
      chapter?: number
      difficulty?: number
      mode?: GameMode
      floor?: { min?: number; max?: number }
    }

    // 優先級（高優先級後應用，可覆蓋）
    priority: number
  }>
}

// 應用規則
function applyWeightModifiers(pool: AffixPool, modifiers: AffixWeightModifier['modifiers']): AffixPool {
  // 按優先級排序
  const sorted = modifiers.sort((a, b) => a.priority - b.priority)

  let result = { ...pool }

  for (const modifier of sorted) {
    result = applyModifier(result, modifier)
  }

  return result
}
```

---

## 5. 獎勵系統的生成邏輯缺口 ⚠️

### 問題

post-combat.blueprint.md 戰勝生成**兩個獎勵組合包**

但未說明：

- reward item 內容生成邏輯
- 組合包的選擇規則
- 玩家怎麼選

### 缺口案例

```
? 獎勵組合包如何生成？
  - 隨機抽取？
  - 基於難度？
  - 基於玩家進度？

? Reward Item 內容
  - 金幣？裝備？遺物？技能？
  - 如何決定類型？
  - 每個包有幾項？

? 玩家選擇
  - 選不同的包有區別嗎？
  - 還是都是隨機內容，只是演出不同？
```

### 風險

**缺口導致獎勵系統不完整**

無法實現運營活動（如「選項 A 必定掉落 X」）

### 建議

補充 post-combat.blueprint.md，定義獎勵生成管道

---

## 6. Ultimate Gem 系統的平衡缺口 ⚠️

### 問題

ultimate.blueprint.md 附魔石結構與流程描述

但未定義：

- 詞綴池的權重
- 詞綴限制
- 附魔上限

### 缺口案例

```
? 附魔詞綴池
  - 與物品詞綴池相同嗎？
  - 還是完全獨立？
  - 有專屬詞綴嗎？

? 附魔限制
  - 每個 Gem 最多附幾個詞綴？
  - 不同稀有度限制不同嗎？

? 平衡考慮
  - Ultimate Gem 會因附魔變得太強嗎？
  - 有上限控制嗎？
```

### 風險

**缺口影響平衡性設計**

無法預測 Ultimate Gem 的最大威力

### 建議

補充 ultimate.blueprint.md，定義詞綴限制與平衡規則

---

## 7. 核心遺漏：不同系統間的資料流 ⚠️

### 缺口

藍圖沒有定義系統間的整合管道

- 詞綴 → 屬性聚合 → 傷害計算 → 事件觸發
- 誰負責轉換？
- 轉換失敗時怎麼辦？

### 建議

補充「核心資料流藍圖」，畫出所有系統的信息傳遞路徑

---

## 標記

- 總體：缺口與過時標籤分布廣泛
- 優先級：先補齊核心系統（狀態、權重、獎勵），再補齊邊界系統（Minion、Gem）
