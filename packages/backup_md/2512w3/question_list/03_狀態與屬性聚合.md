# ç‹€æ…‹èˆ‡å±¬æ€§èšåˆç³»çµ±

## 1. Combat Tick æµç¨‹ï¼šé‚è¼¯é †åºæ¼‚äº®ï¼Œä½†æœ‰ä¸€å€‹è‡´å‘½æ¼æ´ ğŸ”´

### ç•¶å‰è¨­è¨ˆ

ä½ ç¾åœ¨çš„ Tick é †åºæ˜¯ï¼š

1. è¡Œç‚ºè½‰ Event
2. Event è™•ç†ï¼ˆå‚·å®³ï¼‰
3. ç‹€æ…‹ç³»çµ±
4. å±¬æ€§èšåˆ
5. ç”Ÿæ­»åˆ¤å®š

### è‡´å‘½å•é¡Œï¼šå±¬æ€§å¿«ç…§çš„æ™‚é–“é»ä¸æ˜ç¢º

**ä½ åœ¨ç¬¬ 2 æ­¥ç”¨çš„æ˜¯å“ªä¸€ç‰ˆå±¬æ€§ï¼Ÿ**

å› ç‚ºä½ èªªï¼š

- ç‹€æ…‹æœƒå½±éŸ¿å±¬æ€§
- ä½†å±¬æ€§æ˜¯ç¬¬ 4 æ­¥æ‰èšåˆ

é‚£è«‹å•ï¼š

- Damage Event åœ¨ç¬¬ 2 æ­¥è¨ˆç®—æ™‚ï¼š
  - ç”¨çš„æ˜¯ä¸Šä¸€ Tick çš„å±¬æ€§ï¼Ÿ
  - é‚„æ˜¯ã€Œå³æ™‚ç‹€æ…‹ä¿®æ”¹å¾Œçš„å±¬æ€§ã€ï¼Ÿ

**é€™ä¸æ˜¯ç´°ç¯€ï¼Œæ˜¯æ ¸å¿ƒä¸€è‡´æ€§å•é¡Œ**

### æ¥µç«¯æ¡ˆä¾‹ï¼ˆä¸€å®šæœƒé‡åˆ°ï¼‰

å ´æ™¯ï¼šåŒä¸€ Tick å…§å¤šæ®µå‚·å®³

```
// æ™‚åº
Event 1: æ”»æ“Š A å‘½ä¸­ æ•µäºº
  -> ON_HIT è§¸ç™¼ â†’ APPLY_CHILLï¼ˆé™ä½é˜²ç¦¦ 20%ï¼‰

Event 2: æ”»æ“Š B å‘½ä¸­ æ•µäººï¼ˆåŒä¸€ Tickï¼‰
  -> å‚·å®³è¨ˆç®—ç”¨æ•µäººé˜²ç¦¦
  -> å•é¡Œï¼šæœ‰æ²’æœ‰åƒåˆ° Chill çš„ -20% é˜²ç¦¦ï¼Ÿ
```

ç¾åœ¨çš„æè¿°å…©ç¨®è§£é‡‹éƒ½èªªå¾—é€š â†’ **è¨­è¨ˆä¸å®Œæ•´**

### å…¶ä»–æ¥µç«¯æ¡ˆä¾‹

**æ¡ˆä¾‹ Bï¼šç‹€æ…‹æ¸…é™¤èˆ‡å‚·å®³è¨ˆç®—çš„äº¤å‰**

```
Event 1: æ•µäººé˜²ç¦¦é™ä½ 50%ï¼ˆDEBUFF_DEFENSEï¼‰
Event 2: åŒä¸€ Tickï¼Œæ•µäººæ¢å¾©ï¼ˆCLEANSEï¼‰æ¸…é™¤ Debuff
Event 3: æ•µäººå—åˆ°å‚·å®³ï¼ˆåŒä¸€ Tickï¼‰
  -> å‚·å®³ç”¨çš„æ˜¯æœ‰/æ²’æœ‰ Debuff çš„é˜²ç¦¦ï¼Ÿ
```

**æ¡ˆä¾‹ Cï¼šå±¬æ€§ä¿®é£¾éˆ**

```
Status A é™ä½æ”»æ“Š 20%
Affix B åŸºæ–¼ã€Œç•¶å‰æ”»æ“Šã€æå‡å‚·å®³ 30%

Tick å…§è¨ˆç®—é †åºï¼š
- å…ˆå¥— Statusï¼Ÿçµæœ = åŸºç¤æ”»æ“Š * 0.8
- å†å¥— Affix Bï¼Ÿçµæœ = (åŸºç¤æ”»æ“Š * 0.8) * 1.3
- é‚„æ˜¯åéä¾†ï¼Ÿ
```

### è§£æ±ºæ–¹æ¡ˆï¼šé¸ä¸€å€‹ä¸¦æ–‡æª”åŒ–

**æ–¹æ¡ˆ Aï¼ˆæ¨è–¦ï¼‰ï¼šSnapshot Stats**

```
Tick é–‹å§‹æ™‚é–å®š Snapshot
  Tick é–‹å§‹
  â””â”€> èšåˆæ‰€æœ‰ Stat
  â””â”€> å¿«ç…§å­˜èµ·ä¾†
  â””â”€> æ‰€æœ‰ Event ä½¿ç”¨é€™ä»½å¿«ç…§
  â””â”€> Event ç”¢ç”Ÿçš„ç‹€æ…‹è®ŠåŒ–
      åªåœ¨ã€Œä¸‹ä¸€å€‹ Tickã€ç”Ÿæ•ˆ
```

**å„ªé»ï¼š**

- ä¸€è‡´æ€§æœ€å¼·
- æ˜“æ–¼ debug èˆ‡é‡æ’­
- æ˜“æ–¼å‰ç«¯å‹•ç•«åŒæ­¥

**ç¼ºé»ï¼š**

- å›æ‡‰æ€§å·®ï¼ˆç‹€æ…‹æ»¯å¾Œä¸€ Tickï¼‰

**æ–¹æ¡ˆ Bï¼ˆè¤‡é›œï¼‰ï¼šå³æ™‚èšåˆ**

```
æ¯å€‹ Event å‰é‡æ–°èšåˆä¸€æ¬¡
  Event A
  â””â”€> èšåˆ Statï¼ˆåŒ…æ‹¬ Event A ç”¢ç”Ÿçš„ç‹€æ…‹ï¼‰
  â””â”€> è¨ˆç®— Damage
  Event B
  â””â”€> é‡æ–°èšåˆ Statï¼ˆåŒ…æ‹¬å‰é¢çš„ç‹€æ…‹è®ŠåŒ–ï¼‰
  â””â”€> è¨ˆç®— Damage
```

**å„ªé»ï¼š**

- åæ‡‰å¿«ï¼ˆç‹€æ…‹ç«‹å³ç”Ÿæ•ˆï¼‰

**ç¼ºé»ï¼š**

- æ€§èƒ½é–‹éŠ·å¤§
- é‚è¼¯è¤‡é›œï¼Œæ˜“å‡º bug
- é‡æ’­æ™‚çµæœå®¹æ˜“ä¸åŒæ­¥

### å»ºè­°

**å¼·çƒˆæ¨è–¦ Snapshot Stats æ–¹æ¡ˆ**

æ˜ç¢ºå¯«å…¥ combat.blueprint.mdï¼š

```
æ¯å€‹ Tickï¼š
1. æ™‚åˆ» T0ï¼šèšåˆ Unit æ‰€æœ‰å±¬æ€§ â†’ Snapshot
2. æ™‚åˆ» T1-T9ï¼šæ‰€æœ‰ Event ä½¿ç”¨ T0 Snapshot
3. æ™‚åˆ» T10ï¼šEvent ç”¢ç”Ÿçš„ç‹€æ…‹è®ŠåŒ–æ‡‰ç”¨åˆ°ä¸‹ä¸€ Tick
4. æ™‚åˆ» T11ï¼ˆä¸‹ä¸€ Tickï¼‰ï¼šé‡æ–°èšåˆåŸºæ–¼æ–°ç‹€æ…‹
```

---

## 2. å±¬æ€§èšåˆèˆ‡ç‹€æ…‹å½±éŸ¿çš„å¿«ç…§è¦å‰‡æœªæ˜ç¢º âš ï¸

### å•é¡Œ

stat.blueprint.mdã€combat.blueprint.md éƒ½å¼·èª¿ã€Œå±¬æ€§èšåˆã€èˆ‡ã€Œç‹€æ…‹å½±éŸ¿ã€ï¼Œä½†æ²’æœ‰æ˜ç¢ºå®šç¾©ï¼š

- ä½•æ™‚èšåˆï¼Ÿ
- èšåˆçµæœå¿«ç…§æ˜¯å¦è²«ç©¿æ•´å€‹ Tickï¼Ÿ

### é¢¨éšª

- æœƒç”¢ç”Ÿã€ŒåŒä¸€ Tick å…§å±¬æ€§å‰å¾Œä¸ä¸€è‡´ã€çš„ bug
- å°¤å…¶åœ¨å¤šæ®µæ”»æ“Šã€é€£é–äº‹ä»¶ä¸‹æ›´åš´é‡
- å‰ç«¯é‡æ’­èˆ‡å¾Œç«¯é‹ç®—çµæœå¯èƒ½ä¸ä¸€è‡´

### ç¼ºé™·

shit.md å·²æŒ‡å‡ºé€™æœƒå°è‡´å‚·å®³è¨ˆç®—ã€ç‹€æ…‹ç–ŠåŠ ç­‰æµç¨‹å‡ºç¾ä¸ä¸€è‡´

ç›®å‰æ²’æœ‰æ˜ç¢ºçš„ã€Œå±¬æ€§å¿«ç…§ã€ç­–ç•¥ï¼Œæœƒå°è‡´åŒä¸€ Tick å…§å±¬æ€§è®Šå‹•é›£ä»¥è¿½è¹¤

### å»ºè­°

è£œå…… combat.blueprint.mdï¼š

- å…·é«”æµç¨‹åœ–æˆ–æ™‚åºåœ–
- å¿«ç…§æ™‚é–“é»çš„ç²¾ç¢ºå®šç¾©
- å¤šæ®µäº‹ä»¶å…§å±¬æ€§ç”¨æ³•çš„ä¾‹ç¤º

---

## 3. Affix/Status/Modifier ä¸‰è€…é‚Šç•Œæ¨¡ç³Šï¼Œç¼ºä¹çµ±ä¸€è§£æç®¡é“ ğŸ”„

### å•é¡Œ

Affixã€Statusã€Modifier éƒ½æœƒå½±éŸ¿å±¬æ€§

ä½†ç›®å‰è§£ææµç¨‹åˆ†æ•£æ–¼å¤šå€‹è—åœ–ï¼Œ**æ²’æœ‰ä¸€å€‹ã€Œçµ±ä¸€çš„è§£æ/èšåˆç®¡é“ã€**

Status å…¶å¯¦å°±æ˜¯ã€Œæœ‰æ™‚æ•ˆçš„ Modifier å®¹å™¨ã€ï¼Œä½†ç›®å‰è—åœ–æœªå¼·åˆ¶çµ±ä¸€

**å°è‡´èšåˆé‚è¼¯é‡è¤‡ã€ç¶­è­·å›°é›£**

### è§£ææµç¨‹æ··äº‚æ¡ˆä¾‹

```
// èª°è² è²¬é€™äº›è½‰æ›ï¼Ÿ
Equipment â†’ AffixTemplate â†’ AffixInstance â†’ Modifier[]
Status â†’ StatusTemplate â†’ StatusInstance â†’ Modifier[]
PreCombat Variable â†’ ??? â†’ Modifier[]

// æœ€å¾Œèª°èšåˆï¼Ÿ
Modifiers[] â†’ StatAggregation â†’ FinalStat

// èšåˆé‚è¼¯ï¼š
â”œâ”€ å“ªäº› Modifier å…ˆå¥—ï¼Ÿ
â”œâ”€ å„ªå…ˆç´šæ€éº¼å®šï¼Ÿ
â”œâ”€ è¡çªæ™‚æ€éº¼è¾¦ï¼ˆå¤šå€‹ Multiï¼‰ï¼Ÿ
â””â”€ æ–°ä¾†æºæ™‚èª°æ”¹ä»£ç¢¼ï¼Ÿ
```

### é¢¨éšª

- æ–°å¢/ä¿®æ”¹ Affix æˆ– Status æ™‚ï¼Œå®¹æ˜“éºæ¼å°æ‡‰çš„èšåˆé‚è¼¯ â†’ ç”¢ç”Ÿéš±è— bug
- æ¸¬è©¦æ™‚é›£ä»¥è¦†è“‹æ‰€æœ‰ä¾†æºçš„ Modifier
- ç¶­è­·æˆæœ¬é«˜ï¼Œæ¯æ¬¡æ“´å±•éƒ½è¦æª¢æŸ¥å¤šå€‹åœ°æ–¹

### å»ºè­°

**æ‡‰è£œå……ä¸€ä»½ã€ŒModifier èšåˆè—åœ–ã€**

æ˜ç¢ºè¦å®šæ‰€æœ‰ä¾†æºï¼ˆAffix/Status/è³½å‰è®Šæ•¸ç­‰ï¼‰éƒ½å¿…é ˆç¶“éåŒä¸€è§£æç®¡é“

```typescript
// ç¯„ä¾‹æ¶æ§‹ï¼ˆå½ä»£ç¢¼ï¼‰

// Step 1: æ”¶é›†æ‰€æœ‰ Modifier ä¾†æº
interface ModifierSource {
  equipmentAffixes: AffixInstance[]
  statusEffects: StatusInstance[]
  skillModifiers: Modifier[]
  preCombatVariables: PreCombatModifier[]
  // ... å…¶ä»–ä¾†æº
}

// Step 2: çµ±ä¸€è§£æ
function parseAllModifiers(source: ModifierSource): Modifier[] {
  return [
    ...parseAffixes(source.equipmentAffixes),
    ...parseStatuses(source.statusEffects),
    ...source.skillModifiers,
    ...parsePreCombat(source.preCombatVariables),
  ]
}

// Step 3: çµ±ä¸€èšåˆ
function aggregateStats(modifiers: Modifier[]): FinalStats {
  const added = modifiers.filter((m) => m.type === 'Added').reduce((sum, m) => sum + m.value, 0)

  const multi = modifiers.filter((m) => m.type === 'Multi').reduce((prod, m) => prod * m.value, 1)

  return {
    // èšåˆè¦å‰‡æ˜ç¢ºå®šç¾©
    finalValue: (baseValue + added) * multi,
  }
}
```

**å¥½è™•ï¼š**

- ä¸€å€‹åœ°æ–¹å®šç¾©èšåˆè¦å‰‡
- æ–°ä¾†æºåªéœ€å¯¦ç¾ parseXxx() å‡½æ•¸
- æ˜“æ–¼æ¸¬è©¦
- æ˜“æ–¼ç¶­è­·

---

## 4. Status æ˜¯ã€Œå¦ä¸€ç¨® Modifierã€çš„è¨­è¨ˆçµ±ä¸€

### æè­°

ç”±æ–¼ Status èˆ‡ Affix éƒ½æ˜¯ã€Œæœ‰ä¾†æºã€æœ‰æ•¸å€¼ã€å½±éŸ¿å±¬æ€§ã€å½±éŸ¿è¡Œç‚ºã€çš„æ±è¥¿

å·®åˆ¥åªå‰©ã€Œæ˜¯å¦æœ‰ durationã€

### å»ºè­°çµ±ä¸€çµæ§‹

```typescript
// çµ±ä¸€çš„ä¿®é£¾ä¾†æº
interface Modifier {
  source: 'equipment' | 'status' | 'skill' | 'preCombat'
  sourceId: string
  type: 'Added' | 'Multi' | 'More'
  value: number

  // å¯é¸ï¼šæ™‚é–“é™åˆ¶
  duration?: {
    remainingTicks: number
    maxTicks: number
  }

  // å¯é¸ï¼šç”Ÿæ•ˆæ¢ä»¶
  condition?: () => boolean
}

interface StatAggregationResult {
  baseValue: number
  appliedModifiers: Modifier[]
  finalValue: number
}
```

**é€™æ¨£ï¼š**

- å±¬æ€§èšåˆç³»çµ±ä¸ç”¨å€åˆ† Affix æˆ– Status
- éƒ½æ˜¯çµ±ä¸€è™•ç†çš„ Modifier
- æ˜¯å¦æœ‰ duration åªæ˜¯ä¸€å€‹å¯é¸æ¬„ä½

---

## æ¨™è¨˜

- æ ¸å¿ƒå•é¡Œï¼šå±¬æ€§èšåˆå¿«ç…§ + çµ±ä¸€è§£æç®¡é“
- å„ªå…ˆç´šï¼šğŸ”´ é«˜ - å½±éŸ¿æˆ°é¬¥çµæœä¸€è‡´æ€§
- ç›¸ä¾æ¨¡çµ„ï¼šæˆ°é¬¥ç³»çµ±ã€äº‹ä»¶ç³»çµ±ã€è©ç¶´ç³»çµ±ã€ç‹€æ…‹ç³»çµ±
