# 🎮 Combat 系統遊戲性深度解析

> **視角**：遊戲設計師 / 系統策劃  
> **核心概念**：自動戰鬥 (Auto-Battler)、Tick 驅動仿真、元素反應、深度屬性交互

---

## ⚔️ 戰鬥系統核心能力總覽

目前的戰鬥架構不僅僅是一個簡單的「你打我一下，我打你一下」的回合制系統，而是一個**高精度的時間驅動仿真引擎**。它能夠支撐起類似《TFT 聯盟戰棋》、《Dota Auto Chess》或是《放置奇兵》這類遊戲的核心戰鬥體驗。

### 1. 核心機制：Tick 驅動的半即時戰鬥

- **非傳統回合制**：不是「輪流行動」，而是基於時間軸 (Tick) 的並行運作。
- **攻速概念**：每個角色有獨立的 `attackCooldown`。刺客可能 1 秒打 3 下，重甲戰士可能 2 秒打 1 下。
- **動態節奏**：戰鬥過程是流動的，Buff/Debuff 的持續時間、冷卻時間都精確到 Tick，允許極限操作（如在攻擊前一瞬間上盾）。

### 2. 深度傷害計算 (The 8-Step Pipeline)

傷害不再是一個簡單的減法公式，而是一條完整的流水線，允許遊戲設計師在任何環節介入：

- **命中判定 (Hit Check)**：閃避流 (Evasion) 的基礎。
- **暴擊判定 (Critical)**：暴擊流 (Crit Build) 的核心。
- **傷害修正 (Modify)**：百分比增傷、屬性剋制。
- **防禦計算 (Defense)**：護甲減免、穿透機制。
- **最終應用 (Apply)**：護盾吸收、無敵狀態。

### 3. 元素與異常狀態系統 (Elemental & Status)

系統原生支持多種元素與狀態交互，這為「流派 (Build)」提供了基礎：

- **🔥 火 (Fire)**：可觸發 `HolyFire` (神聖之火)，造成持續傷害或爆炸。
- **❄️ 冰 (Ice)**：可觸發 `Chill` (冰緩)，降低攻速或行動力。
- **⚡ 雷 (Lightning)**：可觸發 `Charge` (充能)，增加暴擊或連鎖傷害。
- **☠️ 毒 (Poison)**：可堆疊的 DoT (持續傷害)，層數越高傷害越高，且具備衰減機制。
- **🌀 混沌 (Chaos)**：無視防禦或特殊效果。

### 4. 高度可擴展的「效果 (Effect)」系統

這是遊戲性的靈魂。效果不僅僅是數值加減，它是**邏輯的載體**：

- **被動技能**：如「低血量自動加防」（已實現為 `LowHealthArmorEffect`）。
- **裝備特效**：如「充能暴擊」（`ChargedCriticalEffect`）。
- **狀態異常**：中毒、燃燒、冰凍。
- **光環**：全隊加攻、敵方減速（通過 EffectManager 實現）。

---

## 🎬 戰鬥場景想像 (Scenarios)

為了讓你更有畫面感，我們來模擬幾個目前架構**已經可以實現**（或只需極少配置）的戰鬥場景：

### 案例 A：重裝坦克 vs. 劇毒刺客

> **場景**：一個高護甲、高血量的騎士，對決一個攻擊力低但攻速極快的盜賊。

- **戰鬥過程**：
  1.  **盜賊**攻速極快，每 20 ticks 攻擊一次。雖然單次物理傷害被**騎士**的高防禦減免到幾乎為 0。
  2.  但盜賊的武器塗了毒（`PoisonEffect`）。每次攻擊都在騎士身上疊加一層毒。
  3.  **騎士**攻速慢，每 60 ticks 才揮一劍，雖然傷害高，但盜賊有閃避率（`HitCheckStep` 生效），偶爾會 Miss。
  4.  隨著時間推移，騎士身上的毒層數疊加到 50 層。毒傷無視護甲（`PoisonEffect` 邏輯），騎士血量開始像瀑布一樣狂掉。
  5.  **結果**：騎士在揮出致命一擊前，被毒素攻心而死。
- **展現能力**：攻速差異、防禦減免、異常狀態堆疊、無視防禦傷害。

### 案例 B：絕境反擊的狂戰士

> **場景**：一個戰士，血量越低越強。

- **戰鬥過程**：
  1.  戰士開場被圍毆，血量迅速下降到 30%。
  2.  觸發被動效果 `LowHealthArmorEffect`（Hook 機制介入 `DefenseCalculationStep`），防禦力瞬間暴增，受到的傷害大幅降低。
  3.  同時觸發另一個效果「狂怒」（假設效果），攻擊力提升 50%。
  4.  戰士一刀暴擊（`CriticalStep`），配合吸血效果（Hook 介入 `AfterApplyStep`），瞬間將血量拉回安全線。
- **展現能力**：動態屬性修正、生命週期鉤子 (Hooks)、條件觸發機制。

### 案例 C：元素法師的連鎖反應

> **場景**：法師先手冰凍，後手雷擊。

- **戰鬥過程**：
  1.  法師發射冰箭（Ice Damage），觸發 `ChillEffect`，敵人動作變慢（修改 `attackCooldown` 屬性）。
  2.  法師緊接著發射雷擊（Lightning Damage）。
  3.  系統中的 `ElementEffectRegistry` 判定雷擊觸發 `ChargeEffect`。
  4.  假設我們有一個自定義效果：當「雷」打在「冰」上時，觸發「超導」反應，造成額外物理傷害並破甲。
- **展現能力**：元素交互、狀態依賴、多重傷害類型。

---

## 💬 Q&A：深度挖掘遊戲性潛力

以下我將扮演**遊戲製作人**，向你（系統架構師）提問，以挖掘這個系統的極限。

### Q1: 這個系統能做「裝備系統」嗎？比如穿上一件「荊棘之甲」？

**A: 完全可以，而且非常簡單。**
在我們的架構中，裝備 (Equipment) 本質上就是一個 **Effect (效果)** 的集合。

- **荊棘之甲**：就是一個 Effect。
- **實現方式**：它會註冊一個 Hook 到 `AfterApplyStep`（傷害應用後）。
- **邏輯**：當角色受到近戰傷害時，讀取傷害值，反彈 x% 給攻擊來源（`context.eventBus.emit('entity:damage', ...)`）。
- **遊戲性**：玩家穿上裝備 = 角色 `addEffect`。脫下裝備 = 角色 `removeEffect`。

### Q2: 能不能做「吸血 (Life Steal)」或者「斬殺 (Execute)」？

**A: 是的，這都在 Damage Pipeline 的管轄範圍內。**

- **吸血**：
  - 這是一個 Effect，Hook 在 `AfterApplyStep`。
  - 邏輯：如果是我造成的傷害，則 `source.setCurrentHpClamped(current + damage * rate)`。
- **斬殺**：
  - 這是一個 Effect，Hook 在 `DamageModifyStep`（傷害修正）。
  - 邏輯：檢查目標 `currentHp / maxHp < 0.2`？如果是，`damageEvent.damages.physical *= 100`（造成巨額傷害）。

### Q3: 目前是自動戰鬥，能加入「主動技能 (Active Skills)」嗎？比如玩家點擊釋放的大招？

**A: 架構上已經支持，只需接上輸入信號。**

- 目前 `AbilitySystem` 是自動監聽 `tick` 來觸發普攻。
- **實現主動技**：
  1.  在 `Character` 上新增 `skills` 列表。
  2.  新增一個 `CastSkillCommand`。
  3.  當玩家點擊按鈕 -> 發送指令 -> 系統檢查冷卻與魔力 (MP) -> 執行 `DamageChain` 或施加 `Effect`。
- **想像**：這可以變成像《刀塔傳奇》那樣，普攻自動，大招手動的遊戲。

### Q4: 能做「光環 (Aura)」類技能嗎？比如隊長在場，全員加攻？

**A: 可以，利用 EffectManager 的 Tick 更新機制。**

- **實現**：
  - 隊長身上有一個 `LeaderAuraEffect`。
  - 在 `onTick` 中，它會掃描 `context.getEntitiesByTeam(myTeam)`。
  - 給範圍內的隊友施加一個臨時的 `BuffEffect`（持續 1 tick）。
  - 或者，更高效的做法是：隊長入場時給所有人加 Buff，離場時移除。

### Q5: 這個系統能支持「子彈時間」或「時間暫停」嗎？

**A: 這是 Tick 驅動系統的天然優勢。**

- 因為所有邏輯都依賴 `TickerDriver`。
- **時間暫停**：只需暫停 `TickerDriver`，或者在 `AbilitySystem` 中跳過所有人的行動邏輯，但允許特定角色行動。
- **子彈時間**：雖然 Tick 是離散的，但我們可以通過調整「渲染幀率」與「邏輯 Tick 率」的比例，或者簡單地讓所有人的 `Cooldown` 變長，唯獨主角不變，來模擬相對的時間變慢。

### Q6: 如果我想做一個 50 vs 50 的軍團戰，這系統撐得住嗎？

**A: 從邏輯層面沒問題，效能層面需要優化。**

- **邏輯**：`CombatContext` 管理實體列表，`AbilitySystem` 遍歷實體。50 vs 50 只是陣列變大而已。
- **瓶頸**：目前的 `O(N)` 遍歷在 N=100 時毫無壓力。但如果每個人身上有 20 層 Buff，每 tick 都要更新，計算量會增加。
- **解決**：我們之前提到的「髒標記 (Dirty Flag)」優化就是為了應對這種大規模戰鬥。

### Q7: 能不能做「地形」或「天氣」影響？比如下雨天火屬性傷害降低？

**A: 非常容易，這是「全局 Effect」的概念。**

- **天氣**：其實就是一個施加在 `CombatContext` 或所有角色身上的 `GlobalEffect`。
- **下雨**：
  - 創建一個 `RainWeatherEffect`。
  - Hook 進 `DamageModifyStep`。
  - 邏輯：如果 `damageEvent.type === 'fire'`，則 `damage *= 0.5`；如果 `type === 'lightning'`，則 `damage *= 1.5`。
- **遊戲性**：這讓戰鬥策略從單純的「選人」擴展到了「選戰場」。

---

## 🎯 總結：這是一個什麼樣的戰鬥系統？

從遊戲設計角度來看，這是一個**「數值驅動、規則深度、高自由度」**的仿真沙盒。

- 它**不是**動作遊戲 (Action Game) 的物理碰撞引擎。
- 它**是** RPG/策略遊戲 (Strategy RPG) 的理想基石。

它最適合用來製作：

1.  **複雜的 RPG**（如《Path of Exile》風格的數值構建）。
2.  **自動戰鬥遊戲**（如《TFT》）。
3.  **策略模擬遊戲**（如《Domina》角鬥士管理）。

它的核心樂趣在於**「構建 (Build)」**——通過組合屬性、裝備、效果和隊伍搭配，在複雜的規則下尋找最優解。
