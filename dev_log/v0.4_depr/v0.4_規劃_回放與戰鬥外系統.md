# v0.4 è¦åŠƒï¼šå›æ”¾ç³»çµ±èˆ‡æˆ°é¬¥å¤–å¾ªç’°è¨­è¨ˆ

> **æ—¥æœŸ**: 2025-12-01
> **ç‹€æ…‹**: è¦åŠƒä¸­
> **ç›®æ¨™**: å®šç¾©å›æ”¾ç³»çµ±çš„åŠŸèƒ½éœ€æ±‚ï¼Œä¸¦ç¢ºç«‹æˆ°é¬¥å¤–çš„éŠæˆ²å¾ªç’°æµç¨‹ (Meta-game Loop)ã€‚

---

## 1. å›æ”¾ç³»çµ± (Replay System) éœ€æ±‚è¦åŠƒ

å›æ”¾ç³»çµ±æ˜¯é€£æ¥ã€Œç¬é–“é‹ç®—çµæœã€èˆ‡ã€Œç©å®¶è¦–è¦ºé«”é©—ã€çš„æ©‹æ¨‘ã€‚å®ƒç¨ç«‹æ–¼ Combat æ¨¡çµ„ï¼Œä½†é«˜åº¦ä¾è³´ Combat ç”¢ç”Ÿçš„ `Snapshot` èˆ‡ `Log` æ•¸æ“šã€‚

### 1.1 æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚ (Functional Requirements)

#### æ’­æ”¾æ§åˆ¶ (Playback Control)

- **åŸºç¤æ§åˆ¶**: æ’­æ”¾ (Play)ã€æš«åœ (Pause)ã€é‡æ’­ (Replay)ã€‚
- **é€Ÿåº¦æ§åˆ¶**: æ”¯æ´å¤šæ®µè®Šé€Ÿï¼Œå»ºè­°ç¯„åœï¼š`0.5x` (æ…¢å‹•ä½œæª¢è¦–), `1x` (æ­£å¸¸), `2x`, `4x` (å¿«é€Ÿç•¥é)ã€‚
- **æ™‚é–“è»¸æ‹–æ‹‰ (Scrubbing)**: æä¾›é€²åº¦æ¢ (Slider)ï¼Œå…è¨±ç©å®¶ç›´æ¥æ‹–å‹•åˆ°æˆ°é¬¥çš„ä»»æ„ Tickã€‚
- **è·³è½‰åŠŸèƒ½**:
  - "Jump to Start" / "Jump to End"ã€‚
  - "Next/Prev Round" (å¦‚æœæœ‰å›åˆæ¦‚å¿µ) æˆ– "Next/Prev Ultimate" (è·³è½‰åˆ°ä¸‹ä¸€æ¬¡å¤§æ‹›æ–½æ”¾é»)ã€‚

#### è¦–è¦ºå‘ˆç¾ (Visual Presentation)

- **å¯¦é«”ç‹€æ…‹åŒæ­¥**: æ ¹æ“šç•¶å‰ Tick çš„å¿«ç…§æ•¸æ“šï¼Œæ›´æ–°è§’è‰²çš„ä½ç½®(è‹¥æœ‰)ã€HP æ¢ã€èƒ½é‡æ¢ã€è­·ç›¾å€¼ã€‚
- **æˆ°é¬¥æµ®å‹•æ–‡å­— (Floating Text)**:
  - å‚·å®³æ•¸å­— (ä¸åŒé¡è‰²å€åˆ†ï¼šç‰©ç†ã€çœŸå¯¦ã€æš´æ“Š)ã€‚
  - æ²»ç™‚æ•¸å­—ã€‚
  - ç‹€æ…‹æ–‡å­— (å¦‚ "Stunned", "Dodged", "Blocked")ã€‚
- **ç‰¹æ•ˆè§¸ç™¼ (VFX Triggers)**:
  - æ”»æ“Šå‹•ç•«ã€å—æ“Šé–ƒçˆã€‚
  - å¤§æ‹›é‡‹æ”¾æ™‚çš„è¦–è¦ºå¼·èª¿ (Cut-in æˆ–å…¨è¢å¹•ç‰¹æ•ˆ)ã€‚
  - ç•°å¸¸ç‹€æ…‹åœ–ç¤º (Buff/Debuff Icons) åŠå…¶å †ç–Šå±¤æ•¸é¡¯ç¤ºã€‚

#### è³‡è¨Šæª¢è¦– (Inspection)

- **é»æ“Š/æ‡¸åœæª¢è¦–**: åœ¨æš«åœç‹€æ…‹ä¸‹ï¼Œé»æ“Šè§’è‰²å¯æŸ¥çœ‹è©² Tick ç•¶ä¸‹çš„è©³ç´°å±¬æ€§é¢æ¿ (æ”»æ“ŠåŠ›ã€é˜²ç¦¦åŠ›ã€ç•¶å‰æ‰€æœ‰ Effect)ã€‚
- **æˆ°é¬¥æ—¥èªŒåŒæ­¥**: ç•«é¢æ—é¡¯ç¤ºæ–‡å­—ç‰ˆæˆ°é¬¥æ—¥èªŒ (Combat Log)ï¼Œä¸¦éš¨æ’­æ”¾é€²åº¦è‡ªå‹•æ²å‹•/é«˜äº®ç•¶å‰è¡Œã€‚

#### çµç®—èˆ‡å°èˆª

- **æˆ°é¬¥çµæœé è¦½**: é›–ç„¶æ˜¯å›æ”¾ï¼Œä½†ç©å®¶å¯èƒ½æƒ³å…ˆçŸ¥é“çµæœã€‚å¯é¸æ“‡ã€Œç›´æ¥é¡¯ç¤ºçµæœã€æˆ–ã€Œè§€çœ‹éç¨‹ã€ã€‚
- **é›¢é–‹å›æ”¾**: æ˜ç¢ºçš„ã€Œè¿”å›æˆ°é¬¥å¤–/è¿”å›çµç®—ç•«é¢ã€æŒ‰éˆ•ã€‚

### 1.2 æ•¸æ“šéœ€æ±‚

- **Input**: `CombatResult` (åŒ…å« `snapshots`, `logs`, `winner`, `statistics`)ã€‚
- **State**: å›æ”¾å¼•æ“éœ€ç¶­è­· `currentTick`, `isPlaying`, `playbackSpeed` ç­‰ç‹€æ…‹ã€‚

---

## 2. æˆ°é¬¥å¤–ç³»çµ± (Meta-game) æµç¨‹è¨­è¨ˆ

åŸºæ–¼ `0_251201_éŠæˆ²æ§‹æ€.instructions.md` èˆ‡ Roguelite/æ”¾ç½®éŠæˆ² (å¦‚ Slay the Spire, AFK Arena) çš„åƒè€ƒã€‚

### 2.1 æ ¸å¿ƒå¾ªç’° (The Loop)

```mermaid
graph TD
    A[ç‡Ÿåœ°/æº–å‚™ä»‹é¢ Camp] -->|é¸æ“‡é—œå¡/å±¤æ•¸| B[æˆ°å‰é…ç½® Pre-Combat]
    B -->|èª¿æ•´è£å‚™/æŠ€èƒ½| B
    B -->|é–‹å§‹æˆ°é¬¥| C{æˆ°é¬¥é‹ç®— Combat}
    C -->|é‹ç®—å®Œæˆ| D[å›æ”¾/çµç®—ä»‹é¢ Result]
    D -->|å‹åˆ©| E[æˆ°åˆ©å“é¸æ“‡ Loot]
    D -->|å¤±æ•—| F[æ­»äº¡è™•ç† Death]
    E -->|ç²å¾—è£å‚™/éºç‰©| A
    F -->|é‡è©¦ (æ¶ˆè€—æ¬¡æ•¸)| A
    F -->|æ”¾æ£„/æ¬¡æ•¸ç”¨ç›¡| G[éŠæˆ²çµæŸ Game Over]
```

### 2.2 è©³ç´°æ¨¡çµ„è¦åŠƒ

#### A. ç‡Ÿåœ°/ä¸»ä»‹é¢ (The Hub)

é€™æ˜¯ç©å®¶åœ¨æˆ°é¬¥ä¹‹é–“åœç•™çš„åœ°æ–¹ã€‚

- **è§’è‰²ç‹€æ…‹ (Character Sheet)**: é¡¯ç¤ºå±¬æ€§ã€ç•¶å‰è£å‚™ (Weapon, Helm, Armor, Necklace)ã€å·²ç²å¾—çš„éºç‰© (Relics)ã€‚
- **èƒŒåŒ… (Inventory)**: æŸ¥çœ‹æ“æœ‰çš„æ‰€æœ‰ç‰©å“ã€‚
- **å•†åº— (Shop)**:
  - _è¨­è¨ˆç‰¹é»_: æ–‡ä»¶æåˆ°ã€Œå¯éš¨æ™‚é€²å…¥ã€ã€‚é€™æ„å‘³è‘—å•†åº—ä¸æ˜¯åœ°åœ–ä¸Šçš„ä¸€å€‹ç¯€é»ï¼Œè€Œæ˜¯ä¸€å€‹å¸¸é§åŠŸèƒ½æŒ‰éˆ•ã€‚
  - _åŠŸèƒ½_: è³¼è²·è£å‚™/éºç‰©ã€å‡ºå”®ç„¡ç”¨ç‰©å“ã€åˆ·æ–°å•†å“ (å¯é¸)ã€‚
- **é—œå¡é€²åº¦é¡¯ç¤º**: é¡¯ç¤ºç•¶å‰å±¤æ•¸ (e.g., "Floor 5/30 - Mini Boss")ã€‚

#### B. æˆ°å‰é…ç½® (Preparation Phase)

é€²å…¥æˆ°é¬¥å‰çš„æœ€å¾Œç¢ºèªã€‚

- **æ•µäººé è¦½**: é¡¯ç¤ºå³å°‡é¢å°çš„æ•µäººé™£å®¹ã€å±¬æ€§ã€é—œéµæŠ€èƒ½ (çŸ¥å·±çŸ¥å½¼æ˜¯ç­–ç•¥é‡é»)ã€‚
- **é…ç½®èª¿æ•´**: é‡å°æ•µäººç‰¹æ€§æ›´æ›è£å‚™ (ä¾‹å¦‚ï¼šæ•µäººé«˜é–ƒé¿ -> æ›é«˜å‘½ä¸­è£å‚™)ã€‚
- **é–‹å§‹æˆ°é¬¥æŒ‰éˆ•**: é»æ“Šå¾Œè§¸ç™¼ Combat Engine é‹ç®—ã€‚

#### C. æˆ°åˆ©å“é¸æ“‡ (Loot Selection)

Roguelite çš„æ ¸å¿ƒé©…å‹•åŠ›ã€‚

- **ä¸‰é¸ä¸€æ©Ÿåˆ¶**: å‹åˆ©å¾Œå½ˆå‡ºä¸‰å€‹é¸é … (è£å‚™ or éºç‰©)ã€‚
- **è·³é/è½‰æ›**: è‹¥éƒ½ä¸å–œæ­¡ï¼Œå¯é¸æ“‡å°‘é‡é‡‘å¹£æˆ–å›å¾© HP (å¸¸è¦‹è¨­è¨ˆï¼Œé¿å…æ±™æŸ“ç‰Œåº«/è£å‚™åº«)ã€‚

#### D. æ­»äº¡èˆ‡é‡è©¦ (Death & Retry)

- **æ©Ÿåˆ¶**: ç©å®¶æœ‰ N æ¬¡æ­»äº¡æ©Ÿæœƒã€‚
- **å¤±æ•—é¸é …**:
  1. **èª¿æ•´é…ç½®é‡è©¦**: å›åˆ°æˆ°å‰é…ç½®ç•«é¢ï¼Œä¸æ‰£é™¤é€²åº¦ï¼Œä½†æ¶ˆè€—ã€Œæ­»äº¡æ©Ÿæœƒã€ã€‚
  2. **è·³é—œ (Skip)**: æ–‡ä»¶æåˆ°ã€Œå¤±æ•—å¯é¸æ“‡è·³é—œã€ã€‚é€™æ˜¯ä¸€å€‹ç‰¹æ®Šçš„è¨­è¨ˆï¼Œå…è¨±ç©å®¶æ”¾æ£„è©²å±¤çå‹µç›´æ¥é€²å…¥ä¸‹ä¸€å±¤ï¼Ÿ(éœ€æ¬Šè¡¡ï¼šé€™æ¨£æ˜¯å¦æœƒå°è‡´ç©å®¶å› ç¼ºä¹æˆé•·è€Œå¡åœ¨ä¸‹ä¸€é—œï¼Ÿå»ºè­°è·³é—œéœ€ä»˜å‡ºä»£åƒ¹ï¼Œå¦‚æ‰£é™¤å¤§é‡é‡‘å¹£æˆ–ç”Ÿå‘½ä¸Šé™)ã€‚

---

## 3. é—œéµæ¬Šè¡¡èˆ‡æ±ºç­– (Trade-offs)

### 3.1 å•†åº—æ©Ÿåˆ¶ï¼šå¸¸é§ vs ç¯€é»å¼

- **é¸é … A (å¸¸é§ - ç›®å‰æ¡ç”¨)**: å•†åº—æŒ‰éˆ•éš¨æ™‚å¯é»ã€‚
  - âœ… **å„ªé»**: ç©å®¶å®¹éŒ¯ç‡é«˜ï¼Œå¡é—œæ™‚å¯ä»¥éš¨æ™‚è²·æ°´/æ›è£å‚™æ•‘æ€¥ã€‚ç­–ç•¥éˆæ´»æ€§æ¥µå¤§ã€‚
  - âŒ **ç¼ºé»**: é™ä½äº† Roguelite çš„è³‡æºç®¡ç†å£“åŠ› (ä¸ç”¨æ“”å¿ƒã€ŒéŒ¯éé€™æ‘æ²’é€™åº—ã€)ã€‚å¹³è¡¡é›£åº¦è¼ƒé«˜ï¼Œå®¹æ˜“è®“ç©å®¶é€éå›¤éŒ¢åœ¨é—œéµæ™‚åˆ»çˆ†ç™¼ã€‚
- **é¸é … B (ç¯€é»å¼ - Slay the Spire)**: å•†åº—æ˜¯åœ°åœ–ä¸Šçš„ä¸€å€‹æ ¼å­ã€‚
  - âœ… **å„ªé»**: ç¶“å…¸ Roguelite é«”é©—ï¼Œè·¯ç·šè¦åŠƒå……æ»¿ç­–ç•¥å¼µåŠ›ã€‚
  - âŒ **ç¼ºé»**: é‹æ°£æˆåˆ†é‡ï¼Œè‹¥æ€¥éœ€è£å‚™å»é‡ä¸åˆ°å•†åº—æœƒå¾ˆæŒ«æŠ˜ã€‚
- **æ±ºç­–**: éµå¾ªè¨­è¨ˆæ–‡ä»¶ï¼Œæ¡ç”¨ **é¸é … A (å¸¸é§)**ã€‚
  - _è£œæ•‘æªæ–½_: å•†åº—å•†å“åƒ¹æ ¼éš¨å±¤æ•¸é€šè†¨ï¼Œæˆ–åˆ·æ–°å•†å“éœ€è¦é«˜é¡ä»£åƒ¹ï¼Œé¿å…ç©å®¶éåº¦ä¾è³´ã€‚

### 3.2 æˆ°é¬¥çµç®—ï¼šç¬é–“é‹ç®— vs å¯¦æ™‚æ¨¡æ“¬

- **é¸é … A (ç¬é–“é‹ç®— + å›æ”¾ - ç›®å‰æ¡ç”¨)**: æŒ‰ä¸‹æˆ°é¬¥å³å‡ºçµæœã€‚
  - âœ… **å„ªé»**: é©åˆã€Œåˆ·ã€çš„ç¯€å¥ (Farm)ï¼Œç©å®¶æƒ³çœ‹çµæœå°±çœ‹çµæœï¼Œæƒ³ç ”ç©¶å†çœ‹å›æ”¾ã€‚ä¾¿æ–¼å¯¦ä½œã€Œè·³éæˆ°é¬¥ã€åŠŸèƒ½ã€‚
  - âŒ **ç¼ºé»**: ç©å®¶é»æ“Šã€Œæˆ°é¬¥ã€å¾Œèˆ‡ã€Œçµæœã€ä¹‹é–“å¯èƒ½ç”¢ç”Ÿå‰²è£‚æ„Ÿï¼Œå¿…é ˆé€éå¼·åˆ¶é€²å…¥å›æ”¾æˆ–é«˜å“è³ªçš„è½‰å ´ä¾†å½Œè£œã€‚
- **é¸é … B (å¯¦æ™‚æ¨¡æ“¬)**: ç©å®¶çœ‹è‘—æˆ°é¬¥ç™¼ç”Ÿ (å¦‚å‚³çµ± RPG)ã€‚
  - âœ… **å„ªé»**: æ²‰æµ¸æ„Ÿå¼·ã€‚
  - âŒ **ç¼ºé»**: é‡è¤‡éŠç©æ™‚æœƒæ„Ÿåˆ°æ‹–æ²“ï¼ŒåŠ é€ŸåŠŸèƒ½å¯¦ä½œè¼ƒè¤‡é›œ (éœ€èˆ‡é‚è¼¯è€¦åˆ)ã€‚
- **æ±ºç­–**: æ¡ç”¨ **é¸é … A**ã€‚é€™ç¬¦åˆç¾ä»£æ”¾ç½®/æ‰‹éŠè¶¨å‹¢ (å¦‚ AFK Arena)ï¼Œå°Šé‡ç©å®¶æ™‚é–“ã€‚

### 3.3 åœ°åœ–çµæ§‹ï¼šç·šæ€§ vs åˆ†æ”¯

- **é¸é … A (ç·šæ€§éå¢)**: ç¬¬ 1 å±¤ -> ç¬¬ 2 å±¤ -> ... -> ç¬¬ 30 å±¤ã€‚
  - âœ… **å„ªé»**: é–‹ç™¼ç°¡å–®ï¼Œç¬¦åˆæ–‡ä»¶ã€Œå±¤æ•¸éå¢ã€çš„æè¿°ã€‚
  - âŒ **ç¼ºé»**: ç¼ºä¹è·¯ç·šè¦åŠƒçš„æ¨‚è¶£ã€‚
- **é¸é … B (åˆ†æ”¯è·¯ç·š)**: åƒ Slay the Spire çš„æ¨¹ç‹€åœ–ã€‚
  - âœ… **å„ªé»**: é«˜é‡ç©æ€§ã€‚
  - âŒ **ç¼ºé»**: UI é–‹ç™¼æˆæœ¬é«˜ï¼Œé‚è¼¯è¤‡é›œã€‚
- **æ±ºç­–**: å»ºè­°æ¡ç”¨ **ç·šæ€§ä½†æœ‰é¸æ“‡ (Linear with Choices)**ã€‚
  - çµæ§‹æ˜¯ç·šæ€§çš„ (1->2->3)ï¼Œä½†åœ¨æ¯ä¸€å±¤é–‹å§‹å‰ï¼Œå¯èƒ½æœ‰ã€Œäº‹ä»¶å¡ã€äºŒé¸ä¸€ (e.g., "é­é‡ç²¾è‹±æ€ª(é«˜é¢¨éšªé«˜å ±é…¬)" vs "é­é‡æ™®é€šæ€ª")ï¼Œæˆ–è€…åœ¨æˆ°é¬¥å¾Œé¸æ“‡è·¯ç·šã€‚
  - _MVP éšæ®µ_: å…ˆåšç´”ç·šæ€§ï¼Œæ¯ 5 å±¤å›ºå®š Bossã€‚

### 3.4 å¤±æ•—æ‡²ç½°ï¼šè·³é—œ vs é‡è©¦

- **æ–‡ä»¶è¨­è¨ˆ**: ã€Œå¤±æ•—å¯é¸æ“‡è·³é—œã€ã€‚
- **é¢¨éšª**: è·³é—œ = æ”¾æ£„è©²å±¤ç¶“é©—/è£å‚™ = ä¸‹ä¸€å±¤æ›´é›£æ‰“ = æƒ¡æ€§å¾ªç’°ã€‚
- **å»ºè­°èª¿æ•´**:
  - å¤±æ•—å¾Œå¯ **é‡è©¦ (Retry)** (æ¶ˆè€—å‘½æ•¸)ã€‚
  - è‹¥å‘½æ•¸ç”¨ç›¡æˆ–ä¸æƒ³æ‰“ï¼Œå‰‡ **æ’¤é€€ (Retreat)** çµç®—æœ¬æ¬¡å†’éšªï¼Œè€Œä¸æ˜¯è·³é—œç¹¼çºŒã€‚
  - æˆ–è€…ã€Œè·³é—œã€æ˜¯ä»˜å‡ºä»£åƒ¹ (å¦‚å¤±å»ä¸€ä»¶éºç‰©) ä¾†æ›å–ç”Ÿå­˜ã€‚é€™é»éœ€è¦å†ä»”ç´°æ§‹æ€ã€‚

---

## 4. å›æ”¾ç³»çµ±æŠ€è¡“å¯¦ä½œè¨­è¨ˆ (Replay System Implementation)

### 4.1 è¨­è¨ˆåŸå‰‡èˆ‡å…±è­˜

ç¶“éè¨è«–,æˆ‘å€‘å·²é”æˆä»¥ä¸‹å…±è­˜:

#### ç´”é‚è¼¯å›æ”¾ç³»çµ± (Pure Logic Replay)

- **è³‡æ–™ä¾†æº**: EDA (Event-Driven Architecture) ä¸­çš„å„ç¨®è¡Œç‚ºè®ŠåŒ–ç”¢ç”Ÿçš„ `logs` èˆ‡ `snapshots`
- **ç¢ºå®šæ€§**: ä½¿ç”¨å›ºå®šçš„ `seed` ä¾†ç¢ºä¿æ¯æ¬¡ replay çš„çµæœä¸€è‡´
- **æ™‚é–“è»¸åŒæ­¥**: å°‡éŠæˆ²ç‹€æ…‹èˆ‡æ™‚é–“è»¸åŒæ­¥,æ‰€æœ‰è¡Œç‚ºåŸºæ–¼æ™‚é–“è»¸è§¸ç™¼ (é»˜èª 1 tick = 10ms)

#### ç³»çµ±å®šä½

- **ç¨ç«‹æ€§**: å›æ”¾ç³»çµ±æ˜¯ç¨ç«‹æ¨¡çµ„,ä¸ä¿®æ”¹ Combat æ¨¡çµ„
- **ä¾è³´æ€§**: é«˜åº¦ä¾è³´ Combat æ¨¡çµ„ç”¢ç”Ÿçš„æ•¸æ“š (`CombatResult`, `CombatSnapshot`, `CombatLogEntry`)
- **å–®å‘æµ**: Combat â†’ Result â†’ Replay (å–®å‘è³‡æ–™æµ,ç„¡å›é¥‹)

### 4.2 æª”æ¡ˆçµæ§‹è¨­è¨ˆ

```
src/modules/
  replay/                           # å›æ”¾ç³»çµ±æ ¹ç›®éŒ„
    index.ts                        # åŒ¯å‡ºæ‰€æœ‰å…¬é–‹ä»‹é¢
    replay.engine.ts                # å›æ”¾å¼•æ“æ ¸å¿ƒ
    models/
      index.ts
      replay.config.model.ts        # å›æ”¾é…ç½® (é€Ÿåº¦ã€æ˜¯å¦å¾ªç’°ç­‰)
      replay.state.model.ts         # å›æ”¾ç‹€æ…‹ (ç•¶å‰tickã€æ’­æ”¾ç‹€æ…‹ç­‰)
      replay.event.model.ts         # å›æ”¾å°ˆç”¨äº‹ä»¶é¡å‹
    controllers/
      index.ts
      playback.controller.ts        # æ’­æ”¾æ§åˆ¶å™¨ (play/pause/seek)
      timeline.controller.ts        # æ™‚é–“è»¸æ§åˆ¶å™¨ (è·³è½‰ã€é€Ÿåº¦)
    utils/
      index.ts
      interpolator.ts               # æ’å€¼å·¥å…· (ç”¨æ–¼å¹³æ»‘å‹•ç•«)
      event.mapper.ts               # å°‡ CombatLogEntry æ˜ å°„ç‚º UI äº‹ä»¶
```

### 4.3 æ ¸å¿ƒæ¨¡å‹å®šç¾©

#### ReplayConfig (å›æ”¾é…ç½®)

```typescript
interface ReplayConfig {
  /** Playback speed multiplier (0.5x, 1x, 2x, 4x) */
  playbackSpeed: number
  /** Whether to loop the replay */
  loop: boolean
  /** Milliseconds per tick (default: 10ms) */
  msPerTick: number
  /** Whether to auto-play on load */
  autoPlay: boolean
  /** Snapshot interpolation enabled (smooth animations) */
  enableInterpolation: boolean
}
```

#### ReplayState (å›æ”¾ç‹€æ…‹)

```typescript
interface ReplayState {
  /** Current tick position */
  currentTick: number
  /** Is currently playing */
  isPlaying: boolean
  /** Is paused */
  isPaused: boolean
  /** Total ticks in this replay */
  totalTicks: number
  /** Current playback speed */
  speed: number
  /** Has reached the end */
  hasEnded: boolean
}
```

#### ReplayEvent (å›æ”¾äº‹ä»¶)

```typescript
type ReplayEventType =
  | 'replay:loaded' // å›æ”¾è³‡æ–™è¼‰å…¥å®Œæˆ
  | 'replay:started' // é–‹å§‹æ’­æ”¾
  | 'replay:paused' // æš«åœ
  | 'replay:resumed' // æ¢å¾©æ’­æ”¾
  | 'replay:stopped' // åœæ­¢
  | 'replay:seeked' // è·³è½‰åˆ°ç‰¹å®š tick
  | 'replay:ended' // æ’­æ”¾çµæŸ
  | 'replay:tick' // æ¯å€‹ tick æ›´æ–°
  | 'replay:speedChanged' // é€Ÿåº¦æ”¹è®Š

interface ReplayEvent<T = unknown> {
  type: ReplayEventType
  tick: number
  payload?: T
}
```

### 4.4 æ ¸å¿ƒé¡åˆ¥è¨­è¨ˆ

#### ReplayEngine (å›æ”¾å¼•æ“)

```typescript
/**
 * ReplayEngine: Core replay system engine
 *
 * Design concept:
 * - Consumes CombatResult data and provides timeline-based playback
 * - Maintains independent state machine (loaded â†’ playing â†’ paused â†’ ended)
 * - Emits events at each tick for UI to consume
 * - Supports speed control, seeking, and looping
 *
 * Key responsibilities:
 * - Load and validate combat result data
 * - Manage playback state (play/pause/stop/seek)
 * - Emit tick events with current snapshot and logs
 * - Handle time-based progression using requestAnimationFrame
 */
export class ReplayEngine {
  private result: CombatResult | null = null
  private state: ReplayState
  private config: ReplayConfig
  private eventEmitter: EventEmitter<ReplayEvent>
  private animationFrameId: number | null = null
  private lastFrameTime: number = 0

  constructor(config?: Partial<ReplayConfig>) {
    this.config = { ...defaultConfig, ...config }
    this.state = this.createInitialState()
    this.eventEmitter = new EventEmitter()
  }

  /** Load combat result data */
  public load(result: CombatResult): void

  /** Start playback */
  public play(): void

  /** Pause playback */
  public pause(): void

  /** Stop and reset to start */
  public stop(): void

  /** Seek to specific tick */
  public seek(tick: number): void

  /** Change playback speed */
  public setSpeed(speed: number): void

  /** Get current snapshot at current tick */
  public getCurrentSnapshot(): CombatSnapshot | null

  /** Get logs within tick range */
  public getLogsInRange(startTick: number, endTick: number): CombatLogEntry[]

  /** Subscribe to replay events */
  public on(eventType: ReplayEventType, handler: (event: ReplayEvent) => void): void

  /** Unsubscribe from replay events */
  public off(eventType: ReplayEventType, handler: (event: ReplayEvent) => void): void

  /** Cleanup and release resources */
  public dispose(): void

  // === Private methods ===
  private tick(): void
  private emitTickEvent(): void
  private scheduleNextFrame(): void
}
```

#### PlaybackController (æ’­æ”¾æ§åˆ¶å™¨)

```typescript
/**
 * PlaybackController: High-level playback control
 *
 * Provides convenient methods for common playback scenarios:
 * - Jump to combat start/end
 * - Jump to next/previous ultimate
 * - Jump to next/previous death event
 * - Toggle play/pause
 */
export class PlaybackController {
  constructor(private engine: ReplayEngine) {}

  /** Toggle between play and pause */
  public togglePlayPause(): void

  /** Jump to combat start */
  public jumpToStart(): void

  /** Jump to combat end */
  public jumpToEnd(): void

  /** Jump to next ultimate cast */
  public jumpToNextUltimate(): void

  /** Jump to previous ultimate cast */
  public jumpToPrevUltimate(): void

  /** Jump to next death event */
  public jumpToNextDeath(): void

  /** Jump forward/backward by N ticks */
  public skip(ticks: number): void
}
```

#### TimelineController (æ™‚é–“è»¸æ§åˆ¶å™¨)

```typescript
/**
 * TimelineController: Timeline and scrubbing control
 *
 * Handles timeline-related operations:
 * - Convert tick to progress percentage
 * - Convert progress percentage to tick
 * - Find important moments (ultimates, deaths, critical hits)
 */
export class TimelineController {
  constructor(private engine: ReplayEngine) {}

  /** Convert tick to progress (0-1) */
  public tickToProgress(tick: number): number

  /** Convert progress (0-1) to tick */
  public progressToTick(progress: number): number

  /** Get all important event ticks for timeline markers */
  public getImportantMoments(): Array<{ tick: number; type: string }>

  /** Get ticks where ultimates were cast */
  public getUltimateTicks(): number[]

  /** Get ticks where deaths occurred */
  public getDeathTicks(): number[]
}
```

### 4.5 èˆ‡ Combat æ¨¡çµ„çš„é—œä¿‚

#### ä¾è³´é—œä¿‚

```
Combat Module (Independent)
    â†“ (produces)
CombatResult
    â†“ (consumed by)
Replay Module (Dependent)
    â†“ (emits)
Replay Events
    â†“ (consumed by)
UI Layer
```

#### æ•¸æ“šæµå‘

1. **Combat Phase**: Combat Engine åŸ·è¡Œæˆ°é¬¥ â†’ ç”¢ç”Ÿ `CombatResult`
2. **Handoff Phase**: `CombatResult` å‚³éçµ¦ Replay Engine
3. **Replay Phase**: Replay Engine åŸºæ–¼ `snapshots` å’Œ `logs` é‡å»ºæ™‚é–“è»¸
4. **Presentation Phase**: UI ç›£è½ Replay Events ä¸¦æ¸²æŸ“è¦–è¦ºæ•ˆæœ

#### ä¸ä¾è³´é …ç›®

- **ä¸ä¾è³´ Combat Context**: å›æ”¾ç³»çµ±ä¸éœ€è¦çŸ¥é“ Combat çš„å…§éƒ¨ç‹€æ…‹
- **ä¸ä¾è³´ Ticker**: å›æ”¾æœ‰è‡ªå·±çš„æ™‚é–“æ§åˆ¶,èˆ‡ Combat Ticker ç„¡é—œ
- **ä¸ä¾è³´ EventBus**: å›æ”¾ç³»çµ±æœ‰è‡ªå·±çš„äº‹ä»¶ç³»çµ±
- **ä¸ä¾è³´ Character å¯¦ä¾‹**: åªä¾è³´ `CharacterSnapshot` æ•¸æ“š

### 4.6 æ™‚é–“è»¸èˆ‡æ’å€¼è™•ç†

#### åŸºæ–¼ Snapshot çš„ç‹€æ…‹é‡å»º

```typescript
// Combat ç”¢ç”Ÿçš„ snapshots æ˜¯é—œéµå¹€
// ä¾‹å¦‚: snapshots at tick [0, 100, 200, 300, ...]

// Replay Engine åœ¨æ’­æ”¾æ™‚:
// currentTick = 150
// â†’ æ‰¾åˆ°å‰å¾Œ snapshot: [100] å’Œ [200]
// â†’ æ ¹æ“šéœ€æ±‚æ±ºå®šæ˜¯å¦æ’å€¼:
//    - ä¸æ’å€¼: ç›´æ¥ä½¿ç”¨ tick 100 çš„ snapshot
//    - æ’å€¼: åœ¨ 100 å’Œ 200 ä¹‹é–“ç·šæ€§æ’å€¼ (ç”¨æ–¼å¹³æ»‘å‹•ç•«)
```

#### æ—¥èªŒäº‹ä»¶çš„è§¸ç™¼æ™‚æ©Ÿ

```typescript
// logs æ˜¯ç²¾ç¢ºçš„ tick äº‹ä»¶
// ä¾‹å¦‚: { tick: 125, eventType: 'entity:damage', ... }

// Replay Engine åœ¨æ’­æ”¾æ™‚:
// currentTick = 124 â†’ 125
// â†’ è§¸ç™¼æ‰€æœ‰ tick === 125 çš„ logs
// â†’ UI å±¤æ¥æ”¶åˆ°äº‹ä»¶,é¡¯ç¤ºæµ®å‹•å‚·å®³æ•¸å­—
```

### 4.7 å¯¦ä½œå„ªå…ˆç´š

#### Phase 1: æ ¸å¿ƒå›æ”¾é‚è¼¯ (MVP)

- [ ] å®šç¾© `replay/models` æ‰€æœ‰ä»‹é¢
- [ ] å¯¦ä½œ `ReplayEngine` åŸºæœ¬åŠŸèƒ½ (load, play, pause, seek)
- [ ] å¯¦ä½œåŸºæ–¼ `requestAnimationFrame` çš„ tick æ›´æ–°æ©Ÿåˆ¶
- [ ] å¯¦ä½œäº‹ä»¶ç™¼å°„ç³»çµ±

#### Phase 2: æ§åˆ¶å™¨èˆ‡å·¥å…·

- [ ] å¯¦ä½œ `PlaybackController` (è·³è½‰åŠŸèƒ½)
- [ ] å¯¦ä½œ `TimelineController` (é€²åº¦æ¢é‚è¼¯)
- [ ] å¯¦ä½œ `EventMapper` (å°‡ CombatLogEntry æ˜ å°„ç‚ºå¯è®€è¨Šæ¯)

#### Phase 3: é€²éšåŠŸèƒ½

- [ ] å¯¦ä½œæ’å€¼ç³»çµ± (å¹³æ»‘å‹•ç•«)
- [ ] å¯¦ä½œå¤šé€Ÿæ’­æ”¾ (0.5x ~ 4x)
- [ ] å¯¦ä½œå¾ªç’°æ’­æ”¾
- [ ] å¯¦ä½œæ–·é»æ¨™è¨˜ (ultimates, deaths)

#### Phase 4: UI æ•´åˆ (ç¨ç«‹ä»»å‹™)

- [ ] è¨­è¨ˆå›æ”¾ UI ä»‹é¢
- [ ] å¯¦ä½œé€²åº¦æ¢æ‹–æ‹‰
- [ ] å¯¦ä½œæµ®å‹•å‚·å®³æ•¸å­—
- [ ] å¯¦ä½œæˆ°é¬¥æ—¥èªŒé¢æ¿

### 4.8 æ¶æ§‹åœ–è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Combat Module                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Ticker      â”‚â”€â”€â”€â–¶â”‚ EventBus â”‚â”€â”€â”€â–¶â”‚ EventLogger   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                                    â”‚                  â”‚
â”‚         â–¼                                    â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Characters  â”‚                    â”‚ CombatLogs    â”‚          â”‚
â”‚  â”‚  (State)    â”‚                    â”‚  (History)    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                                    â”‚                  â”‚
â”‚         â–¼                                    â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                  â”‚
â”‚  â”‚  Snapshot Manager               â”‚        â”‚                  â”‚
â”‚  â”‚  (Captures state periodically)  â”‚        â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                  â”‚
â”‚         â”‚                                    â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                      â–¼                                          â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚              â”‚ CombatResult  â”‚ (Data Product)                  â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ (Passed to)
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Replay Module                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    ReplayEngine                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚   Loader    â”‚â”€â–¶â”‚ State Machineâ”‚â”€â–¶â”‚ Event Emitter â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚         â”‚                â”‚                    â”‚          â”‚  â”‚
â”‚  â”‚         â–¼                â–¼                    â–¼          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ snapshots[] â”‚  â”‚ currentTick  â”‚  â”‚ tickEvents    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ logs[]      â”‚  â”‚ isPlaying    â”‚  â”‚ (Observable)  â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ PlaybackControllerâ”‚          â”‚ TimelineController â”‚         â”‚
â”‚  â”‚ - jumpToStart()   â”‚          â”‚ - tickToProgress() â”‚         â”‚
â”‚  â”‚ - jumpToEnd()     â”‚          â”‚ - progressToTick() â”‚         â”‚
â”‚  â”‚ - jumpToUltimate()â”‚          â”‚ - getImportant...()â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ (Events emitted)
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           UI Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Progress Barâ”‚  â”‚ Combat Log   â”‚  â”‚ Character Render â”‚       â”‚
â”‚  â”‚  (Slider)   â”‚  â”‚  Panel       â”‚  â”‚  (HP/Energy bars)â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Play/Pause  â”‚  â”‚ Speed Controlâ”‚  â”‚ Floating Damage  â”‚       â”‚
â”‚  â”‚  Button     â”‚  â”‚  (0.5x~4x)   â”‚  â”‚  Numbers (VFX)   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.9 é¢¨éšªè©•ä¼°èˆ‡ç·©è§£ç­–ç•¥

#### é¢¨éšª 1: å¤§å‹æˆ°é¬¥çš„è¨˜æ†¶é«”æ¶ˆè€—

**å•é¡Œ**: é•·æ™‚é–“æˆ°é¬¥ (ä¾‹å¦‚ 10000+ ticks) å¯èƒ½ç”¢ç”Ÿå¤§é‡ snapshots å’Œ logs

**ç·©è§£ç­–ç•¥**:

- **Snapshot æ¡æ¨£ç‡**: ä¸æ˜¯æ¯å€‹ tick éƒ½æ‹å¿«ç…§,è€Œæ˜¯æ¯ N ticks (ä¾‹å¦‚æ¯ 50 ticks)
- **Log å£“ç¸®**: ç›¸ä¼¼äº‹ä»¶å¯ä»¥åˆä½µ (ä¾‹å¦‚é€£çºŒ 10 æ¬¡æ™®æ”»å¯ä»¥è¨˜éŒ„ç‚º "10x attack")
- **æŒ‰éœ€è¼‰å…¥**: å°‡ logs åˆ†æ®µå„²å­˜,åªè¼‰å…¥ç•¶å‰æ’­æ”¾ç¯„åœé™„è¿‘çš„è³‡æ–™
- **Disposal**: Replay çµæŸå¾Œç«‹å³é‡‹æ”¾è³‡æº

#### é¢¨éšª 2: æ™‚é–“è»¸åŒæ­¥å•é¡Œ

**å•é¡Œ**: å¦‚æœ Combat ä½¿ç”¨çš„ seed æˆ–é‚è¼¯æ”¹è®Š,replay å¯èƒ½ä¸ä¸€è‡´

**ç·©è§£ç­–ç•¥**:

- **ç‰ˆæœ¬æ¨™è¨˜**: åœ¨ `CombatResult` ä¸­è¨˜éŒ„ Combat Engine ç‰ˆæœ¬è™Ÿ
- **å®Œæ•´å¿«ç…§**: Replay ä¾è³´çš„æ˜¯ snapshots å’Œ logs,ä¸æ˜¯é‡æ–°åŸ·è¡Œæˆ°é¬¥é‚è¼¯
- **åªè®€å›æ”¾**: Replay æ°¸é ä¸ä¿®æ”¹ Combat è³‡æ–™,ä¿è­‰è³‡æ–™å®Œæ•´æ€§

#### é¢¨éšª 3: UI æ•ˆèƒ½å•é¡Œ

**å•é¡Œ**: é«˜é€Ÿæ’­æ”¾ (4x) æ™‚,æ¯ç§’éœ€è¦æ¸²æŸ“å¤§é‡ tick

**ç·©è§£ç­–ç•¥**:

- **å¹€ç‡é™åˆ¶**: å³ä½¿é‚è¼¯ä»¥ 4x é€Ÿåº¦é‹è¡Œ,UI ä»ä»¥ 60fps æ¸²æŸ“
- **é—œéµå¹€æ¸²æŸ“**: é«˜é€Ÿæ™‚åªæ¸²æŸ“é—œéµäº‹ä»¶ (ultimates, deaths),è·³éæ™®æ”»
- **Canvas å„ªåŒ–**: ä½¿ç”¨é›¢å± Canvas æˆ– WebGL åŠ é€Ÿ
- **è™›æ“¬åŒ–**: æˆ°é¬¥æ—¥èªŒä½¿ç”¨è™›æ“¬æ»¾å‹•,åªæ¸²æŸ“å¯è¦‹å€åŸŸ

#### é¢¨éšª 4: å›æ”¾èˆ‡ Combat é‚è¼¯ä¸ä¸€è‡´

**å•é¡Œ**: å¦‚æœ Replay è‡ªå·±é‡æ–°è¨ˆç®—æŸäº›æ•¸å€¼,å¯èƒ½èˆ‡ Combat ä¸ä¸€è‡´

**ç·©è§£ç­–ç•¥**:

- **é›¶è¨ˆç®—åŸå‰‡**: Replay ä¸åšä»»ä½•éŠæˆ²é‚è¼¯è¨ˆç®—,ç´”ç²¹æ’­æ”¾è³‡æ–™
- **ä¿¡ä»» Source of Truth**: `CombatResult` æ˜¯å”¯ä¸€çœŸç›¸ä¾†æº
- **æ’å€¼åƒ…ç”¨æ–¼è¦–è¦º**: å¦‚æœéœ€è¦æ’å€¼,åƒ…ç”¨æ–¼å¹³æ»‘å‹•ç•«,ä¸å½±éŸ¿æ•¸å€¼

#### é¢¨éšª 5: è¤‡é›œçš„ seek æ“ä½œ

**å•é¡Œ**: è·³è½‰åˆ°ä»»æ„ tick éœ€è¦å¿«é€Ÿé‡å»ºç‹€æ…‹

**ç·©è§£ç­–ç•¥**:

- **å¿«ç…§ç´¢å¼•**: ç¶­è­· tick â†’ snapshot çš„ç´¢å¼•,å¿«é€ŸæŸ¥æ‰¾æœ€è¿‘çš„å¿«ç…§
- **å¢é‡æ›´æ–°**: å¾æœ€è¿‘çš„ snapshot é–‹å§‹,åªæ‡‰ç”¨åˆ°ç›®æ¨™ tick çš„ logs
- **é è¼‰å…¥**: èƒŒæ™¯é è¼‰å…¥å¸¸ç”¨è·³è½‰é» (é–‹å§‹ã€çµæŸã€ultimates) çš„ç‹€æ…‹

### 4.10 èˆ‡ Combat æ¨¡çµ„çš„æ·±åº¦ä¾è³´åˆ†æ

#### ä¾è³´çš„è³‡æ–™çµæ§‹

```typescript
// Replay å®Œå…¨ä¾è³´é€™äº›è³‡æ–™
from CombatResult:
  - snapshots: CombatSnapshot[]     // ç‹€æ…‹å¿«ç…§
  - logs: CombatLogEntry[]          // äº‹ä»¶æ—¥èªŒ
  - totalTicks: number              // ç¸½æ™‚é•·
  - startedAt/endedAt: number       // æ™‚é–“ç¯„åœ

from CombatSnapshot:
  - tick: number                    // æ™‚é–“æˆ³
  - characters: CharacterSnapshot[] // è§’è‰²ç‹€æ…‹

from CharacterSnapshot:
  - id, name, side                  // è­˜åˆ¥è³‡è¨Š
  - currentHP, maxHP                // ç”Ÿå‘½å€¼
  - currentEnergy, maxEnergy        // èƒ½é‡å€¼
  - currentShield, currentArmor     // é˜²ç¦¦å€¼
  - effects: EffectSnapshot[]       // ç•¶å‰æ•ˆæœ

from CombatLogEntry:
  - tick: number                    // äº‹ä»¶ç™¼ç”Ÿæ™‚é–“
  - eventType: keyof CombatEventMap // äº‹ä»¶é¡å‹
  - sourceId, targetId              // äº‹ä»¶ç›¸é—œå¯¦é«”
  - payload: Record<...>            // äº‹ä»¶è©³ç´°è³‡æ–™
```

#### ä¸ä¾è³´çš„éƒ¨åˆ†

```typescript
// Replay ä¸éœ€è¦çŸ¥é“é€™äº›
âŒ Combat Context (æˆ°é¬¥è¨­å®š)
âŒ Character å¯¦ä¾‹ (åªéœ€è¦ Snapshot)
âŒ Effect å¯¦ä¾‹ (åªéœ€è¦ EffectSnapshot)
âŒ Damage Chain (åªéœ€è¦æœ€çµ‚å‚·å®³æ•¸å€¼)
âŒ Ticker (æœ‰è‡ªå·±çš„æ™‚é–“æ§åˆ¶)
âŒ EventBus (æœ‰è‡ªå·±çš„äº‹ä»¶ç³»çµ±)
```

#### ä¾è³´é¢¨éšªç­‰ç´šè©•ä¼°

| ä¾è³´é …ç›®                     | é¢¨éšªç­‰ç´š  | èªªæ˜                             |
| ---------------------------- | --------- | -------------------------------- |
| `CombatResult` ä»‹é¢          | ğŸŸ¢ ä½     | ç©©å®šçš„å…¬é–‹ä»‹é¢,ä¸å¤ªæœƒè®Šå‹•        |
| `CombatSnapshot` çµæ§‹        | ğŸŸ¡ ä¸­     | å¦‚æœæ–°å¢å±¬æ€§,Replay éœ€è¦æ›´æ–° UI  |
| `CombatLogEntry` æ ¼å¼        | ğŸŸ¡ ä¸­     | æ–°å¢äº‹ä»¶é¡å‹éœ€è¦æ›´æ–° EventMapper |
| `CharacterSnapshot` è©³ç´°æ¬„ä½ | ğŸŸ¢ ä½     | å‘å¾Œç›¸å®¹,æ–°æ¬„ä½å¯é¸è®€å–          |
| Combat å…§éƒ¨é‚è¼¯              | ğŸŸ¢ ç„¡é¢¨éšª | å®Œå…¨ä¸ä¾è³´                       |

**çµè«–**: Replay æ¨¡çµ„çš„ä¾è³´æ˜¯**æ·ºå±¤ä¸”ç©©å®š**çš„,ä¸»è¦é¢¨éšªä¾†è‡ªè³‡æ–™æ ¼å¼çš„æ¼”é€²,è€Œéé‚è¼¯è€¦åˆã€‚

---

## 5. ä¸‹ä¸€æ­¥è¡Œå‹• (Next Steps)

1. **å»ºç«‹ Replay æ¨¡çµ„åŸºç¤çµæ§‹**:
   - å»ºç«‹ `src/modules/replay` ç›®éŒ„åŠæª”æ¡ˆéª¨æ¶
   - å®šç¾©æ‰€æœ‰æ ¸å¿ƒä»‹é¢ (`ReplayConfig`, `ReplayState`, `ReplayEvent`)
2. **å¯¦ä½œ ReplayEngine MVP**:
   - å¯¦ä½œè³‡æ–™è¼‰å…¥èˆ‡é©—è­‰
   - å¯¦ä½œåŸºæœ¬æ’­æ”¾æ§åˆ¶ (play/pause/stop)
   - å¯¦ä½œ tick æ›´æ–°é‚è¼¯ (ä¸å« UI)
3. **ç·¨å¯«å–®å…ƒæ¸¬è©¦**:
   - æ¸¬è©¦ ReplayEngine çš„ç‹€æ…‹è½‰æ›
   - æ¸¬è©¦ seek åŠŸèƒ½çš„é‚Šç•Œæƒ…æ³
   - æ¸¬è©¦é€Ÿåº¦æ§åˆ¶

4. **å»ºç«‹ç¯„ä¾‹ Demo**:
   - ä½¿ç”¨ç¾æœ‰çš„ `simpleCombat` ç¯„ä¾‹
   - åŸ·è¡Œ Combat â†’ ç²å– Result â†’ è¼‰å…¥ Replay Engine
   - åœ¨ Console è¼¸å‡ºæ¯å€‹ tick çš„ç‹€æ…‹ (é©—è­‰é‚è¼¯æ­£ç¢ºæ€§)

5. **UI æ•´åˆè¦åŠƒ** (Phase 2):
   - è¨­è¨ˆå›æ”¾ UI çš„ Component çµæ§‹
   - æ±ºå®šä½¿ç”¨ Canvas æˆ– DOM æ¸²æŸ“
   - è¨­è¨ˆæ§åˆ¶é¢æ¿ Layout

---

## 6. ç¸½çµï¼šå›æ”¾ç³»çµ±çš„è¨­è¨ˆå“²å­¸

### 6.1 æ ¸å¿ƒåŸå‰‡

1. **åˆ†é›¢é—œæ³¨é» (Separation of Concerns)**
   - Combat = ç”¢ç”ŸçœŸç›¸ (Source of Truth)
   - Replay = å‘ˆç¾çœŸç›¸ (Presentation Layer)
   - å…©è€…é€éä¸å¯è®Šè³‡æ–™ (`CombatResult`) é€£æ¥

2. **å–®å‘è³‡æ–™æµ (Unidirectional Data Flow)**

   ```
   Combat Engine â†’ CombatResult â†’ Replay Engine â†’ UI Events â†’ Visual Rendering
   (æ°¸ä¸å›æµ)
   ```

3. **é›¶é‚è¼¯å›æ”¾ (Zero-Logic Replay)**
   - Replay ä¸åšä»»ä½•éŠæˆ²é‚è¼¯è¨ˆç®—
   - ä¸é‡æ–°åŸ·è¡Œå‚·å®³è¨ˆç®—ã€ä¸é‡æ–°åˆ¤å®šå‘½ä¸­
   - ç´”ç²¹æ’­æ”¾å·²ç™¼ç”Ÿçš„äº‹ä»¶

4. **äº‹ä»¶é©…å‹•æ¶æ§‹ (Event-Driven Architecture)**
   - Replay Engine ç™¼å°„ç´°ç²’åº¦äº‹ä»¶
   - UI å±¤è¨‚é–±æ„Ÿèˆˆè¶£çš„äº‹ä»¶
   - è§£è€¦ Replay é‚è¼¯èˆ‡è¦–è¦ºå‘ˆç¾

### 6.2 ç‚ºä½•å¦‚æ­¤è¨­è¨ˆ?

#### å•é¡Œ 1: ç‚ºä½•ä¸è®“ Replay é‡æ–°åŸ·è¡Œ Combat?

**ç­”**: å› ç‚ºé€™æœƒå°è‡´:

- é›™é‡ç¶­è­·:Combat é‚è¼¯æ”¹è®Šæ™‚,Replay ä¹Ÿè¦æ”¹
- ä¸ä¸€è‡´é¢¨éšª:å¦‚æœ Replay çš„å¯¦ä½œæœ‰ bug,çµæœæœƒä¸åŒ
- æ•ˆèƒ½æµªè²»:é‡æ–°è¨ˆç®—å·²çŸ¥çš„çµæœ

#### å•é¡Œ 2: ç‚ºä½•éœ€è¦ Snapshot + Logs é›™è»Œåˆ¶?

**ç­”**:

- **Snapshot**: æä¾›é—œéµå¹€çš„å®Œæ•´ç‹€æ…‹ (ç”¨æ–¼å¿«é€Ÿ seek)
- **Logs**: æä¾›ç²¾ç¢ºçš„äº‹ä»¶ç´°ç¯€ (ç”¨æ–¼å‹•ç•«å’Œç‰¹æ•ˆè§¸ç™¼)
- é¡æ¯”å½±ç‰‡ç·¨ç¢¼:Snapshot = I-frame (é—œéµå¹€),Logs = P-frame (å·®ç•°å¹€)

#### å•é¡Œ 3: ç‚ºä½•ä½¿ç”¨ requestAnimationFrame è€Œé setInterval?

**ç­”**:

- **åŒæ­¥ç€è¦½å™¨æ¸²æŸ“é€±æœŸ**:é¿å…ç•«é¢æ’•è£‚
- **è‡ªå‹•ç¯€æµ**:ç•¶é ç±¤ä¸å¯è¦‹æ™‚è‡ªå‹•æš«åœ
- **æ›´ç²¾ç¢ºçš„æ™‚é–“æ§åˆ¶**:å¯ä»¥è¨ˆç®— deltaTime å¯¦ç¾å¹³æ»‘è®Šé€Ÿ

### 6.3 èˆ‡é¡ä¼¼ç³»çµ±çš„å°æ¯”

| ç³»çµ±                   | å¯¦ä½œæ–¹å¼                | å„ªç¼ºé»                                    |
| ---------------------- | ----------------------- | ----------------------------------------- |
| **StarCraft 2 Replay** | è¨˜éŒ„ç©å®¶è¼¸å…¥ + é‡æ–°æ¨¡æ“¬ | âœ… æª”æ¡ˆå° âŒ éœ€è¦å®Œæ•´éŠæˆ²å¼•æ“             |
| **LOL Replay (èˆŠç‰ˆ)**  | è¨˜éŒ„å®Œæ•´ç‹€æ…‹å¿«ç…§        | âœ… æº–ç¢º âŒ æª”æ¡ˆå·¨å¤§                       |
| **æˆ‘å€‘çš„è¨­è¨ˆ**         | Snapshot + Logs æ··åˆ    | âœ… å¹³è¡¡æª”æ¡ˆå¤§å°èˆ‡æº–ç¢ºæ€§ âœ… ä¸ä¾è³´éŠæˆ²å¼•æ“ |

### 6.4 æœªä¾†æ“´å±•å¯èƒ½æ€§

#### å¯èƒ½çš„é€²éšåŠŸèƒ½ (v0.5+)

- **å°å‡ºå½±ç‰‡**: å°‡å›æ”¾æ¸²æŸ“ç‚º MP4 (ä½¿ç”¨ MediaRecorder API)
- **æ…¢å‹•ä½œåˆ†æ**: åœ¨é—œéµæ™‚åˆ» (å¤§æ‹›ã€æ­»äº¡) è‡ªå‹•åˆ‡æ› 0.25x é€Ÿåº¦
- **å¤šè¦–è§’åˆ‡æ›**: å¦‚æœæœªä¾†æ”¯æ´å¤šè§’è‰²,å¯ä»¥åˆ‡æ›è·Ÿéš¨è¦–è§’
- **AI è§£èªª**: ä½¿ç”¨ LLM åˆ†ææˆ°é¬¥ä¸¦ç”Ÿæˆæ–‡å­—è§£èªª
- **å°æ¯”æ¨¡å¼**: ä¸¦æ’é¡¯ç¤ºå…©æ¬¡ä¸åŒé…ç½®çš„æˆ°é¬¥å›æ”¾

#### æŠ€è¡“å‚µå‹™æé†’

- [ ] ç•¶ Combat æ–°å¢æ–°çš„ Effect é¡å‹æ™‚,è¨˜å¾—æ›´æ–° `EventMapper`
- [ ] ç•¶ Character æ–°å¢æ–°çš„å±¬æ€§æ™‚,è©•ä¼°æ˜¯å¦éœ€è¦åœ¨ UI é¡¯ç¤º
- [ ] å®šæœŸæª¢æŸ¥ `CombatResult` çš„è³‡æ–™å¤§å°,å¿…è¦æ™‚å¯¦ä½œå£“ç¸®

---

## 7. å•é¡Œå›ç­”

> **å•**: é‚£éº¼ä½ æœƒæ€éº¼æ–°å¢é€™å¥—é‚è¼¯?æª”æ¡ˆçµæ§‹èˆ‡å…§å®¹æ˜¯?

**ç­”**: å¦‚ä¸Š Â§4.2 æ‰€ç¤º,å»ºç«‹ `src/modules/replay/` ç›®éŒ„,åŒ…å«:

- `replay.engine.ts` (æ ¸å¿ƒå¼•æ“)
- `models/` (å‹åˆ¥å®šç¾©)
- `controllers/` (é«˜éšæ§åˆ¶)
- `utils/` (å·¥å…·å‡½å¼)

> **å•**: ä»–æ·±åº¦ä¾è³´æ–¼ combat æ¨¡çµ„?

**ç­”**: **æ˜¯,ä½†åƒ…é™æ–¼è³‡æ–™å±¤é¢çš„ä¾è³´,è€Œéé‚è¼¯ä¾è³´**

- âœ… ä¾è³´ `CombatResult` ä»‹é¢ (ç©©å®š)
- âœ… ä¾è³´ `CombatSnapshot` çµæ§‹ (è¼ƒç©©å®š)
- âœ… ä¾è³´ `CombatLogEntry` æ ¼å¼ (ä¸­ç­‰è®Šå‹•)
- âŒ **ä¸ä¾è³´** Combat å…§éƒ¨å¯¦ä½œ (å®Œå…¨è§£è€¦)

**é¢¨éšªç­‰ç´š**: ğŸŸ¡ **ä¸­ä½é¢¨éšª**

- åªè¦ Combat ç¶­æŒ `CombatResult` çš„å…¬é–‹å¥‘ç´„,Replay å°±ä¸æœƒå—å½±éŸ¿
- å³ä½¿ Combat å…§éƒ¨é‡æ§‹,åªè¦è¼¸å‡ºæ ¼å¼ä¸è®Š,Replay ç„¡éœ€ä¿®æ”¹

> **å•**: å¯«åœ¨ v0.4 md å…§

**ç­”**: âœ… å·²å®Œæˆ,è«‹æŸ¥çœ‹æ›´æ–°å¾Œçš„æ–‡ä»¶!

---

## 8. ç«‹å³è¡Œå‹•æª¢æŸ¥æ¸…å–®

### ç¬¬ä¸€æ­¥:å»ºç«‹æª”æ¡ˆçµæ§‹ (5 åˆ†é˜)

```bash
mkdir -p src/modules/replay/{models,controllers,utils}
touch src/modules/replay/index.ts
touch src/modules/replay/replay.engine.ts
touch src/modules/replay/models/{replay.config.model.ts,replay.state.model.ts,replay.event.model.ts,index.ts}
touch src/modules/replay/controllers/{playback.controller.ts,timeline.controller.ts,index.ts}
touch src/modules/replay/utils/{interpolator.ts,event.mapper.ts,index.ts}
```

### ç¬¬äºŒæ­¥:å®šç¾©å‹åˆ¥ (10 åˆ†é˜)

- è¤‡è£½ä¸Šæ–¹ Â§4.3 çš„ TypeScript ä»‹é¢å®šç¾©
- å»ºç«‹ `models/index.ts` åŒ¯å‡ºæ‰€æœ‰å‹åˆ¥

### ç¬¬ä¸‰æ­¥:å¯¦ä½œ ReplayEngine éª¨æ¶ (20 åˆ†é˜)

- å¯¦ä½œå»ºæ§‹å­èˆ‡åˆå§‹åŒ–
- å¯¦ä½œ `load()` æ–¹æ³•
- å¯¦ä½œ `play()`, `pause()`, `stop()` ç‹€æ…‹åˆ‡æ›
- **å…ˆä¸å¯¦ä½œ** tick é‚è¼¯,ç”¨ `console.log` æ¨¡æ“¬

### ç¬¬å››æ­¥:ç·¨å¯«ç¬¬ä¸€å€‹æ¸¬è©¦ (15 åˆ†é˜)

```typescript
test('ReplayEngine should load CombatResult', () => {
  const engine = new ReplayEngine()
  const mockResult = createMockCombatResult()
  engine.load(mockResult)
  expect(engine.getCurrentSnapshot()).toBeDefined()
})
```

### ç¬¬äº”æ­¥:æ•´åˆåˆ°ç¾æœ‰ç¯„ä¾‹ (10 åˆ†é˜)

```typescript
// In examples/simpleCombat.ts
const result = combatEngine.execute()
console.log('Combat finished, loading replay...')

const replayEngine = new ReplayEngine()
replayEngine.load(result)
replayEngine.play()

// Watch console output to verify tick progression
```

**é è¨ˆç¸½æ™‚é–“**: ç´„ 1 å°æ™‚å®Œæˆ MVP éª¨æ¶
