# æ¶æ§‹è¨­è¨ˆç¼ºé™·

## 1. è§£è€¦åŸå‰‡çš„å¯¦ä½œé¢¨éšªèˆ‡æ¸¬è©¦æ€§ âš ï¸

### å•é¡Œ

è¨­è¨ˆå¼·èª¿å–®å‘ä¾è³´ï¼ˆdomain/app/adapter/infraï¼‰

ä½† Affix ç”Ÿæˆæ¶‰åŠå¤šç³»çµ±ï¼ˆæ± ã€é›£åº¦ã€è§’è‰²ï¼‰

**å¯èƒ½å½¢æˆéš±è—è€¦åˆ**

### çŸ›ç›¾æ¡ˆä¾‹

å±¬æ€§èšåˆç³»çµ±ã€Œä¸åœ¨ä¹ Affixã€ï¼Œä½†å¯¦éš›éœ€è§£æ Modifier

é€™æ˜¯å¦é•åè§£è€¦ï¼Ÿ

```
// è—åœ–èªªï¼šAffix æ˜¯å¯é¸çš„
// å±¬æ€§èšåˆä¸ä¾è³´ Affix æ¨¡çµ„

interface StatAggregator {
  aggregate(modifiers: Modifier[]): Stats;
  // ä¸çŸ¥é“ Modifier å¾ä½•è€Œä¾†
}

// ä½†å¯¦éš›ä¸Šï¼š
- è©ç¶´ â†’ Modifierï¼ˆéœ€è§£æï¼‰
- ç‹€æ…‹ â†’ Modifierï¼ˆéœ€è§£æï¼‰
- æŠ€èƒ½ â†’ Modifierï¼ˆéœ€è§£æï¼‰

// æ‰€ä»¥èšåˆç³»çµ±é›–ç„¶ä¸ import Affixï¼Œ
// ä½†å¯¦éš›ä¸Šä¾è³´ Affix ç³»çµ±çš„è¼¸å‡ºæ ¼å¼
// é€™æ˜¯éš±è—è€¦åˆ
```

### è»Ÿé«”å±¤é¢å•é¡Œ

**TypeScript å¯¦ç¾éœ€é¿å…å…¨å±€å–®ä¾‹**ï¼ˆinstructions.md ç¦æ­¢ï¼‰

ä½†è‹¥ä½¿ç”¨äº‹ä»¶ç¸½ç·šï¼Œå¯èƒ½å¼•å…¥éš±è—ä¾è³´

```
// å±éšªå¯«æ³•
class AffixSystem {
  constructor() {
    EventBus.getInstance().on('damage', this.handleDamage);
    // â†‘ éš±è—çš„å…¨å±€ä¾è³´
  }
}

// æ˜“å°è‡´ï¼š
- å–®å…ƒæ¸¬è©¦å›°é›£ï¼ˆéœ€ mock EventBusï¼‰
- å¾ªç’°ä¾è³´ï¼ˆèª°åˆå§‹åŒ– EventBusï¼Ÿï¼‰
- é‹è¡Œæ™‚é›£ä»¥è¿½è¹¤
```

**æ¸¬è©¦å›°é›£**

Affix è¡Œç‚ºæ¨¡çµ„è‹¥æœªæ¨¡çµ„åŒ–ï¼Œå–®å…ƒæ¸¬è©¦é›£ä»¥éš”é›¢

```
// é›£ä»¥æ¸¬è©¦çš„ä¾‹å­
class CombatEngine {
  tick() {
    // ç›´æ¥èª¿ç”¨å„ç³»çµ±
    this.affixSystem.trigger();
    this.statusSystem.update();
    this.damageCalculator.calculate();
    // ... 10 å€‹ç³»çµ±ç›´æ¥èª¿ç”¨

    // æ¸¬è©¦æ™‚éœ€æ§‹é€ æ‰€æœ‰ç³»çµ±
    // æ”¹ä¸€å€‹ç³»çµ±ï¼Œæ¸¬è©¦è¦å…¨æ”¹
  }
}
```

### å»ºè­°

**å¼·åŒ–ä»‹é¢å®šç¾©**

```typescript
// å®šç¾©æ¸…æ¥šçš„æ¥å£
interface IAffixResolver {
  parseAffixes(affixes: AffixInstance[]): Modifier[]
}

interface IStatusResolver {
  parseStatuses(statuses: StatusInstance[]): Modifier[]
}

interface IModifierAggregator {
  aggregate(modifiers: Modifier[]): Stats
}

// ä¾è³´æ³¨å…¥
class StatAggregationService {
  constructor(
    private affixResolver: IAffixResolver,
    private statusResolver: IStatusResolver,
    private aggregator: IModifierAggregator
  ) {}

  calculateStats(unit: Unit): Stats {
    const affixModifiers = this.affixResolver.parseAffixes(unit.affixes)
    const statusModifiers = this.statusResolver.parseStatuses(unit.statuses)

    return this.aggregator.aggregate([...affixModifiers, ...statusModifiers])
  }
}
```

**è£œå……è¡Œç‚ºæ¨¡çµ„çš„æŠ½è±¡å±¤**

```typescript
// å®šç¾©å¯æ›¿æ›çš„æ•ˆæœæ¨¡çµ„
interface IEffectModule {
  apply(context: EffectContext): void
}

// å…·é«”å¯¦ç¾
class ApplyStatusEffect implements IEffectModule {
  apply(context: EffectContext) {
    context.target.addStatus(this.statusId)
  }
}

class ModifyStatEffect implements IEffectModule {
  apply(context: EffectContext) {
    context.target.addModifier(this.modifier)
  }
}

// å®¹æ˜“æ¸¬è©¦å’Œæ“´å±•
```

---

## 2. Context è†¨è„¹èˆ‡è€¦åˆé¢¨éšª ğŸ”´

### å•é¡Œ

Context è¢«è¨­è¨ˆç‚ºæ‰€æœ‰ç‹€æ…‹çš„å”¯ä¸€çœŸç›¸

ä½†ç›®å‰æ‰€æœ‰æ±è¥¿éƒ½å¾€ Context å¡ï¼š

- å‹•æ…‹æ¬Šé‡
- è³½å‰è®Šæ•¸
- æˆ°é¬¥ç‹€æ…‹
- ç‰©å“
- è©ç¶´
- æ•µäººç”Ÿæˆåƒæ•¸
- ...

### çµæœ

**Context çµæ§‹æ¥µåº¦è¤‡é›œ**

```typescript
interface RunContext {
  // åŸºç¤
  chapterId: number
  difficulty: number

  // ç‹€æ…‹
  playerStats: Stats
  enemyPool: Enemy[]
  inventory: Item[]

  // è©ç¶´
  affixWeights: Record<string, number>
  affixModifiers: AffixModifier[]

  // æˆ°é¬¥
  currentBattle: Battle
  battleHistory: Battle[]

  // å…¶ä»–
  randomSeed: number
  timestamp: number

  // æ›´å¤š...
  [key: string]: any // å°è‡´é€™ç¨®å¯«æ³•
}

// Context è®Šæˆä»€éº¼éƒ½è£çš„åƒåœ¾æ¡¶
```

### ç¼ºé™·

**ç¼ºä¹ Context çš„åˆ†å±¤èˆ‡èšåˆç­–ç•¥**

- Context è®Šæˆã€Œå¤§é›œç‡´ã€
- Context æ¬„ä½é–“çš„ä¾è³´èˆ‡ä¸€è‡´æ€§è¦å‰‡æœªæ˜ç¢º
- å®¹æ˜“å‡ºç¾ã€ŒæŸæ¬„ä½æ”¹äº†ï¼Œå¦ä¸€æ¬„ä½æ²’åŒæ­¥ã€çš„ bug

### é¢¨éšª

- **ç‰ˆæœ¬å‡ç´šå›°é›£**ï¼šContext çµæ§‹æ”¹è®Šæ™‚å¾ˆé›£å…¼å®¹èˆŠè³‡æ–™
- **è·¨æœå‹™åŒæ­¥å›°é›£**ï¼šå¤šè¨­å‚™ç™»å…¥æ™‚è³‡æ–™ä¸ä¸€è‡´
- **ç¶­è­·æˆæœ¬é«˜**ï¼šé–‹ç™¼äººå“¡é›£ä»¥ç†è§£ Context å…§éƒ¨çµæ§‹
- **åºåˆ—åŒ–æ•ˆèƒ½**ï¼šContext è¶Šå¤§ï¼Œå­˜æª”/è®€æª”è¶Šæ…¢

### å»ºè­°

**è£œå…… Context åˆ†å±¤**

```typescript
// å±¤ 1ï¼šé‹è¡Œé…ç½®ï¼ˆæ°¸é ä¸è®Šï¼Œåªåœ¨é–‹å§‹æ™‚è¨­ç½®ï¼‰
interface RunConfig {
  chapterId: number
  difficulty: number
  randomSeed: number
  // ...åªæœ‰é…ç½®é …
}

// å±¤ 2ï¼šæŒä¹…ç‹€æ…‹ï¼ˆéœ€è¦å­˜æª”ï¼‰
interface PersistentState {
  playerStats: Stats
  inventory: Item[]
  affixes: AffixInstance[]
  // ...éŠæˆ²é€²åº¦ç›¸é—œ
}

// å±¤ 3ï¼šæˆ°é¬¥è‡¨æ™‚ç‹€æ…‹ï¼ˆä¸éœ€è¦å­˜æª”ï¼‰
interface BattleTemporaryState {
  currentBattle: Battle
  battleEventLog: Event[]
  statSnapshot: Stats
  // ...åƒ…åœ¨æˆ°é¬¥ä¸­ä½¿ç”¨
}

// å±¤ 4ï¼šè¡ç”Ÿæ•¸æ“šï¼ˆç”±å…¶ä»–å±¤è¨ˆç®—å¾—ä¾†ï¼‰
interface DerivedData {
  finalStats: Stats // è¨ˆç®—è‡ª PlayerStats + Affixes
  affixModifiers: Modifier[] // è¨ˆç®—è‡ª Affixes
  // çµ•ä¸ç›´æ¥ä¿®æ”¹é€™äº›
}

// çµ±ä¸€å…¥å£
interface GameContext {
  config: RunConfig
  persistent: PersistentState
  battle?: BattleTemporaryState
  derived: DerivedData // åªè®€
}
```

**è¨­è¨ˆ Context Schema ç‰ˆæœ¬ç®¡ç†**

```typescript
interface VersionedContext {
  schemaVersion: 2 // ç‰ˆæœ¬è™Ÿ
  config: RunConfig
  persistent: PersistentState

  // è¨˜éŒ„ä½•æ™‚æ”¹è®Š
  lastModified: number
  modificationLog?: Array<{
    version: number
    changes: string[]
  }>
}

// å‡ç´šç­–ç•¥
function migrateContext(oldContext: VersionedContext): VersionedContext {
  switch (oldContext.schemaVersion) {
    case 1:
      // å‡ç´šåˆ° 2
      return {
        ...oldContext,
        schemaVersion: 2,
        persistent: {
          ...oldContext.persistent,
          // æ–°å¢æ¬„ä½
          newField: defaultValue,
        },
      }
    default:
      return oldContext
  }
}
```

---

## 3. è³‡æ–™æŒä¹…åŒ–èˆ‡åºåˆ—åŒ–è¦å‰‡ä¸æ˜ç¢º âš ï¸

### å•é¡Œ

å¤šè™•æåˆ°ã€ŒContext æŒä¹…åŒ–ã€ã€ã€ŒAffixInstance/StatusInstance åºåˆ—åŒ–ã€

ä½†æ²’æœ‰æ˜ç¢ºè¦ç¯„ï¼š

- å“ªäº›æ¬„ä½å¿…é ˆå­˜ï¼Ÿ
- å“ªäº›åªåœ¨é‹ç®—æ™‚å­˜åœ¨ï¼Ÿ
- å¦‚ä½•è™•ç†å¾ªç’°å¼•ç”¨ï¼Ÿ
- ç‰ˆæœ¬æ§åˆ¶æ€éº¼åšï¼Ÿ

### ç¼ºé™·

```typescript
// æ··äº‚çš„ä¾‹å­
interface AffixInstance {
  // éœ€è¦å­˜ï¼Ÿ
  templateId: string
  rolledValue: number

  // éœ€è¦å­˜ï¼Ÿ
  trigger: EventType
  effects: Effect[]

  // éœ€è¦å­˜ï¼Ÿé‚„æ˜¯å³æ™‚è¨ˆç®—ï¼Ÿ
  currentModifiers: Modifier[]

  // éœ€è¦å­˜ï¼Ÿé‚„æ˜¯æˆ°é¬¥çµæŸå°±ä¸Ÿï¼Ÿ
  activationCount: number

  // ä¸éœ€è¦å­˜
  cachedResult?: Modifier[]
}

// åºåˆ—åŒ–æ™‚ï¼š
// JSON.stringify(affixInstance)
// çµæœå¯èƒ½åŒ…å«å¾ªç’°å¼•ç”¨ã€ä¸è©²å­˜çš„æ•¸æ“šç­‰
```

### é¢¨éšª

- **å¤šè¨­å‚™åŒæ­¥æ™‚å®¹æ˜“ç”¢ç”Ÿè³‡æ–™ä¸ä¸€è‡´ã€ç‰ˆæœ¬è¡çª**
- **æœªä¾†è³‡æ–™çµæ§‹è®Šå‹•æ™‚ï¼ŒèˆŠå­˜æª”ç„¡æ³•æ­£ç¢ºé‚„åŸ**
- **åºåˆ—åŒ–å°ºå¯¸éå¤§**ï¼šå­˜ä¸è©²å­˜çš„æ±è¥¿

### å»ºè­°

**è£œå……ã€ŒContext/Instance åºåˆ—åŒ–è¦ç¯„ã€**

```typescript
// å®šç¾©ä»€éº¼éœ€è¦åºåˆ—åŒ–
interface SerializableAffix {
  // å¿…é ˆå­˜
  templateId: string
  rolledValue: number

  // å¯é¸
  activationLog?: Array<{ tick: number; count: number }>
}

// åºåˆ—åŒ–å‡½æ•¸ï¼ˆé¡¯å¼æ§åˆ¶ï¼‰
function serializeAffix(affix: AffixInstance): SerializableAffix {
  return {
    templateId: affix.templateId,
    rolledValue: affix.rolledValue,
  }
}

// ååºåˆ—åŒ–å‡½æ•¸
function deserializeAffix(data: SerializableAffix, templatePool: Map<string, AffixTemplate>): AffixInstance {
  const template = templatePool.get(data.templateId)
  return new AffixInstance(template, data.rolledValue)
  // currentModifiers ç­‰åœ¨é‹è¡Œæ™‚è¨ˆç®—ï¼Œä¸å¾å­˜æª”æ¢å¾©
}

// ç‰ˆæœ¬ç®¡ç†
interface VersionedSerializableContext {
  version: 'v2' // æ˜ç¢ºç‰ˆæœ¬
  data: { // ... åºåˆ—åŒ–å¾Œçš„æ•¸æ“š }
}
```

---

## 4. ACLï¼ˆé˜²è…å±¤ï¼‰èˆ‡è·¨æ¨¡çµ„å”ä½œè¦å‰‡æœªæ˜ç¢º âš ï¸

### å•é¡Œ

æŒ‡ä»¤å¼·èª¿ã€Œé˜²è…å±¤ã€ã€ã€Œå–®å‘ä¾è³´ã€

ä½†ç›®å‰è—åœ–æœªæ˜ç¢ºï¼š

- å“ªäº›æ¨¡çµ„ä¹‹é–“å¿…é ˆç¶“é ACLï¼Ÿ
- å“ªäº›å¯ä»¥ç›´æ¥äº’èª¿ï¼Ÿ

### ç©ºç™½

ä¾‹å¦‚å•†åº—ã€å€‰åº«ã€é‡‘å¹£ã€äº¤æ˜“ç­‰ç³»çµ±å”ä½œæµç¨‹æœªç•«å‡º

```
? é‡‘å¹£ç³»çµ±èˆ‡å•†åº—çš„é—œä¿‚
? å€‰åº«èˆ‡è£å‚™ç³»çµ±çš„é—œä¿‚
? äº¤æ˜“ç³»çµ±çš„éš”é›¢æ–¹å¼
? å¤–éƒ¨ APIï¼ˆæ”¯ä»˜ã€ç¤¾äº¤ï¼‰å¦‚ä½•æ•´åˆè€Œä¸æ±¡æŸ“æ ¸å¿ƒ
```

### é¢¨éšª

- é–‹ç™¼æ™‚å®¹æ˜“é•åå–®å‘ä¾è³´ï¼Œç”¢ç”Ÿå¾ªç’°ä¾è³´æˆ–éš±è—è€¦åˆ
- æœªä¾†é‡æ§‹æ™‚é›£ä»¥æ‹†åˆ†å¾®æœå‹™

### å»ºè­°

**è£œå……ã€Œæ¨¡çµ„å”ä½œèˆ‡ ACL æµç¨‹åœ–ã€**

æ˜ç¢ºæ¨™è¨»æ‰€æœ‰è·¨æ¨¡çµ„å”ä½œå¿…ç¶“çš„é˜²è…å±¤

```
Domainï¼ˆç´”æ¥­å‹™é‚è¼¯ï¼‰
  â†“
Applicationï¼ˆèšåˆæœå‹™ï¼‰
  â†“
Adapterï¼ˆé˜²è…å±¤ï¼‰
  â†‘
  â””â”€â”€â”€ Infrastructureï¼ˆå¤–éƒ¨ç³»çµ±ï¼‰

ä¾‹å¦‚ï¼š
Shop éœ€è¦é‡‘å¹£ â†’ ShopAdapter â†’ CurrencyAdapter â†’ é‡‘å¹£ç³»çµ±
```

---

## æ¨™è¨˜

- æ ¸å¿ƒå•é¡Œï¼šä¾è³´æ³¨å…¥ã€Context åˆ†å±¤ã€åºåˆ—åŒ–ã€ACL
- å„ªå…ˆç´šï¼šğŸŸ¡ ä¸­ - å½±éŸ¿å¯ç¶­è­·æ€§èˆ‡æ“´å±•æ€§
- ç›¸ä¾æ¨¡çµ„ï¼šæ‰€æœ‰æ¨¡çµ„
