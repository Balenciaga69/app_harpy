# æˆ°é¬¥ç³»çµ±èˆ‡äº‹ä»¶ç³»çµ±

## 1. äº‹ä»¶ç³»çµ±ï¼ˆEvent Systemï¼‰æŠ½è±¡èˆ‡ä¸€è‡´æ€§åš´é‡ä¸è¶³ ğŸ”´

### å•é¡Œ

è—åœ–å¤šæ¬¡æåˆ°ã€Œäº‹ä»¶ç›£è½ã€ã€ã€Œäº‹ä»¶ç®¡ç†å™¨ã€ã€ã€Œäº‹ä»¶è§¸ç™¼ã€ç­‰

**ä½†æ²’æœ‰æ˜ç¢ºå®šç¾©ï¼š**

- äº‹ä»¶çš„çµæ§‹
- äº‹ä»¶çš„ç”Ÿå‘½é€±æœŸ
- è¨»å†Š/åè¨»å†Šæ©Ÿåˆ¶
- å„ªå…ˆç´šã€æ””æˆªã€å–æ¶ˆç­‰é€²éšæ©Ÿåˆ¶

### ç¾ç‹€

Affixã€Statusã€æŠ€èƒ½ç­‰éƒ½ä¾è³´äº‹ä»¶ç³»çµ±ä¾†è§¸ç™¼æ•ˆæœ

ä½†ç›®å‰æ²’æœ‰ä¸€ä»½çµ±ä¸€çš„äº‹ä»¶é¡å‹ã€è³‡æ–™çµæ§‹ã€å‚³éæ–¹å¼èªªæ˜

### é¢¨éšª

- äº‹ä»¶ç³»çµ±è‹¥æœªçµ±ä¸€ï¼Œæœƒå°è‡´å„æ¨¡çµ„å„è‡ªç‚ºæ”¿
- æ¸¬è©¦èˆ‡é™¤éŒ¯æ¥µå›°é›£
- äº‹ä»¶å¾ªç’°ä¾è³´ã€é‡å…¥ã€éºæ¼è§¸ç™¼ç­‰ bug é¢¨éšªæ¥µé«˜

### ç¼ºå£

combat.blueprint.md æåŠã€Œäº‹ä»¶ç®¡ç†å™¨ã€ï¼Œä½†æœªå®šç¾©å…¶æ¶æ§‹

```
? äº‹ä»¶å¦‚ä½•è¨»å†Šï¼Ÿ
  - å…¨å±€ç›£è½ï¼Ÿ
  - æŒ‰ Unit ç›£è½ï¼Ÿ
  - æŒ‰äº‹ä»¶é¡å‹ç›£è½ï¼Ÿ

? äº‹ä»¶å¦‚ä½•è§¸ç™¼ï¼Ÿ
  - åŒæ­¥è§¸ç™¼ï¼Ÿ
  - éåŒæ­¥è§¸ç™¼ï¼Ÿ
  - æœ‰å„ªå…ˆç´šå—ï¼Ÿ

? äº‹ä»¶å¯ä»¥è¢«å–æ¶ˆå—ï¼Ÿ
  - ON_DAMAGE äº‹ä»¶å¯ä»¥è¢«æ””æˆªè®Šæˆ 0 å—ï¼Ÿ
  - å¤šå€‹ç›£è½è€…çš„åŸ·è¡Œé †åºï¼Ÿ

? äº‹ä»¶å¾ªç’°ä¾è³´æ€éº¼é˜²æ­¢ï¼Ÿ
  - Event A è§¸ç™¼ Event B
  - Event B åˆè§¸ç™¼ Event A
  - ç„¡é™è¿´åœˆï¼Ÿ

? æˆ°é¬¥é‡æ’­æ™‚æ€éº¼è™•ç†ï¼Ÿ
  - äº‹ä»¶åºåˆ—å¯é‡æ’­å—ï¼Ÿ
  - éš¨æ©Ÿæ€§æ€éº¼æ§åˆ¶ï¼Ÿ
```

### å»ºè­°

**éœ€è£œå……ä¸€ä»½ã€Œäº‹ä»¶ç³»çµ±è—åœ–ã€**

æ˜ç¢ºå®šç¾©ï¼š

- äº‹ä»¶é¡å‹åˆ—è¡¨
- äº‹ä»¶è³‡æ–™çµæ§‹
- è¨»å†Š/è§¸ç™¼/å–æ¶ˆæµç¨‹
- èˆ‡ Affix/Status çš„æ•´åˆæ–¹å¼
- äº‹ä»¶å„ªå…ˆç´šèˆ‡åŸ·è¡Œé †åº

**ç¯„ä¾‹çµæ§‹ï¼š**

```typescript
// äº‹ä»¶å®šç¾©
interface Event {
  type: EventType
  sourceUnit: Unit
  targetUnit?: Unit
  timestamp: number

  // é˜²æ­¢é‡å…¥
  preventPropagation?: () => void
  isPropagationStopped?: boolean

  // è³‡æ–™è² è¼‰
  data: Record<string, any>
}

enum EventType {
  ON_HIT,
  ON_DAMAGE_TAKEN,
  ON_HEAL,
  ON_STATUS_APPLIED,
  ON_STATUS_REMOVED,
  ON_STAT_CHANGED,
  // ... ç­‰ç­‰
}

// ç›£è½è€…è¨»å†Š
interface EventListener {
  eventType: EventType
  priority: number // é«˜å„ªå…ˆç´šå…ˆåŸ·è¡Œ
  handler: (event: Event) => void
}

// äº‹ä»¶ç®¡ç†å™¨
interface EventManager {
  on(eventType: EventType, handler, priority?: number): void
  off(eventType: EventType, handler): void
  emit(event: Event): void
  // å¯é‡æ”¾äº‹ä»¶åˆ—è¡¨
  getEventLog(): Event[]
}
```

---

## 2. æˆ°é¬¥ç³»çµ±èˆ‡ Affix è§¸ç™¼çš„æ•´åˆç©ºç™½ âš ï¸

### å•é¡Œ

combat.blueprint.md æ¡ç”¨ Tick-based è¨­è¨ˆï¼Œäº‹ä»¶è™•ç†é †åºåš´æ ¼

ä½† **Affix çš„è§¸ç™¼ï¼ˆe.g., ON_HIT äº‹ä»¶ï¼‰å¦‚ä½•åµŒå…¥ Tick æµç¨‹ï¼Ÿ**

### ç©ºç™½æ¡ˆä¾‹

```
Tick åŸ·è¡Œæµç¨‹ï¼š
1. è¡Œç‚ºè½‰ Event
2. Event è™•ç†ï¼ˆå‚·å®³ï¼‰
3. ç‹€æ…‹ç³»çµ±
4. å±¬æ€§èšåˆ
5. ç”Ÿæ­»åˆ¤å®š

? åœ¨å“ªä¸€æ­¥è§¸ç™¼ Affix ON_HITï¼Ÿ
  - ç¬¬ 1 æ­¥è½‰ Event æ™‚ï¼Ÿ
  - ç¬¬ 2 æ­¥ç®—å‚·å®³æ™‚ï¼Ÿ
  - ç¬¬ 3 æ­¥ï¼Ÿ

? ailment.blueprint.md èªªç‹€æ…‹è™•ç†åœ¨ç‰¹å®š Tick éšæ®µ
  - Affix è¡Œç‚ºï¼ˆå¦‚ APPLY_STATUSï¼‰æ˜¯å¦åŒæ­¥è™•ç†ï¼Ÿ
  - é‚„æ˜¯ç•°æ­¥å…¥éšŠï¼Ÿ

? è‹¥ Affix è§¸ç™¼å°è‡´ç‹€æ…‹è®ŠåŒ–ï¼Œå¦‚ä½•é¿å…å¾ªç’°ä¾è³´ï¼Ÿ
  ä¾‹å¦‚ï¼š
  - ç‹€æ…‹å½±éŸ¿å±¬æ€§èšåˆ
  - åéä¾†å½±éŸ¿è§¸ç™¼æ¢ä»¶
  - å°è‡´ç„¡é™è¿´åœˆï¼Ÿ
```

### è»Ÿé«”å±¤é¢å•é¡Œ

- Tick åŒæ­¥åŸ·è¡Œï¼Œè‹¥äº‹ä»¶éšŠåˆ—éé•·ï¼Œå¯èƒ½é˜»å¡ä¸»åŸ·è¡Œç·’
- äº‹ä»¶ç›£è½å™¨è‹¥æœªè§£è€¦ï¼Œå®¹æ˜“ç”¢ç”Ÿéš±è—ä¾è³´

### å»ºè­°

1. **åœ¨ combat.blueprint.md è£œå……è©³ç´° Tick æµç¨‹**

åŒ…æ‹¬ï¼š

- ä½•æ™‚è§¸ç™¼äº‹ä»¶
- ä½•æ™‚åŸ·è¡Œ Affix è¡Œç‚º
- äº‹ä»¶éšŠåˆ—çš„è™•ç†é †åº

2. **å¼•å…¥äº‹ä»¶éšŠåˆ—èˆ‡å„ªå…ˆç´š**

```typescript
class TickExecutor {
  execute(tick: Tick) {
    // éšæ®µ 1ï¼šäº‹ä»¶éšŠåˆ—
    const events = this.collectEvents(tick)

    // éšæ®µ 2ï¼šæŒ‰å„ªå…ˆç´šè™•ç†
    events
      .sort((a, b) => a.priority - b.priority)
      .forEach((event) => {
        this.eventManager.emit(event)

        // ç«‹å³è™•ç†åŒå„ªå…ˆç´šçš„è¡ç”Ÿäº‹ä»¶
        while (this.hasMoreEventsAtPriority(event.priority)) {
          this.processNextEvent()
        }
      })

    // éšæ®µ 3ï¼šç‹€æ…‹ç³»çµ±
    this.updateStatus()

    // éšæ®µ 4ï¼šå±¬æ€§èšåˆï¼ˆå¿«ç…§ï¼‰
    this.aggregateStats()

    // éšæ®µ 5ï¼šç”Ÿæ­»åˆ¤å®š
    this.checkDeaths()
  }
}
```

3. **é˜²æ­¢å¾ªç’°ä¾è³´**

ä½¿ç”¨ Snapshot Statsï¼ˆè¦‹ [ç‹€æ…‹èˆ‡å±¬æ€§èšåˆ](03_ç‹€æ…‹èˆ‡å±¬æ€§èšåˆ.md)ï¼‰

ç‹€æ…‹è®ŠåŒ–åªåœ¨ä¸‹ä¸€ Tick ç”Ÿæ•ˆï¼Œè‡ªç„¶é¿å…åŒ Tick å…§çš„è¿´åœˆ

---

## 3. Enemy / Boss / Endlessï¼šæ¨¡å¼èˆ‡æ¨¡æ¿çš„æ··äº‚ âš ï¸

### å•é¡Œ

ä½ å¤šæ¬¡æåˆ°ï¼š

> ä¸åŒèº«ä»½æ™‚ Affix ç–ŠåŠ æ–¹å¼å¯«åœ¨æ¨¡æ¿ä¸­

### æ ¹æœ¬è¡çª

```
// ç¾ç‹€
EnemyTemplate {
  baseStats: {...},
  affixRules: {
    normal: {...},
    elite: {...},
    boss: {...},
    endless: {...},  // ğŸ‘ˆ é€™è£¡å·²ç¶“æ··é€²å»äº†
  }
}

// å•é¡Œï¼š
// 1. æ¨¡æ¿æ‡‰è©²æ˜¯æ­»çš„
// 2. æ¨¡å¼æ‡‰è©²æ˜¯æ´»çš„
// 3. ç‚ºä»€éº¼åœ¨æ¨¡æ¿è£¡å¯«æ¨¡å¼ï¼Ÿ

// Endless mode èªªã€Œæ‰€æœ‰ç¯€é»éƒ½æ˜¯ Bossã€
// ä½† Boss è¡Œç‚ºå¯«åœ¨ Enemy Template
// é‚£ Endless æ˜¯æ”¹æ¨¡æ¿ï¼Ÿé‚„æ˜¯å¥—è¦å‰‡ï¼Ÿ
```

### å±éšªæ¡ˆä¾‹

```
// é€™æ¨£çš„ä»£ç¢¼é²æ—©æœƒå‡ºç¾ï¼š
if (isEndless && isBoss) {
  applyEndlessRules();
  applyBossRules();
  // ä½†å®ƒå€‘è¡çªäº†æ€éº¼è¾¦ï¼Ÿ
  // èª°å„ªå…ˆï¼Ÿ
} else if (isBoss) {
  applyBossRules();
}
```

### å»ºè­°ï¼šå¼·åˆ¶åˆ†å±¤

```typescript
// å±¤ 1ï¼šæ¨¡æ¿ï¼ˆæ°¸é æ˜¯æ­»çš„ï¼‰
interface EnemyTemplate {
  id: string
  baseStats: Stats
  affixes: AffixId[] // éœæ…‹ Affix
  maxCapacity: {
    elite: number // Elite æœ€å¤šåŠ  +50% HP
    boss: number // Boss æœ€å¤šåŠ  +200% HP
  }
}

// å±¤ 2ï¼šè§’è‰²é…ç½®ï¼ˆå®šç¾©å„è§’è‰²çš„è¦å‰‡ï¼‰
interface EnemyRoleConfig {
  role: 'Normal' | 'Elite' | 'Boss'
  multiplier: {
    hp: number
    damage: number
    armor: number
  }
  additionalAffixes: AffixId[] // åƒ…æ­¤è§’è‰²é™„åŠ çš„ Affix
  statusResistance?: Record<StatusType, number>
}

// å±¤ 3ï¼šæ¨¡å¼é…ç½®ï¼ˆå®šç¾©å„æ¨¡å¼çš„è¦å‰‡ï¼‰
interface GameModeConfig {
  mode: 'Normal' | 'Endless' | 'Challenge'
  roleConfigs: Record<EnemyRole, RoleModifier>
  specialRules?: SpecialRule[]
}

// å±¤ 4ï¼šå¯¦ä¾‹åŒ–æ™‚çµ„åˆ
function instantiateEnemy(template: EnemyTemplate, role: EnemyRole, mode: GameMode): EnemyInstance {
  const baseStats = applyRole(template.baseStats, role)
  const statsWithMode = applyMode(baseStats, role, mode)

  const affixes = [...template.affixes, ...getRoleAffixes(role), ...getModeAffixes(role, mode)]

  return new EnemyInstance(statsWithMode, affixes)
}
```

**å¥½è™•ï¼š**

- æ¨¡æ¿æ°¸é ä¸è®Š
- è¦å‰‡åˆ†å±¤æ¸…æ¥š
- æ–°å¢æ¨¡å¼æ™‚åªæ”¹ GameModeConfig
- ç„¡éœ€æ”¹ Template æˆ– RoleConfig
- æ²’æœ‰ `if (isEndless && isBoss)` é€™ç¨®å™©å¤¢

---

## æ¨™è¨˜

- æ ¸å¿ƒå•é¡Œï¼šäº‹ä»¶ç³»çµ±ä¸æ¸…ã€Tick æµç¨‹ä¸æ¸…ã€æ¨¡å¼æ··äº‚
- å„ªå…ˆç´šï¼šğŸ”´ é«˜ - å½±éŸ¿æˆ°é¬¥æ ¸å¿ƒé‚è¼¯
- ç›¸ä¾æ¨¡çµ„ï¼šAffix ç³»çµ±ã€ç‹€æ…‹ç³»çµ±ã€æ•µäººç”Ÿæˆ
