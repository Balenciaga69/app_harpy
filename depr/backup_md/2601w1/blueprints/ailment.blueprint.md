# 異常狀態 (Ailment)設計

## 語意級

### 核心設計理念

異常狀態系統圍繞三個核心機制展開:

1. 層數堆疊 (Stack Accumulation)
   - 相同異常狀態層數直接加總, 不分來源
   - 多個來源提供同一異常狀態 → 直接累加層數
   - 參考《Backpack Battles》機制, 簡化設計
2. 觸發消耗 (Trigger & Decay)
   - 異常狀態在每個 Tick 產生效果 (如扣血, 減速)
   - 可設定自動遞減層數 (如每 1000 Tick 衰減 10%)
   - 觸發條件由事件系統管理, 而非獨立計時器
3. 異常-裝備連動 (Ailment-Equipment Synergy)
   - 遊戲核心玩法:異常狀態觸發裝備被動效果
   - 敵人中毒 → 我的裝備 A 觸發吸血
   - 需要高效事件監聽系統支撐

### 異常狀態列表與數值設計

#### 中毒 (Poison)

- 層數效果:1 層 = -1 HP (持續傷害, 無層數上限)
- 衰減規則:每 1000 Tick 衰減 10% (最少 -10 層)
- 觸發條件:來自詞綴, 技能或敵人特性
- 特性:純數值累加, 與來源無關

#### 冰緩 (Chill)

- 層數效果:1 層 = -1% 攻擊速度 (上限 64 層)
- 衰減規則:每 1000 Tick 衰減 1 層, 同時攻擊也 -1 層
- 屬性影響:直接修改 attackSpeed, attackDamage
- 反應機制:玩家裝備可針對冰緩提供增益

#### 充能 (Charge)

- 層數效果:1 層 = +1% 攻擊速度 (上限 64 層)
- 衰減規則:每 1000 Tick 衰減 1 層, 攻擊也 -1 層
- 屬性影響:與冰緩相反, 增強攻擊性能
- 疊加:與冰緩層數可同時存在

#### 焦油

- 層數效果:1 層 (上限 1 層)
- 衰減規則:受到火屬性傷害後移除
- 屬性影響:當受到火屬性攻擊, 同時附加當前生命 10% 可減傷的傷害
- 疊加:只有一層

#### 致殘

- 層數效果:1 層 = -4% 閃避 (上限 16 層)
- 衰減規則:每 1000 Tick 衰減 1 層, 被攻擊也 -1 層
- 屬性影響:修改閃避率

#### 靈活

- 層數效果:1 層 = +4% 閃避 (上限 16 層)
- 衰減規則:每 1000 Tick 衰減 1 層, 被攻擊也 -1 層
- 屬性影響:修改閃避率

#### 破損

- 層數效果:1 層 = +4% 減免 (上限 16 層)
- 衰減規則:每 1000 Tick 衰減 1 層, 被攻擊也 -1 層
- 屬性影響:修改減免率

#### 護盾 (Shield)

- 層數效果:1 層 = 下次受到傷害 - 1 點 (無上限)
- 衰減規則:不自動遞減, 僅在接收傷害時消耗層數
- 屬性影響:無直接屬性影響, 作為被動傷害減免機制
- 特性說明:
  - 護盾層數直接抵消傷害, 每 1 點傷害消耗 1 層護盾
  - 異常狀態傷害 (如中毒)可穿透護盾, 直接造成傷害
  - 真實傷害無法穿透護盾, 護盾仍可減免

### 時序與偏移機制

異常狀態處理涉及全場多個單位 (20+ 個), 需要時序優化:

#### 問題分析

- 同步風險:如無時序偏移, 所有單位在同一毫秒「吸氣」 (同時觸發扣血, 遞減)
  - CPU 壓力瞬間飆高
  - 視覺上所有血條同時抖動, 顯得生硬不自然
- 解決方案:Tick 偏移 (Offset)
  - 每個單位的異常狀態管理根據生成時間設置 0~1000ms 的隨機偏移
  - 使全場單位的狀態處理「呼吸」分散開來
  - CPU 負載平穩分佈, 視覺效果自然流暢

## 架構級

### 異常狀態配置 (Ailment Template)

靜態定義, 由設計師配置 存儲異常狀態的核心參數與行為規則:

#### 基本欄位

- ID, 名稱, 類型 (Poison / Chill / Charge / Blind / Bleed / Shield 等)
- 視覺表現 (圖示, 顏色, 動畫)

#### 層數規則

- 是否可疊加, 最大/最小層數限制
- 衰減方式 (固定值 / 百分比), 衰減週期 (Tick 數)

#### 效果規則

- 單層效果數值
- 屬性修飾類型 (Add / Multi / More)
- 觸發條件與事件綁定

### 異常狀態實例 (Ailment Instance)

運行時實例, 儲存在單位的戰鬥 Context 中, 表示該單位當前承受的異常狀態狀態

#### 關鍵欄位

- `ailmentTemplateId`:指向對應的異常狀態配置
- `currentStack`:當前層數
- `source`:狀態來源 (詞綴 ID, 技能 ID, 敵人特性 ID 等)
- `appliedTime`:應用時間戳, 用於計算 Tick 偏移
- `decayTick`:距離下次衰減的 Tick 計數

#### 生命週期

- **創建**:詞綴或事件觸發時
- **更新**:每 Tick 檢查衰減條件並更新層數
- **銷毀**:層數降至 0 或戰鬥結束時清除

### 事件監聽與異常-裝備連動

異常狀態效果通過事件系統觸發裝備被動反應, 實現異常與裝備詞綴的聯動機制

#### 典型監聽事件

- `ON_POISON_APPLIED`:敵人受到中毒 → 玩家裝備可觸發吸血等效果
- `ON_CHILL_STACK_CHANGE`:冰緩層數變化 → 更新屬性聚合結果
- `ON_BLEED_TRIGGER`:流血觸發傷害 → 玩家裝備可觸發額外暴擊

#### 性能優化策略

- 使用選擇器模式 (Selector Pattern)過濾監聽器, 避免全表掃描
- 批量更新屬性聚合結果, 減少單位計算頻率

## 代碼級

### 異常狀態配置定義 (JSON 範例)

```json
{
  "id": "poison",
  "name": "中毒",
  "type": "debuff",
  "stackable": true,
  "maxStack": null,
  "minStack": 0,
  "decayMode": "percentage",
  "decayValue": 10,
  "decayPeriod": 1000,
  "effectPerStack": {
    "type": "damage",
    "value": 1
  }
}
```

### 核心邏輯流程

#### 應用異常狀態

當詞綴或事件觸發異常狀態時的處理流程:

1. 詞綴或事件觸發 → 發起 `APPLY_AILMENT` 行為
2. 查詢或創建 `AilmentInstance`
3. 若已存在相同異常 → 層數直接累加 (`currentStack += newStack`)
4. 若新建實例 → 初始化並設置隨機 Tick 偏移 (0~1000ms)
5. 註冊事件監聽器 (供裝備詞綴反應)
6. 更新屬性聚合結果

#### 每 Tick 異常狀態處理

在戰鬥的每個 Tick 週期中, 對異常狀態進行定期更新:

1. 遍歷該單位所有 `AilmentInstance`
2. 根據 Tick 偏移, 判斷本 Tick 是否觸發效果
3. 執行效果 (扣血, 減速, 增益等)
4. 檢查衰減條件, 更新 `currentStack`
5. 若層數達到 0, 移除該異常實例
6. 廣播事件 (`ON_AILMENT_CHANGE` 等), 觸發裝備監聽器反應

#### 時序偏移實現

為避免同步問題, 使用隨機偏移分散異常狀態處理:

```typescript
offset = random(0, 1000)
if (currentTick % 1000 === offset) {
  // 執行本單位的異常狀態效果
  applyAilmentEffect()
  checkDecay()
}
```

### 防腐層 (Anti-Corruption Layer, ACL)

異常狀態系統與裝備系統間的耦合應通過事件系統進行隔離, 避免直接引用關係 修改異常狀態規則時, 僅需更新監聽器邏輯, 無需修改裝備模組的核心代碼
