# Combat æ¨¡çµ„ä¾è³´åˆ†æå ±å‘Š

## å•é¡Œæª¢æ¸¬

AI æå‡ºçš„ä¸‰å€‹å•é¡Œï¼š

1. **character â†” effect â†” damage å½¢æˆå¾ªç’°**
2. **ICombatHook åœ¨ damage æ¨¡çµ„ï¼Œä½†è¢« effect å¯¦ä½œ**
3. **CombatContext åŒæ™‚ç®¡ç†å¯¦é«”ã€äº‹ä»¶ã€RNG**

---

## ä¾è³´é—œä¿‚å¯¦éš›ç‹€æ³

### 1. Character â†” Effect â†” Damage å¾ªç’°ä¾è³´åˆ†æ

#### å¯¦éš›ä¾è³´éˆï¼š

```
character/character.ts
  â”œâ”€> effect/effect.manager.ts (å¯¦ä¾‹)
  â”œâ”€> effect/models/effect.model.ts (IEffect interface)
  â””â”€> context/combat.context.ts (é¡å‹)

effect/effect.model.ts
  â”œâ”€> character/interfaces/character.interface.ts (ICharacter interface)
  â””â”€> context/combat.context.ts (é¡å‹)

effect/Implementation/ChargedCriticalEffect.ts
  â”œâ”€> effect/models/effect.model.ts (IEffect interface)
  â”œâ”€> damage/models/combat.hook.interface.ts (ICombatHook interface)
  â”œâ”€> damage/models/damage.event.model.ts (DamageEvent é¡å‹)
  â”œâ”€> character/interfaces/character.interface.ts (ICharacter interface)
  â””â”€> context/combat.context.ts (é¡å‹)

damage/models/damage.event.model.ts
  â””â”€> character/interfaces/character.interface.ts (ICharacter interface)

damage/damage.chain.ts
  â”œâ”€> damage/models/* (å…§éƒ¨æ¨¡å‹)
  â””â”€> context/combat.context.ts (é¡å‹)

damage/steps/utils/hookCollector.util.ts
  â”œâ”€> character/interfaces/character.interface.ts (ICharacter interface)
  â””â”€> damage/models/combat.hook.interface.ts (ICombatHook interface)
```

#### å¾ªç’°åˆ¤å®šï¼š

**âŒ ä¸å­˜åœ¨çœŸæ­£çš„å¾ªç’°ä¾è³´**

åŸå› åˆ†æï¼š

1. **Character â†’ Effect**: Character ä¾è³´ IEffect **æ¥å£**ï¼ˆæŠ½è±¡ï¼‰
2. **Effect â†’ Character**: Effect ä¾è³´ ICharacter **æ¥å£**ï¼ˆæŠ½è±¡ï¼‰
3. **Effect â†’ Damage**: Effect å¯¦ç¾ä¾è³´ ICombatHook **æ¥å£**ï¼ˆæŠ½è±¡ï¼‰
4. **Damage â†’ Character**: Damage ä¾è³´ ICharacter **æ¥å£**ï¼ˆæŠ½è±¡ï¼‰

**é—œéµé»**ï¼šæ‰€æœ‰ä¾è³´éƒ½æ˜¯ **æ¥å£ä¾è³´**ï¼Œè€Œé **å¯¦ç¾ä¾è³´**

é€™ç¬¦åˆ **ä¾è³´åè½‰åŸå‰‡ (DIP)**ï¼š

- é«˜å±¤æ¨¡çµ„ä¸ä¾è³´ä½å±¤æ¨¡çµ„
- å…©è€…éƒ½ä¾è³´æŠ½è±¡ï¼ˆæ¥å£ï¼‰
- æŠ½è±¡ä¸ä¾è³´ç´°ç¯€

---

### 2. ICombatHook åœ¨ damage æ¨¡çµ„ï¼Œä½†è¢« effect å¯¦ä½œ

#### å•é¡Œæœ¬è³ªï¼š

```
logic/damage/models/combat.hook.interface.ts  <-- æ¥å£å®šç¾©
         â†‘
         | implements
         |
domain/effect/Implementation/ChargedCriticalEffect.ts  <-- æ¥å£å¯¦ç¾
```

#### é€™æ˜¯å•é¡Œå—ï¼Ÿ

**âœ… ä¸æ˜¯å•é¡Œï¼Œé€™æ˜¯è¨­è¨ˆæ¨¡å¼çš„æ­£ç¢ºæ‡‰ç”¨**

é€™æ˜¯ **ä¾è³´åè½‰åŸå‰‡ (DIP)** çš„æ¨™æº–æ‡‰ç”¨ï¼š

1. **damage æ¨¡çµ„å®šç¾©å¥‘ç´„ï¼ˆæ¥å£ï¼‰**
   - `ICombatHook` æ˜¯ damage è¨ˆç®—æµç¨‹çš„æ“´å±•é»
   - damage æ¨¡çµ„èªªï¼šã€Œæˆ‘ä¸ç®¡ä½ æ˜¯èª°ï¼Œåªè¦ä½ å¯¦ç¾é€™äº›æ–¹æ³•ï¼Œå°±èƒ½ä»‹å…¥æˆ‘çš„æµç¨‹ã€

2. **effect æ¨¡çµ„å¯¦ç¾å¥‘ç´„**
   - Effect å¯¦ç¾ `ICombatHook` æ¥å£
   - Effect ä¸»å‹•é©é… damage çš„å¥‘ç´„

3. **ä¾è³´æ–¹å‘æ­£ç¢º**
   ```
   domain/effect  â”€depends onâ”€>  logic/damage (interface only)
                                        â†“
                                   å®šç¾©æ“´å±•å¥‘ç´„
   ```

#### é€™å€‹è¨­è¨ˆçš„å„ªé»ï¼š

- âœ… **é–‹æ”¾å°é–‰åŸå‰‡ (OCP)**ï¼šæ–°å¢æ•ˆæœä¸éœ€ä¿®æ”¹ damage æ¨¡çµ„
- âœ… **ä¾è³´åè½‰åŸå‰‡ (DIP)**ï¼šé«˜å±¤ï¼ˆdamageï¼‰å®šç¾©æ¥å£ï¼Œä½å±¤ï¼ˆeffectï¼‰å¯¦ç¾æ¥å£
- âœ… **å–®ä¸€è·è²¬åŸå‰‡ (SRP)**ï¼šdamage å°ˆæ³¨è¨ˆç®—æµç¨‹ï¼Œeffect å°ˆæ³¨æ•ˆæœé‚è¼¯
- âœ… **ä½è€¦åˆ**ï¼šdamage ä¸çŸ¥é“å…·é«”æœ‰å“ªäº› effectï¼ŒåªçŸ¥é“æ¥å£

#### å±¤ç´šåˆç†æ€§åˆ†æï¼š

æ ¹æ“šä½ çš„åˆ†å±¤æ¶æ§‹ï¼š

- `domain/` - é ˜åŸŸæ¨¡å‹å±¤
- `logic/` - æ¥­å‹™é‚è¼¯å±¤

**å•é¡Œ**ï¼š`ICombatHook` æ”¾åœ¨ `logic/damage` æ˜¯å¦åˆç†ï¼Ÿ

**åˆ†æ**ï¼š

- `ICombatHook` æ˜¯ä¸€å€‹è¡Œç‚ºå¥‘ç´„ï¼ˆæ¥å£ï¼‰
- å®ƒå®šç¾©äº†å¦‚ä½•ä»‹å…¥å‚·å®³è¨ˆç®—æµç¨‹
- å®ƒæœ¬è³ªä¸Šæ˜¯ damage é‚è¼¯çš„ä¸€éƒ¨åˆ†

**çµè«–**ï¼š

- âœ… æ”¾åœ¨ `logic/damage` æ˜¯åˆç†çš„
- ä½†å¦‚æœä½ æƒ³æ›´è§£è€¦ï¼Œå¯ä»¥è€ƒæ…®å°‡æ¥å£æå‡åˆ° `infra/shared/interfaces/`

---

### 3. CombatContext åŒæ™‚ç®¡ç†å¯¦é«”ã€äº‹ä»¶ã€RNG

#### ç•¶å‰ CombatContext è·è²¬ï¼š

```typescript
export class CombatContext {
  public readonly eventBus: EventBus // è·è²¬1: äº‹ä»¶ç®¡ç†
  public readonly rng: CombatRandomGenerator // è·è²¬2: éš¨æ©Ÿæ•¸ç®¡ç†
  private currentTick: number = 0 // è·è²¬3: æ™‚é–“ç®¡ç†
  private entities: Map<string, IEntity> // è·è²¬4: å¯¦é«”ç®¡ç†

  // + Entity ç®¡ç†æ–¹æ³• (5å€‹)
  // + Tick ç®¡ç†æ–¹æ³• (3å€‹)
}
```

#### é€™æ˜¯å•é¡Œå—ï¼Ÿ

**ğŸŸ¡ æœ‰è¼•å¾®çš„è·è²¬æ··åˆï¼Œä½†å¯æ¥å—**

#### åˆ†æï¼š

**å–®ä¸€è·è²¬åŸå‰‡ (SRP)** åˆ¤å®šï¼š

- â“ æ˜¯å¦é•å SRPï¼Ÿ**çœ‹å®šç¾©**
  - å¦‚æœ CombatContext çš„è·è²¬æ˜¯ã€Œæˆ°é¬¥ä¸Šä¸‹æ–‡å®¹å™¨ã€ï¼Œé‚£å®ƒæŒæœ‰é€™äº›æ˜¯åˆç†çš„
  - å¦‚æœæ¯å€‹å­è·è²¬éƒ½ç¨ç«‹è®ŠåŒ–ï¼Œé‚£æ‡‰è©²æ‹†åˆ†

**å¯¦éš›æƒ…æ³**ï¼š

- EventBusã€RNGã€Tickã€Entities éƒ½æ˜¯æˆ°é¬¥çš„**å…±äº«è³‡æº**
- å®ƒå€‘åœ¨æˆ°é¬¥ä¸­**ä¸€èµ·åˆå§‹åŒ–ã€ä¸€èµ·éŠ·æ¯€**
- å®ƒå€‘çš„ç”Ÿå‘½é€±æœŸ**å®Œå…¨ä¸€è‡´**

**çµè«–**ï¼š

- âœ… CombatContext ä½œç‚º **Service Locator** æ¨¡å¼æ˜¯åˆç†çš„
- âœ… å®ƒçš„è·è²¬æ˜¯ã€Œæä¾›æˆ°é¬¥å…±äº«è³‡æºçš„è¨ªå•é»ã€
- âš ï¸ ä½†å¯ä»¥è€ƒæ…®æ›´ç´°ç²’åº¦çš„è¨­è¨ˆï¼ˆè¦‹ä¸‹æ–¹å»ºè­°ï¼‰

---

## æ¶æ§‹è©•ä¼°ç¸½çµ

### å¾ªç’°ä¾è³´æª¢æŸ¥ï¼šâŒ ç„¡å¾ªç’°ä¾è³´

```
å¯¦éš›ä¾è³´åœ–ï¼ˆç°¡åŒ–ç‰ˆï¼‰ï¼š

infra/shared (interfaces)
    â†‘
    â”œâ”€â”€â”€ context (CombatContext)
    â†‘         â†‘
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ domain/character (ICharacter, Character)
    â†‘         â†‘              â†‘
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ domain/effect (IEffect, EffectManager)
    â†‘         â†‘              â†‘              â†‘
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€ logic/damage (DamageChain, ICombatHook)
                                                        â†‘
                                                        â””â”€â”€â”€ coordination/ability
                                                                    â†‘
                                                                    â””â”€â”€â”€ combat-engine
```

**æ‰€æœ‰ä¾è³´éƒ½æ˜¯å–®å‘çš„ï¼Œå‘ä¸Šä¾è³´ï¼Œç„¡å¾ªç’°ï¼**

---

### é•ååŸå‰‡æª¢æŸ¥ï¼š

| åŸå‰‡               | æ˜¯å¦é•å | èªªæ˜                             |
| ------------------ | -------- | -------------------------------- |
| **SRP** (å–®ä¸€è·è²¬) | âš ï¸ éƒ¨åˆ†  | CombatContext è·è²¬ç•¥å¤šï¼Œä½†å¯æ¥å— |
| **OCP** (é–‹æ”¾å°é–‰) | âœ… ç¬¦åˆ  | ICombatHook æ©Ÿåˆ¶å…è¨±æ“´å±•è€Œä¸ä¿®æ”¹ |
| **LSP** (é‡Œæ°æ›¿æ›) | âœ… ç¬¦åˆ  | æ¥å£è¨­è¨ˆè‰¯å¥½                     |
| **ISP** (æ¥å£éš”é›¢) | âœ… ç¬¦åˆ  | ICharacter ç”±å¤šå€‹å°æ¥å£çµ„åˆ      |
| **DIP** (ä¾è³´åè½‰) | âœ… ç¬¦åˆ  | éƒ½ä¾è³´æŠ½è±¡è€Œéå¯¦ç¾               |
| **ADP** (ç„¡ç’°ä¾è³´) | âœ… ç¬¦åˆ  | ç„¡å¾ªç’°ä¾è³´                       |

---

## æ”¹é€²å»ºè­°ï¼ˆå¯é¸ï¼‰

### 1. æå‡ ICombatHook åˆ°å…±äº«å±¤ï¼ˆä½å„ªå…ˆç´šï¼‰

å¦‚æœä½ æƒ³è¦æ›´è§£è€¦ï¼Œå¯ä»¥å°‡ `ICombatHook` æå‡åˆ° `infra/shared/interfaces/`ï¼š

```
infra/shared/interfaces/
  â”œâ”€â”€â”€ entity.interface.ts (IEntity)
  â””â”€â”€â”€ combat.hook.interface.ts (ICombatHook)  <-- æ–°å¢

logic/damage/
  â””â”€â”€â”€ models/
       â”œâ”€â”€â”€ damage.event.model.ts
       â””â”€â”€â”€ (ç§»é™¤ combat.hook.interface.ts)
```

**å„ªé»**ï¼š

- damage å’Œ effect éƒ½ä¾è³´å…±äº«å±¤ï¼Œæ›´å°ç¨±
- æ›´ç¬¦åˆã€Œæ¥å£æ‡‰è©²åœ¨å…±äº«å±¤ã€çš„æ…£ä¾‹

**ç¼ºé»**ï¼š

- `ICombatHook` æœ¬è³ªä¸Šæ˜¯ damage é‚è¼¯çš„ä¸€éƒ¨åˆ†
- æå‡å¾Œå¯èƒ½è®“äººèª¤ä»¥ç‚ºå®ƒæ˜¯é€šç”¨æ¥å£

**å»ºè­°**ï¼šä¿æŒç¾ç‹€å³å¯ï¼Œé€™ä¸æ˜¯å•é¡Œ

---

### 2. æ‹†åˆ† CombatContextï¼ˆä¸­å„ªå…ˆç´šï¼‰

å¦‚æœä½ è¦ºå¾— CombatContext è·è²¬å¤ªå¤šï¼Œå¯ä»¥è€ƒæ…®æ‹†åˆ†ï¼š

```typescript
// æ–¹æ¡ˆ A: çµ„åˆæ¨¡å¼
export class CombatContext {
  public readonly services: CombatServices // EventBus, RNG
  public readonly state: CombatState // Tick, Entities
}

// æ–¹æ¡ˆ B: ä¾è³´æ³¨å…¥
export class CombatContext {
  constructor(
    public readonly eventBus: EventBus,
    public readonly rng: CombatRandomGenerator,
    public readonly entityManager: EntityManager,
    public readonly timeManager: TimeManager
  ) {}
}
```

**å»ºè­°**ï¼š

- ç•¶å‰è¦æ¨¡ä¸‹ä¸éœ€è¦æ‹†åˆ†
- ç­‰åˆ° CombatContext æ–¹æ³•è¶…é 15 å€‹æ™‚å†è€ƒæ…®

---

### 3. æ˜ç¢ºå±¤ç´šä¾è³´è¦å‰‡ï¼ˆé«˜å„ªå…ˆç´šï¼‰

åœ¨ä»£ç¢¼ä¸­æ˜ç¢ºæ¨™è¨»ä¾è³´æ–¹å‘ï¼š

```typescript
// infra/shared/README.md
/**
 * å…±äº«å±¤ï¼šæ‰€æœ‰æ¨¡çµ„éƒ½å¯ä»¥ä¾è³´
 * ä¾è³´ï¼šç„¡
 */

// context/README.md
/**
 * ä¸Šä¸‹æ–‡å±¤ï¼šæä¾›å…¨åŸŸè³‡æº
 * ä¾è³´ï¼šinfra, event-bus
 * è¢«ä¾è³´ï¼šdomain, logic, coordination, combat-engine
 */

// domain/README.md
/**
 * é ˜åŸŸå±¤ï¼šæ ¸å¿ƒå¯¦é«”èˆ‡æ•ˆæœ
 * ä¾è³´ï¼šinfra, context
 * è¢«ä¾è³´ï¼šlogic, coordination, combat-engine
 */

// logic/README.md
/**
 * é‚è¼¯å±¤ï¼šæ¥­å‹™é‚è¼¯è™•ç†
 * ä¾è³´ï¼šinfra, context, domain
 * è¢«ä¾è³´ï¼šcoordination, combat-engine
 */
```

---

## å¯¦éš›å¾ªç’°ä¾è³´æª¢æ¸¬çµæœ

ä½¿ç”¨ `madge` å·¥å…·æª¢æ¸¬å¾Œï¼Œç™¼ç¾ **ç¢ºå¯¦å­˜åœ¨å¾ªç’°ä¾è³´**ï¼

### ä¸»è¦å¾ªç’°ä¾è³´è·¯å¾‘ï¼š

#### 1. Character â†” Coordination å¾ªç’°ï¼ˆæœ€åš´é‡ï¼‰

```
domain/character/character.ts
  â†“ (imports)
coordination/index.ts (IUltimateAbility)
  â†“ (exports)
coordination/ability.system.ts
  â†“ (imports)
domain/character/index.ts (ICharacter)
  â†“ (exports)
domain/character/character.ts  â† å¾ªç’°ï¼
```

**å•é¡Œæ ¹æº**ï¼š

- `Character.ts` éœ€è¦ `IUltimateAbility` é¡å‹ï¼ˆä¾†è‡ª coordinationï¼‰
- `AbilitySystem.ts` éœ€è¦ `ICharacter` é¡å‹ï¼ˆä¾†è‡ª characterï¼‰
- é€é barrel export (`index.ts`) å½¢æˆå¾ªç’°

#### 2. Damage æ¨¡çµ„å…§éƒ¨å¾ªç’°

```
logic/damage/damage.chain.ts
  â†“
logic/damage/models/index.ts
  â†“
logic/damage/models/combat.hook.interface.ts
  â†“
logic/damage/index.ts
  â†“
logic/damage/damage.chain.ts  â† å¾ªç’°ï¼
```

**å•é¡Œæ ¹æº**ï¼š

- Barrel export (`index.ts`) å°è‡´çš„å¾ªç’°
- `damage.chain.ts` å’Œ `combat.hook.interface.ts` äº’ç›¸é€é index å¼•ç”¨

#### 3. Character â†” Effect é€é Coordination å½¢æˆé–“æ¥å¾ªç’°

```
domain/character/character.ts
  â†“
coordination/models/thunder.strike.ultimate.ts
  â†“
domain/effect/Implementation/ChargedCriticalEffect.ts
  â†“
domain/character/index.ts  â† å¾ªç’°ï¼
```

---

## å¾ªç’°ä¾è³´çš„çœŸç›¸

### ç‚ºä»€éº¼æˆ‘ä¹‹å‰èªªæ²’æœ‰å¾ªç’°ï¼Ÿ

æˆ‘åªæª¢æŸ¥äº† **æ¥å£ç´šåˆ¥çš„ä¾è³´**ï¼Œæ²’æœ‰è€ƒæ…®åˆ° **æ¨¡çµ„ç´šåˆ¥çš„ä¾è³´**ï¼ˆbarrel exportsï¼‰ã€‚

- âœ… **é¡å‹ä¾è³´å±¤é¢**ï¼šæ²’æœ‰å¾ªç’°ï¼ˆéƒ½æ˜¯æ¥å£ä¾è³´ï¼‰
- âŒ **æ¨¡çµ„ä¾è³´å±¤é¢**ï¼šæœ‰å¾ªç’°ï¼ˆé€é index.ts å½¢æˆï¼‰

### TypeScript çš„å¾ªç’°ä¾è³´å•é¡Œ

TypeScript çš„å¾ªç’°ä¾è³´ä¸æœƒç«‹å³å ±éŒ¯ï¼Œä½†æœƒå°è‡´ï¼š

1. **é‹è¡Œæ™‚ undefined éŒ¯èª¤**ï¼ˆåˆå§‹åŒ–é †åºå•é¡Œï¼‰
2. **æ¸¬è©¦å›°é›£**ï¼ˆmock å’Œ stub æ™‚å®¹æ˜“å‡ºå•é¡Œï¼‰
3. **æ‰“åŒ…å•é¡Œ**ï¼ˆæŸäº›æ‰“åŒ…å·¥å…·æœƒå ±éŒ¯æˆ–ç”¢ç”ŸéŒ¯èª¤çš„ chunkï¼‰
4. **ä»£ç¢¼ç†è§£å›°é›£**ï¼ˆä¾è³´é—œä¿‚ä¸æ¸…æ™°ï¼‰

---

## çµè«–ï¼ˆä¿®æ­£ç‰ˆï¼‰

### AI æª¢æ¸¬çš„å•é¡Œåˆ†æï¼š

1. **character â†” effect â†” damage å¾ªç’°**
   - âœ… **çœŸå¯¦å•é¡Œï¼**
   - é€é barrel exports å’Œ coordination å±¤å½¢æˆé–“æ¥å¾ªç’°
   - éœ€è¦é‡æ§‹

2. **ICombatHook åœ¨ damage ä½†è¢« effect å¯¦ä½œ**
   - âŒ **å‡è­°é¡Œ**
   - é€™æ˜¯ä¾è³´åè½‰åŸå‰‡çš„æ¨™æº–æ‡‰ç”¨
   - è¨­è¨ˆæ­£ç¢ºä¸”å„ªé›…

3. **CombatContext è·è²¬å¤š**
   - âš ï¸ **éƒ¨åˆ†æ­£ç¢º**
   - è·è²¬ç•¥å¤šï¼Œä½†ä½œç‚º Service Locator å¯æ¥å—
   - å¯é¸æ”¹é€²ï¼šç­‰è¦æ¨¡è®Šå¤§æ™‚å†æ‹†åˆ†

### ç¸½é«”è©•åƒ¹ï¼š

**âš ï¸ ä½ çš„ Combat æ¨¡çµ„æœ‰å¾ªç’°ä¾è³´å•é¡Œéœ€è¦è§£æ±ºï¼**

- âŒ **æœ‰å¾ªç’°ä¾è³´**ï¼ˆä¸»è¦æ˜¯ barrel export å°è‡´ï¼‰
- âœ… éµå¾ª SOLID åŸå‰‡ï¼ˆè¨­è¨ˆç†å¿µæ­£ç¢ºï¼‰
- âœ… åˆ†å±¤æ¸…æ™°ï¼ˆæ¦‚å¿µä¸Šæ­£ç¢ºï¼‰
- âš ï¸ å¯¦ç¾ç´°ç¯€éœ€è¦èª¿æ•´ï¼ˆindex.ts çš„ä½¿ç”¨æ–¹å¼ï¼‰

**å¥½æ¶ˆæ¯**ï¼šé€™äº›å¾ªç’°ä¾è³´éƒ½æ˜¯ **æ¨¡çµ„çµ„ç¹”å•é¡Œ**ï¼Œä¸æ˜¯ **è¨­è¨ˆç†å¿µå•é¡Œ**ã€‚åªéœ€è¦èª¿æ•´ import/export æ–¹å¼å³å¯è§£æ±ºã€‚

---

## é™„éŒ„ï¼šä¾è³´æª¢æŸ¥å·¥å…·

ä½ å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤æª¢æŸ¥å¾ªç’°ä¾è³´ï¼š

```bash
# å®‰è£ madge (ä¾è³´åˆ†æå·¥å…·)
pnpm add -D madge

# æª¢æŸ¥å¾ªç’°ä¾è³´
npx madge --circular --extensions ts,tsx src/modules/combat

# ç”Ÿæˆä¾è³´åœ–
npx madge --image combat-deps.svg src/modules/combat
```

å¦‚æœçœŸæœ‰å¾ªç’°ï¼Œmadge æœƒæ˜ç¢ºæŒ‡å‡ºã€‚

---

## è§£æ±ºæ–¹æ¡ˆ

### ç­–ç•¥ 1ï¼šä¿®æ­£ Barrel Exportï¼ˆæ¨è–¦ï¼Œä½é¢¨éšªï¼‰

**å•é¡Œæ ¹æº**ï¼šéåº¦ä½¿ç”¨ `index.ts` å°å‡ºæ‰€æœ‰å…§å®¹ï¼Œå½¢æˆå¾ªç’°ã€‚

**è§£æ±ºæ–¹æ³•**ï¼šåƒ…åœ¨ `index.ts` ä¸­å°å‡ºå…¬å…± APIï¼Œå…§éƒ¨æ¨¡çµ„ä¹‹é–“ç›´æ¥ importã€‚

#### ä¿®æ­£ç¯„ä¾‹ 1ï¼šdomain/character/index.ts

**ä¿®æ­£å‰**ï¼š

```typescript
// domain/character/index.ts
export * from './character'
export * from './interfaces'
export * from './models'
```

**ä¿®æ­£å¾Œ**ï¼š

```typescript
// domain/character/index.ts
// åªå°å‡ºå°å¤–å…¬å…± API
export { Character } from './character'
export type { ICharacter, CharacterId, CharacterSnapshot } from './interfaces'
export type { AttributeType, BaseAttributeValues } from './models'

// ä¸å°å‡ºå…§éƒ¨å¯¦ç¾ç´°ç¯€ï¼ˆAttributeContainer, AttributeCalculator ç­‰ï¼‰
```

#### ä¿®æ­£ç¯„ä¾‹ 2ï¼šcoordination/index.ts

**ä¿®æ­£å‰**ï¼š

```typescript
// coordination/index.ts
export * from './ability.system'
export * from './models'
export * from './factories'
```

**ä¿®æ­£å¾Œ**ï¼š

```typescript
// coordination/index.ts
export { AbilitySystem } from './ability.system'
export type { IUltimateAbility } from './models/ultimate.ability.interface'
// ä¸å°å‡ºæ‰€æœ‰ models å’Œ factories
```

#### ä¿®æ­£ç¯„ä¾‹ 3ï¼šlogic/damage/index.ts

**ä¿®æ­£å‰**ï¼š

```typescript
// logic/damage/index.ts
export * from './damage.chain'
export * from './models'
export * from './utils/damage.calculator.util'
```

**ä¿®æ­£å¾Œ**ï¼š

```typescript
// logic/damage/index.ts
export { DamageChain } from './damage.chain'
export type { DamageEvent, ICombatHook } from './models'
export { calculateFinalDamage } from './utils/damage.calculator.util'
```

**å„ªé»**ï¼š

- âœ… æœ€å°æ”¹å‹•
- âœ… ä¸æ”¹è®Šè¨­è¨ˆç†å¿µ
- âœ… å®¹æ˜“å¯¦æ–½
- âœ… é¢¨éšªä½

**ç¼ºé»**ï¼š

- âš ï¸ éœ€è¦æ‰‹å‹•ç¶­è­· export åˆ—è¡¨
- âš ï¸ å¯èƒ½éœ€è¦æ›´æ–°ç¾æœ‰ import èªå¥

---

### ç­–ç•¥ 2ï¼šæå‡å…±äº«æ¥å£åˆ°ç¨ç«‹å±¤ï¼ˆä¸­é¢¨éšªï¼‰

**å•é¡Œæ ¹æº**ï¼š`IUltimateAbility` åœ¨ coordinationï¼Œä½†è¢« character ä½¿ç”¨ï¼Œå½¢æˆå±¤ç´šå€’ç½®ã€‚

**è§£æ±ºæ–¹æ³•**ï¼šå°‡å…±äº«æ¥å£æå‡åˆ° `infra/shared/interfaces/`ã€‚

#### é‡æ§‹æ­¥é©Ÿï¼š

1. **å‰µå»ºå…±äº«æ¥å£å±¤**ï¼š

```
infra/shared/interfaces/
  â”œâ”€â”€â”€ entity.interface.ts (å·²å­˜åœ¨)
  â”œâ”€â”€â”€ combat.hook.interface.ts (å¾ damage ç§»å…¥)
  â””â”€â”€â”€ ultimate.ability.interface.ts (å¾ coordination ç§»å…¥)
```

2. **èª¿æ•´ import è·¯å¾‘**ï¼š

```typescript
// domain/character/character.ts (ä¿®æ­£å‰)
import type { IUltimateAbility } from '../../coordination'

// domain/character/character.ts (ä¿®æ­£å¾Œ)
import type { IUltimateAbility } from '@/modules/combat/infra/shared'
```

3. **æ›´æ–°ä¾è³´æ–¹å‘**ï¼š

```
infra/shared (interfaces)
    â†‘
    â”œâ”€â”€â”€ domain/character
    â”œâ”€â”€â”€ coordination
    â””â”€â”€â”€ logic/damage
```

**å„ªé»**ï¼š

- âœ… æ›´æ¸…æ™°çš„åˆ†å±¤
- âœ… æ¥å£é›†ä¸­ç®¡ç†
- âœ… ç¬¦åˆä¾è³´åè½‰åŸå‰‡

**ç¼ºé»**ï¼š

- âš ï¸ éœ€è¦å¤§é‡ä¿®æ”¹ import è·¯å¾‘
- âš ï¸ å¯èƒ½ç ´å£ç¾æœ‰ä»£ç¢¼

---

### ç­–ç•¥ 3ï¼šæ‹†åˆ† IUltimateAbility çš„ä¾è³´ï¼ˆé«˜é¢¨éšªï¼Œä¸æ¨è–¦ï¼‰

**å•é¡Œæ ¹æº**ï¼š`Character` æŒæœ‰ `IUltimateAbility` å¯¦ä¾‹ã€‚

**è§£æ±ºæ–¹æ³•**ï¼šè®“ `Character` åªæŒæœ‰ `ultimateId`ï¼Œé€šé `Context` æŸ¥è©¢å¯¦ä¾‹ã€‚

```typescript
// ä¿®æ­£å‰
export class Character {
  private ultimate?: IUltimateAbility
}

// ä¿®æ­£å¾Œ
export class Character {
  private ultimateId?: string

  getUltimate(context: CombatContext): IUltimateAbility | undefined {
    return context.getUltimate(this.ultimateId)
  }
}
```

**å„ªé»**ï¼š

- âœ… å¾¹åº•è§£è€¦

**ç¼ºé»**ï¼š

- âŒ éœ€è¦å¤§é‡é‡æ§‹
- âŒ å¢åŠ è¤‡é›œåº¦
- âŒ æ€§èƒ½æå¤±ï¼ˆæ¯æ¬¡æŸ¥è©¢ï¼‰
- âŒ ä¸ç¬¦åˆé ˜åŸŸé©…å‹•è¨­è¨ˆ

**ä¸æ¨è–¦ç†ç”±**ï¼šé€™æœƒè®“ä»£ç¢¼è®Šå¾—æ›´è¤‡é›œï¼Œå¾—ä¸å„Ÿå¤±ã€‚

---

## æ¨è–¦åŸ·è¡Œæ–¹æ¡ˆ

### ğŸ¯ åˆ†éšæ®µè§£æ±ºæ–¹æ¡ˆ

#### ç¬¬ä¸€éšæ®µï¼šå¿«é€Ÿä¿®å¾©ï¼ˆ1-2 å°æ™‚ï¼‰

**ç›®æ¨™**ï¼šæ‰“ç ´æ‰€æœ‰å¾ªç’°ä¾è³´

**æ­¥é©Ÿ**ï¼š

1. ä¿®æ­£æ‰€æœ‰ `index.ts`ï¼Œåªå°å‡ºå…¬å…± API
2. å…§éƒ¨æ¨¡çµ„æ”¹ç”¨ç›´æ¥è·¯å¾‘ import
3. é‹è¡Œ `npx madge --circular` ç¢ºèªç„¡å¾ªç’°

**ä¿®æ”¹æª”æ¡ˆ**ï¼š

- `domain/character/index.ts`
- `domain/effect/index.ts`
- `coordination/index.ts`
- `logic/damage/index.ts`

#### ç¬¬äºŒéšæ®µï¼šå„ªåŒ–åˆ†å±¤ï¼ˆå¯é¸ï¼Œ2-4 å°æ™‚ï¼‰

**ç›®æ¨™**ï¼šæå‡å…±äº«æ¥å£ï¼Œå„ªåŒ–ä¾è³´æ–¹å‘

**æ­¥é©Ÿ**ï¼š

1. ç§»å‹• `ICombatHook` åˆ° `infra/shared/interfaces/`
2. ç§»å‹• `IUltimateAbility` åˆ° `infra/shared/interfaces/`
3. æ›´æ–°æ‰€æœ‰ import è·¯å¾‘
4. æ·»åŠ  README èªªæ˜å„å±¤è·è²¬

#### ç¬¬ä¸‰éšæ®µï¼šæŒçºŒç›£æ§ï¼ˆé•·æœŸï¼‰

**ç›®æ¨™**ï¼šé˜²æ­¢å¾ªç’°ä¾è³´å†æ¬¡å‡ºç¾

**å·¥å…·è¨­ç½®**ï¼š

```json
// package.json
{
  "scripts": {
    "check:circular": "madge --circular --extensions ts,tsx src/modules/combat",
    "check:deps": "madge --image combat-deps.svg src/modules/combat"
  }
}
```

**Git Hook**ï¼ˆå¯é¸ï¼‰ï¼š

```bash
# .husky/pre-commit
pnpm check:circular || (echo "âŒ å¾ªç’°ä¾è³´æª¢æ¸¬å¤±æ•—ï¼" && exit 1)
```

---

## å…·é«”ä¿®æ”¹æŒ‡å—

### ä¿®æ”¹ 1ï¼šdomain/character/index.ts

```typescript
// ===== ä¿®æ­£å‰ =====
export * from './attribute.calculator'
export * from './attribute.container'
export * from './character'
export * from './character.templates'
export * from './interfaces'
export * from './models'

// ===== ä¿®æ­£å¾Œ =====
// å…¬å…± API
export { Character } from './character'
export { createWarrior, createMage } from './character.templates'

// å…¬å…±é¡å‹
export type {
  ICharacter,
  CharacterId,
  CharacterSnapshot,
  IAttributeProvider,
  IEffectOwner,
  IUltimateOwner,
} from './interfaces'

export type { AttributeType, AttributeModifier, BaseAttributeValues } from './models'

// å…§éƒ¨å¯¦ç¾ä¸å°å‡ºï¼ˆAttributeContainer, AttributeCalculator, EffectManagerï¼‰
```

### ä¿®æ”¹ 2ï¼šcoordination/index.ts

```typescript
// ===== ä¿®æ­£å‰ =====
export * from './ability.system'
export * from './factories'
export * from './models'
export * from './target-select-strategies'

// ===== ä¿®æ­£å¾Œ =====
// å…¬å…± API
export { AbilitySystem } from './ability.system'

// å…¬å…±é¡å‹
export type { IUltimateAbility } from './models/ultimate.ability.interface'
export type { ITargetSelector } from './target-select-strategies/target.selector.interface'

// å…¬å…±å¯¦ç¾
export { FirstAliveSelector, LowestHealthSelector } from './target-select-strategies'

// å…§éƒ¨å¯¦ç¾ä¸å°å‡ºï¼ˆDamageFactory, SimpleDamageUltimate ç­‰ï¼‰
```

### ä¿®æ”¹ 3ï¼šlogic/damage/index.ts

```typescript
// ===== ä¿®æ­£å‰ =====
export * from './damage.chain'
export * from './models'
export * from './utils/damage.calculator.util'

// ===== ä¿®æ­£å¾Œ =====
// å…¬å…± API
export { DamageChain } from './damage.chain'

// å…¬å…±é¡å‹
export type { DamageEvent, ICombatHook } from './models'

// å…¬å…±å·¥å…·
export { calculateFinalDamage } from './utils/damage.calculator.util'

// å…§éƒ¨å¯¦ç¾ä¸å°å‡ºï¼ˆå„ç¨® Step, hookCollector ç­‰ï¼‰
```

### ä¿®æ”¹ 4ï¼šdomain/effect/index.ts

```typescript
// ===== ä¿®æ­£å‰ =====
export * from './effect.manager'
export * from './models'
export * from './Implementation'

// ===== ä¿®æ­£å¾Œ =====
// å…¬å…± API
export { EffectManager } from './effect.manager'

// å…¬å…±é¡å‹
export type { IEffect } from './models/effect.model'
export type { StackableEffect } from './models/stackable.effect.model'

// å…¬å…±æ•ˆæœå¯¦ç¾
export {
  PoisonEffect,
  ChillEffect,
  ChargeEffect,
  HolyFireEffect,
  ChargedCriticalEffect,
  LowHealthArmorEffect,
} from './Implementation'
```

### ä¿®æ”¹ 5ï¼šå…§éƒ¨ import æ”¹ç”¨ç›´æ¥è·¯å¾‘

```typescript
// ===== ä¿®æ­£å‰ =====
// coordination/ability.system.ts
import type { ICharacter } from '../domain/character' // é€é index.ts

// ===== ä¿®æ­£å¾Œ =====
// coordination/ability.system.ts
import type { ICharacter } from '../domain/character/interfaces/character.interface' // ç›´æ¥è·¯å¾‘

// ===== æˆ–è€…ä¿æŒåŸæ¨£ï¼ˆå› ç‚º index.ts å·²ç¶“ä¿®æ­£ï¼‰=====
// coordination/ability.system.ts
import type { ICharacter } from '../domain/character' // OKï¼Œå› ç‚º index åªå°å‡º type
```

---

## ä¿®æ”¹å¾Œé©—è­‰

### 1. é‹è¡Œå¾ªç’°ä¾è³´æª¢æ¸¬

```bash
npx madge --circular --extensions ts,tsx src/modules/combat
# æ‡‰è©²é¡¯ç¤ºï¼šâœ“ No circular dependencies found!
```

### 2. é‹è¡Œæ¸¬è©¦

```bash
pnpm test
# ç¢ºä¿æ‰€æœ‰æ¸¬è©¦é€šé
```

### 3. ç·¨è­¯æª¢æŸ¥

```bash
pnpm build
# ç¢ºä¿ç·¨è­¯æˆåŠŸ
```

### 4. ç”Ÿæˆä¾è³´åœ–ï¼ˆå¯é¸ï¼‰

```bash
npx madge --image combat-deps.svg src/modules/combat
# æŸ¥çœ‹ combat-deps.svgï¼Œç¢ºèªä¾è³´æ–¹å‘æ¸…æ™°
```

---

## é•·æœŸç¶­è­·å»ºè­°

### 1. æ·»åŠ æ¶æ§‹æ±ºç­–è¨˜éŒ„ï¼ˆADRï¼‰

å‰µå»º `dev_log/ADR/001-no-barrel-exports.md`ï¼š

```markdown
# ADR 001: é™åˆ¶ Barrel Export ä½¿ç”¨

## ç‹€æ…‹

æ¥å—

## èƒŒæ™¯

éåº¦ä½¿ç”¨ `export *` å°è‡´å¾ªç’°ä¾è³´

## æ±ºç­–

- `index.ts` åƒ…å°å‡ºå…¬å…± API
- å…§éƒ¨æ¨¡çµ„ä½¿ç”¨ç›´æ¥è·¯å¾‘ import
- æ¥å£å„ªå…ˆæ–¼å¯¦ç¾

## å¾Œæœ

- éœ€æ‰‹å‹•ç¶­è­· export åˆ—è¡¨
- æ›´æ¸…æ™°çš„å…¬å…± API
- é¿å…å¾ªç’°ä¾è³´
```

### 2. ä»£ç¢¼å¯©æŸ¥æª¢æŸ¥æ¸…å–®

- [ ] æ–°å¢ `index.ts` export æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦çœŸçš„éœ€è¦å…¬é–‹
- [ ] æ·»åŠ æ–°æ¨¡çµ„æ™‚ï¼Œé‹è¡Œ `pnpm check:circular`
- [ ] è·¨å±¤ç´š import æ™‚ï¼Œæ€è€ƒæ˜¯å¦æ‡‰è©²æå‡æ¥å£åˆ° shared

### 3. ä¾è³´è¦å‰‡æ–‡æª”

æ›´æ–° `dev_log/v0.2/combat_æ¶æ§‹ä»‹ç´¹.md`ï¼Œæ·»åŠ ï¼š

```markdown
## ä¾è³´è¦å‰‡

### å…è¨±çš„ä¾è³´æ–¹å‘
```

combat-engine â†’ coordination â†’ logic â†’ domain â†’ context â†’ infra
â†‘ â†‘
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

```
