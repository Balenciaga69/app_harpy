# 遊戲設計與架構畫板（ItemGenerator 相關業務需求討論）

## 業務需求總結

基於用戶提供的構想，聚焦於物品系統的設計與生成邏輯。核心是強化 RogueLite 的賭博與刺激元素，讓玩家在進程中感受到裝備升級的「賭注感」。

### Affix 系統設計

- **分類**：三大類（攻擊、防禦、機制），直接映射 AttributeType。
  - 攻擊：attackDamage、criticalChance、criticalMultiplier、accuracy。
  - 防禦：maxHp、armor、evasion。
  - 機制：energyRegen、energyGainOnAttack、resurrectionChance、resurrectionHpPercent。
- **規則**：詞綴 Roll 受裝備槽位限制。
  - 武器：100% 不 Roll 防禦屬性（保持攻擊專精）。
  - 頭盔/盔甲：不 Roll 攻擊屬性（專注防禦）。
  - 其他槽位（項鍊、鞋子等）：皆可 Roll（靈活性高）。

### 職業與物品池

- **職業**：從「戰士」開始（最基礎模板）。
- **裝備池**：由職業 + 槽位決定篩選邏輯。戰士適合武器、頭盔、盔甲等重裝槽位。
- **進程設計**：
  - 1-10 層：以 common/magic 為主，強調「賭博風險」（低層隨機性高，玩家需抉擇）。
  - 10+ 層：轉向 rare/legendary，強化「刺激回報」（高層裝備強力，但生成概率低）。
- **Relic**：非隨機生成，玩家「量身打造」（e.g., 透過事件或成就解鎖）。不依賴 ItemGenerator。

### 具體物品範例

- **傳說頭盔：宙斯頭**（戰士專屬）。
  - 基礎：Charge Buff 狀態下 +4% 攻擊速度 +20 armor。
  - 設計意圖：強化戰士的持續戰鬥能力，Charge 作為異常狀態的互動點。
- **Relic：泰坦之心**（戰士專屬）。
  - 效果：每 10 HP +2 護甲（可疊加）。
  - 設計意圖：鼓勵玩家維持高血量，與復活機制互補，形成「肉盾」玩法。

### 稀有度與生成邏輯

- **Legendary**：固定模板，非隨機（e.g., 宙斯頭是預定義物品）。
- **Rare**：隨機生成，詞綴數量多、強度高。
- **Common/Magic**：低層常見，詞綴少、強度低。

---

## 遊戲設計師觀點：如何滿足業務需求

從遊戲體驗出發，確保物品系統強化「賭博與緊張」主題，讓玩家每件裝備都像一場賭局。

### 平衡與進程設計

- **進程分層**：1-10 層的 common/magic 裝備讓玩家早期「試水」，培養抉擇習慣。10+ 層的 rare/legendary 提供高風險高回報，維持緊張感。避免早期過強裝備破壞難度。
- **詞綴規則**：槽位限制防止「萬能裝備」（e.g., 武器專攻攻擊，頭盔專攻防禦），鼓勵玩家組裝多樣化裝備。三大類分類確保詞綴邏輯清晰，玩家易懂。
- **Relic 設計**：非隨機讓 relic 成為「成就獎勵」，而非純運氣。泰坦之心與 HP 綁定，鼓勵防禦玩法；宙斯頭與 Charge 互動，強化異常狀態的深度。
- **賭博元素**：隨機詞綴讓每件裝備有「驚喜」，但規則限制避免過度混亂。玩家需權衡「Roll 還是賣出」。

### 潛在挑戰與解決

- **平衡測試**：詞綴強度需迭代（e.g., 測試戰士在不同層數的生存率）。建議原型階段模擬戰鬥，調整數值。
- **玩家回饋**：裝備描述需清晰（e.g., 標註詞綴類型），避免混亂。
- **擴展性**：新職業可複用規則（e.g., 法師專攻機制詞綴）。

---

## 軟體架構師觀點：如何滿足業務需求

從代碼組織出發，確保模組化、低耦合，支援未來擴展（如新職業、新詞綴）。

### 模組分工與依賴

- **Domain 層**：負責定義（職業、裝備、詞綴）。Affix 分類可在 affix-definition.ts 中添加標籤（e.g., category: 'attack' | 'defense' | 'mechanic'）。
- **Logic 層**：ItemGenerator 負責生成邏輯。依賴 domain，但不修改定義。Relic 生成可由專屬模組處理（非 ItemGenerator）。
- **依賴方向**：單向（logic → domain），無循環。ItemGenerator 作為 Facade，封裝複雜性。

### 架構設計

- **Affix 系統**：擴充 AffixDefinition 介面，添加 category 與 slotRestrictions（e.g., weapon: exclude 'defense'）。AffixRoller 根據規則過濾可用詞綴。
- **職業裝備池**：在職業定義中添加 equipmentPoolIds（陣列），ItemGenerator 根據職業 + 槽位篩選。支援動態擴充。
- **生成流程**：
  1. 輸入：難度、職業、種子。
  2. 篩選池子（職業 + 槽位）。
  3. 計算稀有度權重（難度公式）。
  4. 選取定義 + Roll 詞綴（依規則過濾）。
  5. 輸出實例。
- **Legendary 處理**：固定物品不經 ItemGenerator，直接從註冊表取用。Rare 走隨機流程。
- **Relic 處理**：獨立模組（e.g., RelicManager），玩家解鎖後注入。

### 擴展性與維護

- **新職業**：只需添加定義 + 池子，ItemGenerator 自動支援。
- **新詞綴**：註冊到 domain，AffixRoller 自動處理。
- **測試**：單元測試生成邏輯，確保規則正確（e.g., 武器不 Roll 防禦）。
- **潛在挑戰**：詞綴規則複雜化時，AffixRoller 可能需重構為策略模式。Relic 非隨機避免 ItemGenerator 膨脹。

### 開發優先順序

1. 補充 domain：定義戰士、裝備池、詞綴分類。
2. 實作 ItemGenerator MVP（支援規則過濾）。
3. 添加範例物品（宙斯頭、泰坦之心）。
4. 測試平衡與整合。

---

## 總結與下一步

這個設計平衡了遊戲樂趣與技術簡潔：詞綴規則強化專精，進程分層維持刺激，架構保持模組化。Relic 作為非隨機元素，區別於裝備的賭博性。

## 同意嗎？有調整嗎？我們可以繼續討論或開始實作 domain 補充。

下一步:
我相信初期這些設計平衡性一定不是很完美，我們可以先實作出來
三大類（攻擊、防禦、機制）似乎乎是個不錯的開始，但我們也要考慮到有些 affix 可能未來 會複合型態出現 (e.g., 既有攻擊又有防禦)，這部分我們可以先用標籤(tag)的方式來處理，未來再看情況調整。然後傳說裝備的affix都是固定，他們除了這些tag 還需要一個 傳說 tag/category 來標示這是傳說裝備的專屬affix

以及真正的架構 你會怎麼想 物件之間的關係與適合的設計模式

---

## 更新補充（V2）

### Affix 系統補充

- **三大類分類**：維持作為基礎，但支援複合（e.g., 一個 affix 可屬於多類）。用 `tags: string[]` 陣列處理，允許動態組合（如 ['attack', 'defense']）。未來若複合常見，可調整為多選枚舉。
- **Legendary Tag**：傳說裝備 affix 固定，並額外添加 'legendary' tag。區別於普通 affix，確保專屬性（e.g., 宙斯頭的 Charge 互動屬性）。

### 物件關係與設計模式（架構師觀點）

從物件導向設計出發，確保低耦合、高內聚，支援擴展。核心是 domain 定義 + logic 生成的單向依賴。

#### 物件關係圖（簡述）

- **AffixDefinition**（domain/item）：核心定義，含 `attributeType`（映射 AttributeType）、`min/max`（數值範圍）、`weight`（權重）、`tags: string[]`（分類標籤，如 ['attack', 'legendary']）。
- **EquipmentDefinition**（domain/item）：含 `slot`（EquipmentSlot）、`rarity`（EquipmentRarity）、`affixPoolIds: string[]`（可用詞綴池 ID）。
- **ClassDefinition**（domain/character）：含 `equipmentPoolIds: string[]`（職業允許裝備 ID）。
- **ItemGenerator**（logic）：Facade，依賴上述定義 + DifficultyScaler。內部使用 AffixRoller（domain）進行擲骰。
- **IEquipmentInstance**（domain/item）：生成輸出，含 `definitionId`、`rarity`、`affixes: IAffixInstance[]`。

關係：定義物件靜態（註冊表管理），生成物件動態（ItemGenerator 組裝）。無循環依賴，domain 純資料，logic 純邏輯。

#### 適合的設計模式

- **策略模式（Strategy）**：用於詞綴過濾。定義 `IAffixFilter` 介面（e.g., `filter(affixes, slot)`），實作 `SlotBasedFilter`（根據槽位排除類別，如武器排除 'defense' tag）。ItemGenerator 可注入不同策略，支援未來擴展（e.g., 職業專屬過濾）。
- **工廠模式（Factory）**：ItemGenerator 作為抽象工廠，根據輸入（難度、職業）生產具體實例。內部使用 `AffixRoller`（domain）作為具體工廠生成詞綴。
- **註冊表模式（Registry）**：domain 層使用註冊表管理定義（e.g., `AffixDefinitionRegistry`），支援動態註冊新 affix/裝備。避免硬編碼，易於測試與擴充。
- **組合模式（Composite）**：若 affix 未來支援巢狀效果（e.g., 一個 affix 觸發子效果），可用組合模式組織。但初期簡單，暫不採用。
- **享元模式（Flyweight）**：共享 affix 定義實例，減少記憶體使用（e.g., 多個裝備共用相同 affix 定義）。

這些模式確保架構靈活：新 affix 只需添加定義 + tag，ItemGenerator 自動適應。平衡測試時，可 mock 策略與註冊表。

### 開發優先順序更新

1. 補充 domain：添加 tags 到 AffixDefinition，定義戰士 + 裝備池 + 詞綴範例（含 legendary）。
2. 實作 ItemGenerator MVP（整合策略模式過濾）。
3. 添加範例物品（宙斯頭、泰坦之心）。
4. 測試平衡（模擬生成，調整數值）。

同意補充嗎？有進一步調整？我們可以開始實作 domain。

下一步:
我相信初期這些設計平衡性一定不是很完美，我們可以先實作出來
三大類（攻擊、防禦、機制）似乎乎是個不錯的開始，但我們也要考慮到有些 affix 可能未來 會複合型態出現 (e.g., 既有攻擊又有防禦)，這部分我們可以先用標籤(tag)的方式來處理，未來再看情況調整。然後傳說裝備的affix都是固定，他們除了這些tag 還需要一個 傳說 tag/category 來標示這是傳說裝備的專屬affix

以及真正的架構 你會怎麼想 物件之間的關係與適合的設計模式
