# Replay 模組規格說明

## 簡介

Replay 模組負責處理戰鬥重播功能，包括載入戰鬥結果數據、控制播放進度、事件發佈和狀態管理。模組採用事件驅動架構，支持多種播放速度和循環播放。最後更新時間：2025/12/09。

## 輸入與輸出

### 輸入

- 戰鬥結果數據（CombatResult，包含日誌、快照和統計）
- 重播配置參數（播放速度、循環設定、tick 間隔等）
- 用戶控制命令（播放、暫停、停止、跳轉）

### 輸出

- 重播事件流（載入完成、播放狀態變化、tick 更新等）
- 當前播放狀態（位置、速度、是否播放中）
- 快照數據（用於 UI 渲染角色狀態）

## 元件盤點

### 核心引擎元件

- ReplayEngine：核心重播引擎，提供載入數據、播放控制和事件訂閱 API。整合數據適配器、狀態機和調度器。
- PlaybackStateMachine：管理播放狀態轉換，包括載入、播放、暫停和停止狀態。處理速度調整和位置跳轉。
- ReplayDataAdapter：適配戰鬥結果數據，提取事件日誌和快照序列。提供 tick 總數和數據查詢接口。

### 基礎設施元件

- BrowserTickScheduler：基於瀏覽器 requestAnimationFrame 的 tick 調度器。處理實時播放調度。
- TestTickScheduler：用於測試的 tick 調度器。支持手動觸發和同步執行。
- ReplayEventBus：重播專用事件總線。處理載入、播放和 tick 事件發佈。

### 模型元件

- ReplayConfig：定義重播配置，包括播放速度、循環設定和 tick 間隔。
- ReplayState：表示當前重播狀態，包括位置、速度和播放模式。
- ReplayEvent：定義重播事件類型和載荷，支持狀態變化通知。
- ReplayError：重播相關錯誤類別，處理載入失敗和播放異常。

## 模組依賴誰?或被誰依賴?

### 依賴的模組

- logic/combat：戰鬥結果數據和快照，提供重播的原始數據
- logic/shared：共享工具，如事件總線介面

### 被依賴的模組

- UI 層：使用重播引擎進行戰鬥重播顯示，訂閱事件更新界面
- 測試模組：使用 TestTickScheduler 進行單元測試和集成測試
