# 我的見解

## 我的想法

- 砍掉重做系統不少部分(combat_depr已被拋棄，但仍保留以供參考，現在系統在combat開始重新開發)
- 我有套件: zustand(UI狀態管理), mitt, seedRandom, nanoid,React(最終做好呈現) 等等

## 如何組成一場戰鬥

- 有一位玩家與 1~n 敵人
- 玩家與敵人都是「角色」（Character）
- 角色都有屬性(例如:HP,Armor,Evasion,裝備/聖物,武器/魔法書等)
- 武器會帶有詞綴(命中、暴擊、傷害、特殊效果等)
- 裝備會帶有詞綴(防禦、生命、特殊效果等)
- 戰鬥是預先計算完的，按照 Tick 一次次執行
- 玩家戰鬥時其實就是在 Replay 一個預先計算好的戰鬥過程
- 事件驅動架構(Event-driven Architecture)
  - 戰鬥過程中會有各種事件發生(攻擊、受到傷害、施放技能、狀態變更等)
  - 這些事件會觸發相應的效果(Effect)來改變角色的屬性或戰鬥流程
  - 好比 HeartStone, Yu-Gi-Oh, Path of Exile 等遊戲的連鎖反應機制

## 戰鬥是靠著甚麼元件組成的

- 基礎層 這是整個戰鬥引擎的最小依賴和運行環境。
  - Ticker: 負責管理戰鬥的 Tick 流程，定時觸發 Tick 事件
  - EventEmitter(mitt): 負責事件的發布與訂閱，讓各個模組
  - Event Logger: 負責記錄戰鬥過程中的事件，生成戰鬥日誌
- 數據層 (依賴基礎層): 管理所有靜態與動態數據，並將其與業務邏輯分離。
  - CombatContext: 戰鬥的上下文環境，是一個貧血模型，作為數據的根容器。持有 EventBus、Ticker 以及所有 Character 的引用。提供給各個 System 查詢數據使用。
  - Character 抽象，代表戰鬥中的玩家或敵人或生物。(ECS的 Entity)
  - AttributeContainer: 管理角色的屬性，如生命值、護甲值、閃避值等。(ECS的 Component)
  - EffectManager: 儲存角色的所有動態效果實例 (ECS的 Component與 策略模式的結合)
- 核心邏輯層(依賴數據層)
  - Effect 策略實體: 所有具體效果的實作
  - AttributeCalculator: 計算角色屬性的邏輯
  - AbilitySystem: 處理主攻擊/法術的冷卻時間、施放判定、目標鎖定。
  - TickerSystem: 統一處理所有基於 Tick 的效果。在每個 Tick，它向所有 ITickAction 實例發送 Tick 信號。
- 戰鬥流程層(依賴數據層、核心邏輯層)
  - CombatEngine: 負責整體戰鬥流程的管理與協調。接收配置，初始化所有 Character 和 System，並啟動 Ticker 進行戰鬥預計算。輸出最終的 Logger 記錄。
  - DamageChain: 定義傷害計算的完整流程。它是一個責任鏈，依序執行所有 ICombatHook（來自 EffectManager）來修改傷害事件。
  - EventProcessor: 負責處理戰鬥中的各種事件。當事件發生時，它會通知 EffectManager，讓所有相關的 Effect 有機會響應事件並修改戰鬥流程。
    > 我希望 新增一個獨特裝備時，只需新增一個實作 ICombatHook 的 Effect 類，並將其掛載到 EffectManager，無需修改任何現有的 DamageChain 或 AttributeCalculator 邏輯，徹底遵循 OCP。

## 我期望的檔案夾結構

- 領域優先例如 角色／效果／戰鬥流等等
- 內層若必須再劃分才依照 models/utils 再細分

## 什麼是「效果」（Effect）？

- 「效果」可以被廣義地定義為：所有對玩家或敵方屬性、行動或戰鬥流程產生改變或修飾的機制。
- 如火傷疊加的「聖火」、電傷疊加的「充能」、冰傷疊加的「冷凍」以及「毒」（DoT）。
- 臨時或永久的屬性修飾：如「致盲」（降低命中值）、「破甲」（暫時減少護甲值）、「褻瀆」（永久降低最大生命值）。
- 獨特裝備提供的功能性變異：例如「閃避值轉換為護甲」、「免疫上個受到的傷害類型」、「施放冰緩後同時冰緩自身」等。

## 效果能做什麼？

- 屬性修飾：增加或減少攻擊力、防禦力、命中值、閃避值等。
- 戰鬥流程中斷/修飾 在特定戰鬥事件（如造成傷害前、受到傷害後、施法、Tick 運算）發生時，插入邏輯進行干預。
- 依賴遊戲 Tick 進行持續性扣血、回血或層數衰減。
- 複合狀態與規則變更 實現獨特裝備帶來的複雜邏輯，如「所有物理傷害都能治療 X%」、「冰傷害無視敵方護甲」。

## 核心設計模式

- 策略模式（Strategy Pattern）與責任鏈（Chain of Responsibility）
- 策略模式：每個具體的 Buff/Debuff 或 Unique 效果都是一個獨立的 Strategy。
- 責任鏈：用於處理複雜的多步驟效果鏈和傷害計算流程。解決「缺乏複雜條件觸發的 Hook 點」和「傷害計算流程不支援插入修改器」的問題
